---
layout: apps
title: TL to POJ Real-time Converter - Simple
version: v0.1b
permalink: /pages/tl_poj_converter_simple.html
updated: 2026-01-18
note:
---
<!DOCTYPE html>
<!--
  Copyright (c) 2026 Cyber O͘-hîm ki-tē
  Licensed under the MIT License
  Simplified Version: Single Input In-Place Converter, 
  Majorly used for converting ASR results from 
  教育部臺灣台語輸入法 to POJ. 
-->
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TL->POJ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --text-link: #58a6ff;
            --border-color: #30363d;
            --font-taigi: 'Huninn', 'Times New Roman', serif;
            --spacing-md: 2rem;
            --spacing-sm: 1rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
            /* overflow: hidden;  <-- Relaxed this */
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-sans);
            line-height: 1.6;
            height: 100%;
            /* Keep full height */
            /* overflow: hidden; <-- Relaxed this, let it flow if needed, but container is constrained */
            display: flex;
            flex-direction: column;
            margin: 0;
            /* align-items: center; <-- Removed to prevent left clipping on small screens */
        }

        .container {
            width: 100%;
            max-width: 800px;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            margin: 0 auto;
            /* Safe centering */
            /* Restore padding here */
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
        }

        h1 {
            font-size: 1.2rem;
            color: var(--text-link);
            margin: 0;
            white-space: nowrap;
        }

        .toolbar-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 36px;
        }

        .btn:hover {
            border-color: var(--text-link);
            color: var(--text-link);
        }

        textarea {
            flex: 1;
            /* Take remaining space */
            padding: var(--spacing-sm);
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            resize: none;
            font-family: var(--font-taigi);
            font-size: 1.4rem;
            line-height: 1.6;
            outline: none;
            width: 100%;
            color: var(--text-primary);
            box-sizing: border-box;
            min-height: 0;
            /* Crucial for flex child scroll */
            overflow-y: auto;
            padding-bottom: 50vh;
            /* Allow scrolling past end for typewriter effect */
        }

        textarea:focus {
            border-color: var(--text-link);
            box-shadow: 0 0 0 1px var(--text-link);
        }

        textarea::placeholder {
            color: var(--text-secondary);
            opacity: 0.6;
            font-size: 1.0rem;
        }

        .footer {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin: 0;
            flex-shrink: 0;
            /* Never shrink the footer */
        }

        .footer span {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        /* Toggle Switch Styles */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .switch-input {
            display: none;
        }

        .switch-label {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .switch-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            border-radius: 14px;
            transition: all 0.3s ease;
        }

        .switch-slider::before {
            content: "";
            position: absolute;
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .switch-input:checked+.switch-label .switch-slider {
            background-color: var(--text-link);
        }

        .switch-input:checked+.switch-label .switch-slider::before {
            transform: translateX(14px);
        }

        /* Settings Panel */
        .settings-panel {
            display: none;
            flex: 1;
            flex-direction: column;
            gap: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .settings-panel.active {
            display: flex;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .main-panel {
            display: flex;
            flex-direction: column;
            flex: 1;
            gap: var(--spacing-sm);
            height: 100%;
            min-height: 0;
            /* Important for flex nested scrolling */
        }

        .main-panel.hidden {
            display: none;
        }

        /* View Toggle */
        .view-toggle-container {
            display: flex;
            align-items: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 2px;
            margin-right: auto;
            /* Push to left if in toolbar group, or manage layout */
        }

        .view-toggle-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-toggle-btn.active {
            background: var(--text-link);
            color: var(--bg-primary);
            font-weight: bold;
        }

        /* Mobile Adjustments */
        @media (max-width: 480px) {
            .container {
                padding: 0.5rem;
            }

            /* .header-row {
                 flex-wrap: wrap; 
            } */

            h1 {
                font-size: 1rem;
            }

            .toolbar-group {
                gap: 0.25rem;
            }

            .btn {
                padding: 6px 8px;
                /* More compact */
                min-width: 32px;
            }

            /* Make text buttons smaller too */
            .view-toggle-btn {
                padding: 4px 8px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <div class="header-row">
            <h1 id="ui-title"></h1>
            <div class="toolbar-group">
                <div class="view-toggle-container">
                    <button id="btn-view-converted" class="view-toggle-btn active"></button>
                    <button id="btn-view-original" class="view-toggle-btn"></button>
                </div>
                <button class="btn" id="btn-download"></button>
                <button class="btn" id="btn-copy"></button>
                <button class="btn" id="btn-clear"></button>
                <button class="btn" id="btn-settings"></button>
            </div>
        </div>

        <!-- Main Panel -->
        <div id="main-panel" class="main-panel">
            <textarea id="input-area" placeholder=""></textarea>
            <div class="footer" id="ui-footer"></div>
        </div>

        <!-- Settings Panel -->
        <div id="settings-panel" class="settings-panel">
            <h3 id="ui-lbl-settings-title" style="margin-bottom: 0.5rem; color: var(--text-link);"></h3>

            <div class="setting-item">
                <span id="ui-lbl-nasal-toggle"></span>
                <div class="switch-container">
                    <input type="checkbox" id="nasal-superscript-toggle" class="switch-input" checked>
                    <label for="nasal-superscript-toggle" class="switch-label">
                        <span class="switch-slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <span id="ui-lbl-tone6-toggle"></span>
                <div class="switch-container">
                    <input type="checkbox" id="tone6-toggle" class="switch-input">
                    <label for="tone6-toggle" class="switch-label">
                        <span class="switch-slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <span id="ui-lbl-allcaps-toggle"></span>
                <div class="switch-container">
                    <input type="checkbox" id="all-caps-toggle" class="switch-input" checked>
                    <label for="all-caps-toggle" class="switch-label">
                        <span class="switch-slider"></span>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <span id="ui-lbl-scroll-lines" title="設定拍字時，頂懸欲留幾逝 context (建議 3-6 逝)"></span>
                <div class="switch-container" style="justify-content: flex-end;">
                    <input type="number" id="scroll-lines-input" min="1" max="15" value="6" class="input-number"
                        style="width: 50px; padding: 5px; border-radius: 4px; border: 1px solid var(--border-color); text-align: center; background: var(--bg-secondary); color: var(--text-primary);">
                </div>
            </div>

            <div class="setting-item" style="border-bottom: none; margin-top: 0.5rem;">
                <div style="display: flex; flex-direction: column; gap: 0.5rem; width: 100%;">
                    <div style="display: flex; gap: 0.5rem; width: 100%;">
                        <button id="ui-btn-run-test" class="btn"
                            style="flex: 1; justify-content: center; background-color: var(--text-accent); color: white;"></button>
                        <button id="ui-btn-reset-settings" class="btn"
                            style="flex: 1; justify-content: center; background-color: var(--border-color);"></button>
                    </div>
                    <button class="btn" id="ui-btn-download-offline" onclick="downloadCleanVersion()"
                        style="width: 100%; display: inline-flex; border-style: dashed; justify-content: center; height: auto; font-size: 0.8rem; gap: 8px; margin-top: 0.5rem;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        <span id="ui-btn-download-offline-text"></span>
                    </button>
                </div>
            </div>

            <h3 id="ui-lbl-help-title" style="margin-top: 1rem; color: var(--text-link);"></h3>
            <div id="help-content-area" style="font-size: 0.9rem; line-height: 1.5; color: var(--text-primary);">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

    <script>
        // --- Font Loading ---
        const taigiCharsToLoad = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZáàâāa̍éèêēe̍íìîīi̍óòôōo̍úùûūu̍ÁÀÂĀA̍ÉÈÊĒE̍ÍÌÎĪI̍ÓÒÔŌO̍ÚÙÛŪU̍o͘ó͘ò͘ô͘ō͘o̍͘O͘Ó͘Ò͘Ô͘Ō͘O̍͘aⁿeⁿiⁿoⁿuⁿo͘ⁿAⁿEⁿIⁿOⁿUⁿO̍͘ⁿáⁿàⁿâⁿāⁿa̍ⁿéⁿèⁿêⁿēe̍ⁿíⁿìⁿîⁿīi̍ⁿóⁿòⁿôⁿō͘ⁿo̍͘ⁿúⁿùⁿûⁿūⁿu̍ⁿó͘ⁿò͘ⁿô͘ⁿō͘ⁿo̍͘ⁿÁⁿÀⁿÂⁿĀⁿA̍ⁿÉⁿÈÊⁿĒⁿE̍ⁿÍÌÎĪI̍ⁿÓÒÔŌⁿO̍ⁿÚⁿÙⁿÛⁿŪⁿU̍ⁿÓ͘ⁿÒ͘ⁿÔ͘ⁿŌ͘ⁿO̍͘ⁿăĕĭŏŭŏ͘ĂĔĬŎŬŎ͘ḿm̀m̂m̄m̍m̆ḾM̀M̂M̄M̍M̆ńǹn̂n̄n̍n̆ŃǸN̂N̄N̍N̆-0123456789.,;:?!'\"()[]{}<>@#$%^&*_+=\\|/";
        (function loadHuninnFont() {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = `https://fonts.googleapis.com/css2?family=Huninn&display=swap&text=${encodeURIComponent(taigiCharsToLoad)}`;
            document.head.appendChild(link);
        })();

        // --- Configuration ---
        let SCROLL_LOCK_LINES = 6; // Default n=6


        // --- UI Constants ---
        const UI_STRINGS = {
            title: "TL→POJ",
            config: {
                downloadFilename: "tl_poj_converter_simple_output.txt"
            },
            buttons: {
                copy: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`,
                clear: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`,
                settings: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 40" width="54" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><g transform="translate(14, 8)"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></g><line x1="55" y1="32" x2="65" y2="8" stroke-width="2.5" /><g transform="translate(68, 8)"><circle cx="12" cy="12" r="10" /><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" /><path d="M12 17h.01" /></g></svg>`,
                download: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`,
                copied: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
                back: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>`,
                downloadOffline: "⬇ Táng-ló͘ App 家己電腦用"
            },
            tooltips: {
                copy: "kho͘--起來 (Copy)",
                clear: "總清 (Clear)",
                settings: "設定 (Settings)",
                download: "Táng-ló͘ 結果 (Download)",
                runTest: "看見本/快速測 (Run Test)",
                reset: "恢復初設 (Reset)"
            },
            views: {
                converted: "轉",
                original: "原文",
                originalPlaceholder: "原文模式 (無轉) [Original Text]"
            },
            settings: {
                title: "設定 (Settings)",
                nasal: '尾N→鼻化音"ⁿ"',
                tone6: "第6調 (ǎ)",
                allcaps: "大寫模式 (ALL CAPS)",
                scrollLines: "自動捲 beh 留幾逝 (Auto-scroll Lines)"
            },
            placeholder: "隨輸入隨轉... (Type here...)\n( e.g. Oo1-oo1 → O͘-o͘\n        Tsai-iánn → Chai-iáⁿ,\n        han1-chi5 → han-chî )",
            footer: "<span>TL → POJ 現轉<br>© 2026 Cyber O͘-hîm Ki-tē. MIT License.</span>",
            helpTitle: "解說 (Help)",
            helpContent: `
                <p><strong>輸入 (Input):</strong></p>
                <ul style="padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 1rem;">
                    <li>TL / POJ 數字調: <code>Tai5-uan5</code> / <code>Tai5-oan5</code></li>
                    <li>TL 符號調: <code>Tâi-uân</code></li>
                    <li>特殊拍法: "oo" → o͘, "nn" → ⁿ</li>
                </ul>
                <p><strong>功能 (Features):</strong></p>
                <ul style="padding-left: 1.5rem; margin-top: 0.5rem;">
                    <li><strong>隨輸入隨轉</strong>: 拍字隨會轉做 POJ。</li>
                    <li><strong>原文/轉</strong>: 會使切欲看「原文」a̍h-sī「轉」結果。</li>
                    <li><strong>設定</strong>: 調整 "ⁿ" (nn)、第6調 (ǎ/á)、大寫模式 kap 自動捲留幾逝。</li>
                    <li><strong>Táng-ló͘</strong>: 轉好 ê 結果會使 táng-ló͘（download）做 .txt 檔。</li>
                </ul>
                <p style="margin-top: 1rem;"><strong>注意 (Note):</strong></p>
                <p style="margin-top: 0.5rem;">若無愛轉，請用 <code>\\[ \\]</code> 包--起來 (例: <code>\\[Google\\] tō 袂變做 Go͘gle</code>)。</p>`,
            messages: {
                downloadConfirm: "Kám 有確定 beh táng-ló͘ tī 家己電腦用？",
                downloading: "Tng teh táng-ló͘ ...",
                downloadFailed: "Táng-ló͘ 失敗。koh 試看覓。"
            }
        };

        function initUI() {
            document.getElementById('ui-title').innerText = UI_STRINGS.title;

            document.getElementById('btn-view-converted').innerText = UI_STRINGS.views.converted;
            document.getElementById('btn-view-original').innerText = UI_STRINGS.views.original;

            document.getElementById('btn-download').innerHTML = UI_STRINGS.buttons.download;
            document.getElementById('btn-download').title = UI_STRINGS.tooltips.download;

            document.getElementById('btn-copy').innerHTML = UI_STRINGS.buttons.copy;
            document.getElementById('btn-copy').title = UI_STRINGS.tooltips.copy;

            document.getElementById('btn-clear').innerHTML = UI_STRINGS.buttons.clear;
            document.getElementById('btn-clear').title = UI_STRINGS.tooltips.clear;

            document.getElementById('btn-settings').innerHTML = UI_STRINGS.buttons.settings;
            document.getElementById('btn-settings').title = UI_STRINGS.tooltips.settings;

            document.getElementById('input-area').placeholder = UI_STRINGS.placeholder;
            document.getElementById('ui-footer').innerHTML = UI_STRINGS.footer;

            document.getElementById('ui-lbl-settings-title').innerText = UI_STRINGS.settings.title;
            document.getElementById('ui-lbl-nasal-toggle').innerText = UI_STRINGS.settings.nasal;
            document.getElementById('ui-lbl-tone6-toggle').innerText = UI_STRINGS.settings.tone6;
            document.getElementById('ui-lbl-allcaps-toggle').innerText = UI_STRINGS.settings.allcaps;
            document.getElementById('ui-lbl-scroll-lines').innerText = UI_STRINGS.settings.scrollLines;

            document.getElementById('ui-btn-run-test').innerText = UI_STRINGS.tooltips.runTest;
            document.getElementById('ui-btn-reset-settings').innerText = UI_STRINGS.tooltips.reset;

            document.getElementById('ui-lbl-help-title').innerText = UI_STRINGS.helpTitle;
            document.getElementById('help-content-area').innerHTML = UI_STRINGS.helpContent;

            const btnDownloadOffline = document.getElementById('ui-btn-download-offline-text');
            if (btnDownloadOffline) {
                btnDownloadOffline.innerText = UI_STRINGS.buttons.downloadOffline;
            }

            loadSettings();
            updateSettings();
        }
        document.addEventListener('DOMContentLoaded', initUI);

        // --- Settings (Fixed as requested) ---
        window.TL_USE_NASAL_SUPERSCRIPT = false;
        window.TL_TONE6_USE_CARON = false;
        window.TL_ALL_CAPS_SUPPORT = false;

        // --- Logic extracted from tl_poj_converter.html ---
        const TL_bue = '((?:rm|rng|rn|r|m|ng|n|nnh|nn|ⁿ|N)?)';

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function createRC(char) {
            return new RegExp(char + '([aAeEgGhHiIkKmMnNoOpPtTuU]*)', 'g');
        }
        function createRC1(tailo) {
            const prefix = tailo.slice(0, -1);
            const lastChar = tailo.slice(-1);
            return new RegExp(prefix + TL_bue + lastChar, 'g');
        }
        function createRC2(tailo) {
            return new RegExp(tailo[0] + '(u|i)((?:N|ⁿ|nn)?)' + tailo[1], 'g');
        }
        function createRC3_Regex(pattern) {
            return new RegExp(pattern, 'g');
        }
        function createRC4(tailo) {
            const prefix = tailo.slice(0, -1);
            const lastChar = tailo.slice(-1);
            return new RegExp(prefix + '(h(?:N|ⁿ|nn)?|H(?:N|ⁿ|nn)?|p|P|t|T|k|K)' + lastChar + '?', 'g');
        }
        function createRC8(tailo) {
            const prefix = tailo.slice(0, -1);
            const lastChar = tailo.slice(-1);
            return new RegExp(prefix + '(h(?:N|ⁿ|nn)?|H(?:N|ⁿ|nn)?|p|P|t|T|k|K)' + lastChar, 'g');
        }

        function TLtiau_2_TLsoo(tl_tiau, nasal = 'nn', use14 = false) {
            let tl_soo = tl_tiau;
            if (!tl_soo) return '';

            const TL_T2S = [
                { r: createRC('á'), s: 'a$12' }, { r: createRC('Á'), s: 'A$12' },
                { r: createRC('à'), s: 'a$13' }, { r: createRC('À'), s: 'A$13' },
                { r: createRC('â'), s: 'a$15' }, { r: createRC('Â'), s: 'A$15' },
                { r: createRC('ǎ'), s: 'a$16' }, { r: createRC('Ǎ'), s: 'A$16' },
                { r: createRC('ā'), s: 'a$17' }, { r: createRC('Ā'), s: 'A$17' },
                { r: createRC('a̍'), s: 'a$18' }, { r: createRC('A̍'), s: 'A$18' },
                { r: createRC('a̋'), s: 'a$19' }, { r: createRC('A̋'), s: 'A$19' },
                { r: createRC('é'), s: 'e$12' }, { r: createRC('É'), s: 'E$12' },
                { r: createRC('è'), s: 'e$13' }, { r: createRC('È'), s: 'E$13' },
                { r: createRC('ê'), s: 'e$15' }, { r: createRC('Ê'), s: 'E$15' },
                { r: createRC('ě'), s: 'e$16' }, { r: createRC('Ě'), s: 'E$16' },
                { r: createRC('ē'), s: 'e$17' }, { r: createRC('Ē'), s: 'E$17' },
                { r: createRC('e̍'), s: 'e$18' }, { r: createRC('E̍'), s: 'E$18' },
                { r: createRC('e̋'), s: 'e$19' }, { r: createRC('E̋'), s: 'E$19' },
                { r: createRC('í'), s: 'i$12' }, { r: createRC('Í'), s: 'I$12' },
                { r: createRC('ì'), s: 'i$13' }, { r: createRC('Ì'), s: 'I$13' },
                { r: createRC('î'), s: 'i$15' }, { r: createRC('Î'), s: 'I$15' },
                { r: createRC('ǐ'), s: 'i$16' }, { r: createRC('Ǐ'), s: 'I$16' },
                { r: createRC('ī'), s: 'i$17' }, { r: createRC('Ī'), s: 'I$17' },
                { r: createRC('i̍'), s: 'i$18' }, { r: createRC('I̍'), s: 'I$18' },
                { r: createRC('i̋'), s: 'i$19' }, { r: createRC('I̋'), s: 'I$19' },
                { r: createRC('ó͘'), s: 'oo$12' }, { r: createRC('Ó͘'), s: 'Oo$12' },
                { r: createRC('ò͘'), s: 'oo$13' }, { r: createRC('Ò͘'), s: 'Oo$13' },
                { r: createRC('ô͘'), s: 'oo$15' }, { r: createRC('Ô͘'), s: 'Oo$15' },
                { r: createRC('ǒ͘'), s: 'oo$16' }, { r: createRC('Ǒ͘'), s: 'Oo$16' },
                { r: createRC('ō͘'), s: 'oo$17' }, { r: createRC('Ō͘'), s: 'Oo$17' },
                { r: createRC('o̍͘'), s: 'oo$18' }, { r: createRC('O̍͘'), s: 'Oo$18' },
                { r: createRC('ő͘'), s: 'oo$19' }, { r: createRC('Ő͘'), s: 'Oo$19' },
                { r: createRC('ó'), s: 'o$12' }, { r: createRC('Ó'), s: 'O$12' },
                { r: createRC('ò'), s: 'o$13' }, { r: createRC('Ò'), s: 'O$13' },
                { r: createRC('ô'), s: 'o$15' }, { r: createRC('Ô'), s: 'O$15' },
                { r: createRC('ǒ'), s: 'o$16' }, { r: createRC('Ǒ'), s: 'O$16' },
                { r: createRC('ō'), s: 'o$17' }, { r: createRC('Ō'), s: 'O$17' },
                { r: createRC('o̍'), s: 'o$18' }, { r: createRC('O̍'), s: 'O$18' },
                { r: createRC('ő'), s: 'o$19' }, { r: createRC('Ő'), s: 'O$19' },
                { r: createRC('ú'), s: 'u$12' }, { r: createRC('Ú'), s: 'U$12' },
                { r: createRC('ù'), s: 'u$13' }, { r: createRC('Ù'), s: 'U$13' },
                { r: createRC('û'), s: 'u$15' }, { r: createRC('Û'), s: 'U$15' },
                { r: createRC('ǔ'), s: 'u$16' }, { r: createRC('Ǔ'), s: 'U$16' },
                { r: createRC('ū'), s: 'u$17' }, { r: createRC('Ū'), s: 'U$17' },
                { r: createRC('u̍'), s: 'u$18' }, { r: createRC('U̍'), s: 'U$18' },
                { r: createRC('ű'), s: 'u$19' }, { r: createRC('Ű'), s: 'U$19' },
                { r: createRC('ḿ'), s: 'm$12' }, { r: createRC('Ḿ'), s: 'M$12' },
                { r: createRC('m̀'), s: 'm$13' }, { r: createRC('M̀'), s: 'M$13' },
                { r: createRC('m̂'), s: 'm$15' }, { r: createRC('M̂'), s: 'M$15' },
                { r: createRC('m̌'), s: 'm$16' }, { r: createRC('M̌'), s: 'M$16' },
                { r: createRC('m̄'), s: 'm$17' }, { r: createRC('M̄'), s: 'M$17' },
                { r: createRC('m̍'), s: 'm$18' }, { r: createRC('M̍'), s: 'M$18' },
                { r: createRC('m̋'), s: 'm$19' }, { r: createRC('M̋'), s: 'M$19' },
                { r: createRC('ń'), s: 'n$12' }, { r: createRC('Ń'), s: 'N$12' },
                { r: createRC('ǹ'), s: 'n$13' }, { r: createRC('Ǹ'), s: 'N$13' },
                { r: createRC('n̂'), s: 'n$15' }, { r: createRC('N̂'), s: 'N$15' },
                { r: createRC('ň'), s: 'n$16' }, { r: createRC('N̋'), s: 'N$16' },
                { r: createRC('n̄'), s: 'n$17' }, { r: createRC('N̄'), s: 'N$17' },
                { r: createRC('n̍'), s: 'n$18' }, { r: createRC('N̍'), s: 'N$18' },
                { r: createRC('n̋'), s: 'n$19' }, { r: createRC('N̋'), s: 'N$19' }
            ];

            for (const map of TL_T2S) {
                tl_soo = tl_soo.replace(map.r, map.s);
            }

            tl_soo = tl_soo.replace(/o͘/g, 'oo');
            tl_soo = tl_soo.replace(/O͘/g, 'Oo');
            tl_soo = tl_soo.replace(/ⁿ/g, 'nn');

            if (nasal === 'N') {
                tl_soo = tl_soo.replace(/(?<=[aeiouAEIOU])nn/g, 'N');
            }

            if (use14) {
                const add1 = /(a|A|e|E|i|I|o|O|u|U|m|M|ng|Ng|n)\b/g;
                const add4 = /(h|H|p|P|t|T|k|K)\b/g;
                tl_soo = tl_soo.replace(add1, '$11');
                tl_soo = tl_soo.replace(add4, '$14');
            }
            return tl_soo;
        }

        function TLsoo_2_POJsoo(tailo_soo, keep14 = false) {
            if (!tailo_soo) return '';
            let poj_soo = tailo_soo;

            if (!keep14) {
                const remove1 = /([aeiouAEIOU](?:nn|N)?|[aeiouAEIOU](?:ng|n|m)|(?:p|P|ph|Ph|m|M|b|B|t|T|th|Th|n|N|l|L|k|K|kh|Kh|ng|Ng|g|G|s|S|h|H)?(?:ng|Ng|m|M))1/g;
                poj_soo = poj_soo.replace(remove1, '$1');
                const remove4 = /([aeiouAEIOU](?:(?:nn|N)?(?:h|H)|p|P|t|T|k|K)|(?:m|M|ng|Ng)(?:h|H))4/g;
                poj_soo = poj_soo.replace(remove4, '$1');
            }

            const tailo2poj = [
                ['oonn', 'o͘nn'], ['Oonn', 'O͘nn'],
                /* ['onn', 'o͘N'], ['Onn', 'O͘N'], <-- REMOVED: onn should be oⁿ, not o͘N */
                ['ts', 'ch'], ['Ts', 'Ch'], ['oo', 'o͘'], ['Oo', 'O͘'],
                ['ua', 'oa'], ['Ua', 'Oa'], ['ue', 'oe'], ['Ue', 'Oe'],
                ['ing', 'eng'], ['Ing', 'Eng'], ['ik', 'ek'], ['Ik', 'Ek'],
                // Fix: nnh -> hnn must happen BEFORE tones are processed so that hnn + tone works
                ['nnh', 'hnn']
            ];

            if (window.TL_ALL_CAPS_SUPPORT) {
                tailo2poj.push(
                    ['OONN', 'O͘NN'], ['ONN', 'O͘NN'], /* Changed to O͘NN to become O͘ⁿ later */
                    ['TS', 'CH'], ['OO', 'O͘'],
                    ['UA', 'OA'], ['UE', 'OE'],
                    ['ING', 'ENG'], ['IK', 'EK'],
                    ['NNH', 'HNN']
                );
            }

            for (const [k, v] of tailo2poj) {
                poj_soo = poj_soo.replace(new RegExp(k, 'g'), v);
            }
            return poj_soo;
        }

        function POJsoo_2_POJtiau(poj_soo) {
            if (!poj_soo) return '';
            let poj_tiau = poj_soo;
            if (window.TL_USE_NASAL_SUPERSCRIPT) {
                const N_to_superscript = /([aeiouAEIOUmM]h?|[aeiouAEIOU])N(\d?)\b/g;
                poj_tiau = poj_tiau.replace(N_to_superscript, '$1ⁿ$2');
                const Nh_to_superscript = /([aeiouAEIOUmM])Nh?(\d?)\b/g;
                poj_tiau = poj_tiau.replace(Nh_to_superscript, '$1hⁿ$2');
            }

            const useTone6Caron = window.TL_TONE6_USE_CARON;
            const t6 = useTone6Caron
                ? { a: 'ǎ', A: 'Ǎ', e: 'ě', E: 'Ě', i: 'ǐ', I: 'Ǐ', o: 'ǒ', O: 'Ǒ', u: 'ǔ', U: 'Ú', 'o͘': 'ǒ͘', 'O͘': 'Ǒ͘', m: 'm̌', M: 'M̌', n: 'ň', N: 'Ň' }
                : { a: 'á', A: 'Á', e: 'é', E: 'É', i: 'í', I: 'Í', o: 'ó', O: 'Ó', u: 'ú', U: 'Ú', 'o͘': 'ó͘', 'O͘': 'Ó͘', m: 'ḿ', M: 'Ḿ', n: 'ń', N: 'Ń' };

            const POJ_S2T = [
                { r: createRC2('a1'), s: 'a$1$2' }, { r: createRC2('A1'), s: 'A$1$2' },
                { r: createRC2('a2'), s: 'á$1$2' }, { r: createRC2('A2'), s: 'Á$1$2' },
                { r: createRC2('a3'), s: 'à$1$2' }, { r: createRC2('A3'), s: 'À$1$2' },
                { r: createRC3_Regex('a(i|u)((?:N|ⁿ|nn)?)h4'), s: 'a$1$2h' },
                { r: createRC3_Regex('A(i|u)((?:N|ⁿ|nn)?)h4'), s: 'A$1$2h' },
                { r: createRC2('a5'), s: 'â$1$2' }, { r: createRC2('A5'), s: 'Â$1$2' },
                { r: createRC2('a6'), s: t6.a + '$1$2' }, { r: createRC2('A6'), s: t6.A + '$1$2' },
                { r: createRC2('a7'), s: 'ā$1$2' }, { r: createRC2('A7'), s: 'Ā$1$2' },
                { r: createRC3_Regex('a(i|u)h(?:N|ⁿ|nn)8'), s: 'a̍$1hⁿ' },
                { r: createRC3_Regex('A(i|u)h(?:N|ⁿ|nn)8'), s: 'A̍$1hⁿ' },
                { r: createRC3_Regex('a(i|u)h8'), s: 'a̍$1h' },
                { r: createRC3_Regex('A(i|u)h8'), s: 'A̍$1h' },
                { r: createRC2('a9'), s: 'ă$1$2' }, { r: createRC2('A9'), s: 'Ă$1$2' },

                { r: createRC2('u1'), s: 'u$1$2' }, { r: createRC2('U1'), s: 'U$1$2' },
                { r: createRC2('u2'), s: 'ú$1$2' }, { r: createRC2('U2'), s: 'Ú$1$2' },
                { r: createRC2('u3'), s: 'ù$1$2' }, { r: createRC2('U3'), s: 'Ù$1$2' },
                { r: createRC3_Regex('uih((?:N|ⁿ|nn)?)4'), s: 'uih$1' },
                { r: createRC3_Regex('Uih((?:N|ⁿ|nn)?)4'), s: 'Uih$1' },
                { r: createRC2('u5'), s: 'û$1$2' }, { r: createRC2('U5'), s: 'Û$1$2' },
                { r: createRC2('u6'), s: t6.u + '$1$2' }, { r: createRC2('U6'), s: t6.U + '$1$2' },
                { r: createRC2('u7'), s: 'ū$1$2' }, { r: createRC2('U7'), s: 'Ū$1$2' },
                { r: createRC3_Regex('uih((?:N|ⁿ|nn)?)8'), s: 'u̍ih$1' },
                { r: createRC3_Regex('Uih((?:N|ⁿ|nn)?)8'), s: 'U̍ih$1' },
                { r: createRC2('u9'), s: 'ŭ$1$2' }, { r: createRC2('U9'), s: 'Ŭ$1$2' },

                { r: createRC3_Regex('(o|O)([ae])((?:N|ⁿ|nn)?)1?\\b'), s: '$1$2$3' },
                { r: createRC3_Regex('o([ae])((?:N|ⁿ|nn)?)2\\b'), s: 'ó$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|ⁿ|nn)?)2\\b'), s: 'Ó$1$2' },
                { r: createRC3_Regex('o([ae])((?:N|ⁿ|nn)?)3\\b'), s: 'ò$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|ⁿ|nn)?)3\\b'), s: 'Ò$1$2' },
                { r: createRC3_Regex('o([ae])((?:N|ⁿ|nn)?)5\\b'), s: 'ô$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|ⁿ|nn)?)5\\b'), s: 'Ô$1$2' },
                { r: createRC3_Regex('o([ae])((?:N|ⁿ|nn)?)6\\b'), s: t6.o + '$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|ⁿ|nn)?)6\\b'), s: t6.O + '$1$2' },
                { r: createRC3_Regex('o([ae])((?:N|ⁿ|nn)?)7\\b'), s: 'ō$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|ⁿ|nn)?)7\\b'), s: 'Ō$1$2' },
                { r: createRC3_Regex('o([ae])((?:N|ⁿ|nn)?)9\\b'), s: 'ŏ$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|ⁿ|nn)?)9\\b'), s: 'Ŏ$1$2' },

                { r: createRC1('a1'), s: 'a$1' }, { r: createRC1('A1'), s: 'A$1' },
                { r: createRC1('a2'), s: 'á$1' }, { r: createRC1('A2'), s: 'Á$1' },
                { r: createRC1('a3'), s: 'à$1' }, { r: createRC1('A3'), s: 'À$1' },
                { r: createRC4('a4'), s: 'a$1' }, { r: createRC4('A4'), s: 'A$1' },
                { r: createRC1('a5'), s: 'â$1' }, { r: createRC1('A5'), s: 'Â$1' },
                { r: createRC1('a6'), s: t6.a + '$1' }, { r: createRC1('A6'), s: t6.A + '$1' },
                { r: createRC1('a7'), s: 'ā$1' }, { r: createRC1('A7'), s: 'Ā$1' },
                { r: createRC8('a8'), s: 'a̍$1' }, { r: createRC8('A8'), s: 'A̍$1' },
                { r: createRC1('a9'), s: 'ă$1' }, { r: createRC1('A9'), s: 'Ă$1' },

                { r: createRC1('e1'), s: 'e$1' }, { r: createRC1('E1'), s: 'E$1' },
                { r: createRC1('e2'), s: 'é$1' }, { r: createRC1('E2'), s: 'É$1' },
                { r: createRC1('e3'), s: 'è$1' }, { r: createRC1('E3'), s: 'È$1' },
                { r: createRC4('e4'), s: 'e$1' }, { r: createRC4('E4'), s: 'E$1' },
                { r: createRC1('e5'), s: 'ê$1' }, { r: createRC1('E5'), s: 'Ê$1' },
                { r: createRC1('e6'), s: t6.e + '$1' }, { r: createRC1('E6'), s: t6.E + '$1' },
                { r: createRC1('e7'), s: 'ē$1' }, { r: createRC1('E7'), s: 'Ē$1' },
                { r: createRC8('e8'), s: 'e̍$1' }, { r: createRC8('E8'), s: 'E̍$1' },
                { r: createRC1('e9'), s: 'ĕ$1' }, { r: createRC1('E9'), s: 'Ĕ$1' },

                { r: createRC1('i1'), s: 'i$1' }, { r: createRC1('I1'), s: 'I$1' },
                { r: createRC1('i2'), s: 'í$1' }, { r: createRC1('I2'), s: 'Í$1' },
                { r: createRC1('i3'), s: 'ì$1' }, { r: createRC1('I3'), s: 'Ì$1' },
                { r: createRC4('i4'), s: 'i$1' }, { r: createRC4('I4'), s: 'I$1' },
                { r: createRC1('i5'), s: 'î$1' }, { r: createRC1('I5'), s: 'Î$1' },
                { r: createRC1('i6'), s: t6.i + '$1' }, { r: createRC1('I6'), s: t6.I + '$1' },
                { r: createRC1('i7'), s: 'ī$1' }, { r: createRC1('I7'), s: 'Ī$1' },
                { r: createRC8('i8'), s: 'i̍$1' }, { r: createRC8('I8'), s: 'I̍$1' },
                { r: createRC1('i9'), s: 'ĭ$1' }, { r: createRC1('I9'), s: 'Ĭ$1' },

                { r: createRC1('o͘1'), s: 'o͘$1' }, { r: createRC1('O͘1'), s: 'O͘$1' },
                { r: createRC1('o͘2'), s: 'ó͘$1' }, { r: createRC1('O͘2'), s: 'Ó͘$1' },
                { r: createRC1('o͘3'), s: 'ò͘$1' }, { r: createRC1('O͘3'), s: 'Ò͘$1' },
                { r: createRC4('o͘4'), s: 'o͘$1' }, { r: createRC4('O͘4'), s: 'O͘$1' },
                { r: createRC1('o͘5'), s: 'ô͘$1' }, { r: createRC1('O͘5'), s: 'Ô͘$1' },
                { r: createRC1('o͘6'), s: t6['o͘'] + '$1' }, { r: createRC1('O͘6'), s: t6['O͘'] + '$1' },
                { r: createRC1('o͘7'), s: 'ō͘$1' }, { r: createRC1('O͘7'), s: 'Ō͘$1' },
                { r: createRC8('o͘8'), s: 'o̍͘$1' }, { r: createRC8('O͘8'), s: 'O̍͘$1' },
                { r: createRC1('o͘9'), s: 'ŏ͘$1' }, { r: createRC1('O͘9'), s: 'Ŏ͘$1' },

                { r: createRC1('o1'), s: 'o$1' }, { r: createRC1('O1'), s: 'O$1' },
                { r: createRC1('o2'), s: 'ó$1' }, { r: createRC1('O2'), s: 'Ó$1' },
                { r: createRC1('o3'), s: 'ò$1' }, { r: createRC1('O3'), s: 'Ò$1' },
                { r: createRC4('o4'), s: 'o$1' }, { r: createRC4('O4'), s: 'O$1' },
                { r: createRC1('o5'), s: 'ô$1' }, { r: createRC1('O5'), s: 'Ô$1' },
                { r: createRC1('o6'), s: t6.o + '$1' }, { r: createRC1('O6'), s: t6.O + '$1' },
                { r: createRC1('o7'), s: 'ō$1' }, { r: createRC1('O7'), s: 'Ō$1' },
                { r: createRC8('o8'), s: 'o̍$1' }, { r: createRC8('O8'), s: 'O̍$1' },
                { r: createRC1('o9'), s: 'ŏ$1' }, { r: createRC1('O9'), s: 'Ŏ$1' },

                { r: createRC1('u1'), s: 'u$1' }, { r: createRC1('U1'), s: 'U$1' },
                { r: createRC1('u2'), s: 'ú$1' }, { r: createRC1('U2'), s: 'Ú$1' },
                { r: createRC1('u3'), s: 'ù$1' }, { r: createRC1('U3'), s: 'Ù$1' },
                { r: createRC4('u4'), s: 'u$1' }, { r: createRC4('U4'), s: 'U$1' },
                { r: createRC1('u5'), s: 'û$1' }, { r: createRC1('U5'), s: 'Û$1' },
                { r: createRC1('u6'), s: t6.u + '$1' }, { r: createRC1('U6'), s: t6.U + '$1' },
                { r: createRC1('u7'), s: 'ū$1' }, { r: createRC1('U7'), s: 'Ū$1' },
                { r: createRC8('u8'), s: 'u̍$1' }, { r: createRC8('U8'), s: 'U̍$1' },
                { r: createRC1('u9'), s: 'ŭ$1' }, { r: createRC1('U9'), s: 'Ŭ$1' },

                { r: createRC3_Regex('m1'), s: 'm' }, { r: createRC3_Regex('M1'), s: 'M' },
                { r: createRC3_Regex('m2'), s: 'ḿ' }, { r: createRC3_Regex('M2'), s: 'Ḿ' },
                { r: createRC3_Regex('m3'), s: 'm̀' }, { r: createRC3_Regex('M3'), s: 'M̀' },
                { r: createRC3_Regex('mh4'), s: 'mh' }, { r: createRC3_Regex('Mh4'), s: 'Mh' },
                { r: createRC3_Regex('m5'), s: 'm̂' }, { r: createRC3_Regex('M5'), s: 'M̂' },
                { r: createRC3_Regex('m6'), s: t6.m }, { r: createRC3_Regex('M6'), s: t6.M },
                { r: createRC3_Regex('m7'), s: 'm̄' }, { r: createRC3_Regex('M7'), s: 'M̄' },
                { r: createRC3_Regex('mh8'), s: 'm̍h' }, { r: createRC3_Regex('Mh8'), s: 'M̍h' },
                { r: createRC3_Regex('m9'), s: 'm̆' }, { r: createRC3_Regex('M9'), s: 'M̆' },

                { r: createRC3_Regex('ng1'), s: 'ng' }, { r: createRC3_Regex('Ng1'), s: 'Ng' },
                { r: createRC3_Regex('ng2'), s: 'ńg' }, { r: createRC3_Regex('Ng2'), s: 'Ńg' },
                { r: createRC3_Regex('ng3'), s: 'ǹg' }, { r: createRC3_Regex('Ng3'), s: 'Ǹg' },
                { r: createRC3_Regex('ngh4'), s: 'ngh' }, { r: createRC3_Regex('Ngh4'), s: 'Ngh' },
                { r: createRC3_Regex('ng5'), s: 'n̂g' }, { r: createRC3_Regex('Ng5'), s: 'N̂g' },
                { r: createRC3_Regex('ng6'), s: t6.n + 'g' }, { r: createRC3_Regex('Ng6'), s: t6.N + 'g' },
                { r: createRC3_Regex('ng7'), s: 'n̄g' }, { r: createRC3_Regex('Ng7'), s: 'N̄g' },
                { r: createRC3_Regex('ngh8'), s: 'n̍gh' }, { r: createRC3_Regex('Ngh8'), s: 'N̍gh' },
                { r: createRC3_Regex('ng9'), s: 'n̆g' }, { r: createRC3_Regex('Ng9'), s: 'N̆g' }
            ];

            if (window.TL_ALL_CAPS_SUPPORT) {
                POJ_S2T.push(
                    { r: createRC3_Regex('NG1'), s: 'NG' },
                    { r: createRC3_Regex('NG2'), s: t6.N + 'G' },
                    { r: createRC3_Regex('NG3'), s: 'ǸG' },
                    { r: createRC3_Regex('NGH4'), s: 'NGH' },
                    { r: createRC3_Regex('NG5'), s: 'N̂G' },
                    { r: createRC3_Regex('NG6'), s: t6.N + 'G' },
                    { r: createRC3_Regex('NG7'), s: 'N̄G' },
                    { r: createRC3_Regex('NGH8'), s: 'N̍GH' },
                    { r: createRC3_Regex('NG9'), s: 'N̆G' }
                );
            }

            for (const map of POJ_S2T) {
                poj_tiau = poj_tiau.replace(map.r, map.s);
            }

            // Late Conversion for nn -> ⁿ (supescript)
            // Perform this AFTER tone conversion so that "nn" can be matched by tone mappings (via TL_bue)
            const vowelChars = "aeiouAEIOU" +
                "áàâāa̍ăÁÀÂĀA̍Ă" +
                "éèêēe̍ĕÉÈÊĒE̍Ĕ" +
                "íìîīi̍ĭÍÌÎĪI̍Ĭ" +
                "óòôōo̍ŏÓÒÔŌO̍Ŏ" +
                "úùûūu̍ŭÚÙÛŪU̍Ŭ" +
                "ḿm̀m̂m̄m̍m̆ḾM̀M̂M̄M̍M̆" +
                "ńǹn̂n̄n̍n̆ŃǸN̂N̄N̍N̆";
            // Fix: Include combining dot \u0358 for o͘ handling
            // Allow optional combining dot \u0358 after vowel match
            const nn_to_superscript = new RegExp(`([${vowelChars}]\\u0358?h?)nn\\b`, 'g');
            poj_tiau = poj_tiau.replace(nn_to_superscript, '$1ⁿ');

            return poj_tiau;
        }

        function TLtiau_2_POJtiau(tl_tiau) {
            // 0. Handle escape sequences: \[text\] is preserved as-is (supports multi-line)
            const escapes = [];
            let processedInput = '';
            let i = 0;
            while (i < tl_tiau.length) {
                if (tl_tiau[i] === '\\' && tl_tiau[i + 1] === '[') {
                    // Found escape start \[
                    let start = i + 2;
                    let end = tl_tiau.indexOf('\\]', start);
                    if (end === -1) {
                        // No closing \] → escape everything to end of string
                        escapes.push(tl_tiau.slice(start));
                        processedInput += `⟪ESC${escapes.length - 1}⟫`;
                        break;
                    }
                    // Found closing \]
                    escapes.push(tl_tiau.slice(start, end));
                    processedInput += `⟪ESC${escapes.length - 1}⟫`;
                    i = end + 2; // Skip past \]
                } else {
                    processedInput += tl_tiau[i];
                    i++;
                }
            }

            const pojPlaceholders = [];
            const pojNasalEndPattern = /[\p{L}\p{M}]+ⁿ/gu;
            const pojOoPattern = /[\p{L}\p{M}]*[oO]͘[\p{L}\p{M}]*/gu;

            processedInput = processedInput.replace(pojNasalEndPattern, (match) => {
                pojPlaceholders.push(match);
                return `⟪POJ${pojPlaceholders.length - 1}⟫`;
            });
            processedInput = processedInput.replace(pojOoPattern, (match) => {
                if (match.includes('⟪POJ')) return match;
                pojPlaceholders.push(match);
                return `⟪POJ${pojPlaceholders.length - 1}⟫`;
            });

            const tl_soo = TLtiau_2_TLsoo(processedInput);
            const poj_soo = TLsoo_2_POJsoo(tl_soo);
            let poj_tiau = POJsoo_2_POJtiau(poj_soo);

            // Restore escaped content
            poj_tiau = poj_tiau.replace(/⟪ESC(\d+)⟫/g, (match, index) => {
                return escapes[parseInt(index)];
            });

            // Restore POJ content
            poj_tiau = poj_tiau.replace(/⟪POJ(\d+)⟫/g, (match, index) => {
                return pojPlaceholders[parseInt(index)];
            });

            return poj_tiau;
        }

        // --- Interaction Logic ---
        const inputArea = document.getElementById('input-area');
        const btnCopy = document.getElementById('btn-copy');
        const btnClear = document.getElementById('btn-clear');
        const btnSettings = document.getElementById('btn-settings');

        const mainPanel = document.getElementById('main-panel');
        const settingsPanel = document.getElementById('settings-panel');

        // View Toggle Elements
        const btnViewConverted = document.getElementById('btn-view-converted');
        const btnViewOriginal = document.getElementById('btn-view-original');

        // Settings Elements
        const nasalToggle = document.getElementById('nasal-superscript-toggle');
        const tone6Toggle = document.getElementById('tone6-toggle');
        const allCapsToggle = document.getElementById('all-caps-toggle');
        const btnRunTest = document.getElementById('ui-btn-run-test');
        const btnResetSettings = document.getElementById('ui-btn-reset-settings');

        // State
        let isSettingsOpen = false;
        let rawContent = '';
        let isRawView = false; // "Original" view
        let isUpdatingView = false; // Lock to prevent circular updates
        let previousVal = ''; // Tracks the last known UI value for diffing

        function toggleSettingsView() {
            isSettingsOpen = !isSettingsOpen;
            if (isSettingsOpen) {
                mainPanel.classList.add('hidden');
                settingsPanel.classList.add('active');
                btnSettings.innerHTML = UI_STRINGS.buttons.back; // Change icon to Back
            } else {
                mainPanel.classList.remove('hidden');
                settingsPanel.classList.remove('active');
                btnSettings.innerHTML = UI_STRINGS.buttons.settings; // Change icon to Settings
                inputArea.focus();
            }
        }

        btnSettings.addEventListener('click', toggleSettingsView);

        // View Switching Logic
        function updateView(newViewIsRaw) {
            if (isUpdatingView) return;
            isUpdatingView = true;

            if (isRawView) {
                // Was Raw: `rawContent` is already the value in the box
                // We trust the input event to keep it synced, but just in case:
                rawContent = inputArea.value;
            } else {
                // Was Converted: `rawContent` *should* be the source logic has been tracking.
                // We rely on the input listener to have kept rawContent updated correctly.
                // Exception: if box is empty, reset rawContent.
                if (!inputArea.value) rawContent = '';
            }

            isRawView = newViewIsRaw;

            if (isRawView) {
                // Switch to Original
                btnViewOriginal.classList.add('active');
                btnViewConverted.classList.remove('active');
                inputArea.value = rawContent;
                inputArea.placeholder = UI_STRINGS.views.originalPlaceholder;
                previousVal = rawContent;
            } else {
                // Switch to Converted
                btnViewConverted.classList.add('active');
                btnViewOriginal.classList.remove('active');
                // We convert the *Source* (rawContent) to display
                const converted = TLtiau_2_POJtiau(rawContent);
                inputArea.value = converted;
                inputArea.placeholder = UI_STRINGS.placeholder;
                previousVal = converted;
            }

            isUpdatingView = false;
            inputArea.focus();

            // Reset cursor to beginning as requested
            inputArea.setSelectionRange(0, 0);
            inputArea.scrollTop = 0;
        }

        btnViewConverted.addEventListener('click', () => {
            if (isRawView) updateView(false);
        });

        btnViewOriginal.addEventListener('click', () => {
            if (!isRawView) updateView(true);
        });

        // Input Conversion Logic
        inputArea.addEventListener('input', (e) => {
            if (isUpdatingView) return;

            const val = inputArea.value;

            if (isRawView) {
                // In Original Mode: simple sync
                rawContent = val;
                previousVal = val;
            } else {
                // In Converted Mode:
                // We must deduce what to add to `rawContent`.

                // 1. Detect Change - Append Strategy
                if (val.startsWith(previousVal)) {
                    // User appended text
                    const diff = val.slice(previousVal.length);
                    rawContent += diff;
                } else {
                    // Complex Edit (delete, insert middle, paste replace)
                    // Fallback: We reset history to "what you see is what you get"
                    // to keep consistent.
                    rawContent = val;
                }

                // 2. Check for Trigger
                const cursorPos = inputArea.selectionStart;


                // 2. Perform Conversion on RAW content (Always, unless composing)
                // Skip view update if composing (IME) to avoid breaking composition
                if (e.isComposing) {
                    previousVal = val;
                } else {
                    const oldLen = val.length;
                    const newVal = TLtiau_2_POJtiau(rawContent); // Convert from SOURCE

                    if (newVal !== val) {
                        inputArea.value = newVal;
                        previousVal = newVal;

                        // We DO NOT update rawContent to newVal here.
                        // rawContent stays as source (e.g. "Tai5 ")
                        // Visual is "Tâi ".

                        // Cursor Restoration
                        const newLen = newVal.length;
                        const diffLen = newLen - oldLen;
                        let newCursor = cursorPos + diffLen;
                        if (newCursor < 0) newCursor = 0;
                        if (newCursor > newLen) newCursor = newLen;
                        inputArea.setSelectionRange(newCursor, newCursor);
                    } else {
                        // No visual change, update tracker
                        previousVal = val;
                    }
                }
            }

            adjustScrollPosition();
        });

        // Auto-Scroll Logic
        function adjustScrollPosition() {
            // requestAnimationFrame to ensure we calculate after layout updates
            requestAnimationFrame(() => {
                const styles = window.getComputedStyle(inputArea);
                let lineHeight = parseFloat(styles.lineHeight);
                const paddingBottom = parseFloat(styles.paddingBottom);

                // Fallback if lineHeight is "normal" or invalid
                if (isNaN(lineHeight)) {
                    const fontSize = parseFloat(styles.fontSize);
                    lineHeight = fontSize * 1.6; // approx 1.6 from CSS line-height
                }

                if (isNaN(lineHeight) || lineHeight <= 0) return;

                // Adjust scrollHeight to exclude the synthetic padding-bottom we added
                // scrollHeight in DOM includes padding
                const realContentHeight = inputArea.scrollHeight - paddingBottom;

                // Goal: Top of viewport should be at `realTextEnd - (SCROLL_LOCK_LINES * lineHeight)`
                const targetScrollTop = realContentHeight - (SCROLL_LOCK_LINES * lineHeight);

                // Only scroll if we have enough content
                if (targetScrollTop > 0) {
                    inputArea.scrollTop = targetScrollTop;
                }
            });
        }

        // Toolbar Buttons
        btnCopy.addEventListener('click', async () => {
            await navigator.clipboard.writeText(inputArea.value);
            const original = btnCopy.innerHTML;
            btnCopy.innerHTML = UI_STRINGS.buttons.copied;
            setTimeout(() => btnCopy.innerHTML = original, 1500);
            inputArea.focus();
        });

        btnClear.addEventListener('click', () => {
            inputArea.value = '';
            inputArea.focus();
        });

        // Settings Toggles
        function updateSettings() {
            window.TL_USE_NASAL_SUPERSCRIPT = nasalToggle.checked;
            window.TL_TONE6_USE_CARON = tone6Toggle.checked;
            window.TL_ALL_CAPS_SUPPORT = allCapsToggle.checked;

            // Update Scroll Lines
            const linesVal = parseInt(document.getElementById('scroll-lines-input').value, 10);
            if (!isNaN(linesVal) && linesVal > 0) {
                SCROLL_LOCK_LINES = linesVal;
            }

            // Re-convert current text with new settings
            const currentVal = inputArea.value;
            if (currentVal) {
                const newVal = TLtiau_2_POJtiau(currentVal);
                if (newVal !== currentVal) {
                    inputArea.value = newVal;
                }
            }

            saveSettings();
        }

        // --- Local Storage Logic ---
        const STORAGE_KEY = 'TL_POJ_SIMPLE_SETTINGS';

        function saveSettings() {
            const settings = {
                nasal: nasalToggle.checked,
                tone6: tone6Toggle.checked,
                allCaps: allCapsToggle.checked,
                scrollLines: document.getElementById('scroll-lines-input').value
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    if (typeof settings.nasal === 'boolean') nasalToggle.checked = settings.nasal;
                    if (typeof settings.tone6 === 'boolean') tone6Toggle.checked = settings.tone6;
                    if (typeof settings.allCaps === 'boolean') allCapsToggle.checked = settings.allCaps;
                    if (settings.scrollLines) document.getElementById('scroll-lines-input').value = settings.scrollLines;
                } catch (e) {
                    console.error("Failed to load settings:", e);
                }
            }
        }

        nasalToggle.addEventListener('change', updateSettings);
        tone6Toggle.addEventListener('change', updateSettings);
        allCapsToggle.addEventListener('change', updateSettings);
        document.getElementById('scroll-lines-input').addEventListener('change', updateSettings);

        // Reset Logic

        // Test and Reset
        const TEST_SAMPLE = `=== TL 符號調輸入 (Diacritics) ===
Tâi-uân sī chi̍t-ê hó só͘-chāi. (台灣是一个好所在)
Tsit-chân tāi-tsì tsin-tsiànn hó. (這層代誌真正好)
POJ 帶符號調號無 koh 轉: Góa ài lim tê, i ài chia̍h pn̄g. (我愛啉茶，伊愛食飯)

=== TL/POJ 數字調輸入 (Numeric) ===
Tai5-uan5 si7 chit8-e5 ho2 so2-chai7.
Goa2 ai3 lim te5, i ai3 chiah8 png7.

=== 調號 1-9 (Tones) ===
a1 a2 a3 ah4 a5 a6 a7 ah8 a9
A1 A2 A3 AH4 A5 A6 A7 AH8 A9
e1 e2 e3 eh4 e5 e6 e7 eh8 e9
o1 o2 o3 oh4 o5 o6 o7 oh8 o9

=== TL→POJ 音素轉換 (Phonemes) ===
\\[ts\\]: tsuí (水), tsit (這)
\\[tsh\\]: tshut (出), tshài (菜)
\\[oo\\]: oo (烏), hōo (予)
j: jī (字), jia̍t (熱) (無變)

\\[=== 鼻音 (nn / N) ===
[尾N→ⁿ Toggle(切)]
nn尾 (一定 lóng 轉): sann→saⁿ (三), sinn→siⁿ (生)
N尾 ON: saN→saⁿ, siN→siⁿ, a̍hN→a̍hⁿ
N尾 OFF: saN→saN, siN→siN, a̍hN→a̍hN\\]
(頭前 ê nn / N 袂變: nng → nng, NG → NG)

\\[=== 第六調 (Tone 6) ===
[第6調 ǎ Toggle(切)]
ON (Caron): a6→ǎ, e6→ě, o6→ǒ, ng6→ňg
OFF (Acute): a6→á, e6→é, o6→ó, ng6→ńg\\]

\\[=== 大寫 (ALL CAPS) ===
[大寫模式 Toggle(切)]
ON: TSUI→CHUI, TSHUT→CHHUT, OO→O͘
OFF: TSUI→TSUI, TSHUT→TSHUT, OO→OO (無轉)\\]

\\[=== 調位標記 (Vowel Priority) ===
ua→oa: tuà→tòa (大), kuà→kòa (掛)
ue→oe: kué→kóe (粿), pué→póe (飛)
ui: suí→súi (水), kuí→kúi (鬼)\\]

=== 走脫語法 (Escape Syntax) ===
基本: \\[Tâi-uân\\] → Tâi-uân (原文保留)
濟逝: \\[Thâu tsuā
Jī tsuā\\] ← Hāⁿ 逝 mā lóng 袂轉

相套 (Nested):
\\[khí-thâu \\[ tē-jī\\] ← thâu-ê \\] 就收煞
\\[(結果: "khí-thâu \\[ tē-jī" + 落尾照常轉)\\]

英文: \\[Google\\] vs Google, \\[Boots\\] vs Boots
     \\["I read a book about blue cats."\\] vs "I read a book about blue cats."
URL: \\["https://example.com/page?id=tsing_tsha"\\] vs "https://example.com/page?id=tsing_tsha"

=== 邊墘狀況 (Other Cases) ===
混合: 123 !@# $100 (tsu-pún) {tsuí}
月眉: (tsia̍h pn̄g) [tsia̍h pn̄g] {tsia̍h pn̄g}
引句點: "tsuí" 'tsuí' 「tsuí」『tsuí』
Han-jī 相濫: 台灣 Tâi-uân 是 sī 好 hó 所在 só͘-chāi
頭尾空白:"   tsuí   "(空白無變)
Ài 有連字符: \\[Tâiuânlâng, tsabóogíná\\] → Tâiuânlâng, tsabóogíná (無連字符無保證著)
數字調號相濫: Goa2 ài 啉 tê, 伊 ai3 食 png7.

=== POJ 保留 (POJ Preservation) ===
POJ 鼻化「ⁿ」: chiâⁿ→chiâⁿ, siaⁿ→siaⁿ, koaⁿ→koaⁿ (袂變做 Tailo nn)
POJ O͘點「o͘」: hó͘→hó͘, gô͘→gô͘, o͘→o͘ (袂變做 Tailo oo)
混合輸入: chiâⁿ tsuí → chiâⁿ chúi (POJ 保留, TL 照常轉)
混合輸入: hó͘ oo → hó͘ o͘ (POJ o͘ 保留, TL oo 轉做 POJ)
大寫 POJ: Chiâⁿ→Chiâⁿ, Ô͘→Ô͘ (大寫 POJ mā 袂變)`;

        btnRunTest.addEventListener('click', () => {
            // Switch to main view to see result
            if (isSettingsOpen) toggleSettingsView();

            // Set raw content state for "Original" view
            rawContent = TEST_SAMPLE;

            // Trigger conversion and update UI
            const converted = TLtiau_2_POJtiau(TEST_SAMPLE);
            inputArea.value = converted;

            // Update diff tracking state
            previousVal = converted;

            // Ensure we are in Converted view to see the result
            if (isRawView) {
                isRawView = false;
                btnViewConverted.classList.add('active');
                btnViewOriginal.classList.remove('active');
                inputArea.placeholder = UI_STRINGS.placeholder;
            }

            // Scroll to top
            inputArea.scrollTop = 0;
            inputArea.setSelectionRange(0, 0);
        });

        btnResetSettings.addEventListener('click', () => {
            nasalToggle.checked = false; // Default: false (from problem desc? wait, user said "three default value for conversions")
            // User request: "let @[working/tl_poj_converter_simple.html] have the same settings ( three default value for conversions )"
            // The original file had defaults:
            // window.TL_USE_NASAL_SUPERSCRIPT = false;
            // window.TL_TONE6_USE_CARON = false;
            // window.TL_ALL_CAPS_SUPPORT = false;

            tone6Toggle.checked = false;
            allCapsToggle.checked = false; // Actually previous user request asked to set these to false.

            // But wait, the previous user request said "Set the following settings to false: ... 大寫模式 (ALL CAPS)".
            // So defaults are all false.

            updateSettings();
        });

        // Sync initial state
        // We set checkbox 'checked' in HTML for some, need to sync JS state.
        // HTML: nasal=checked, tone6=unchecked, allcaps=checked.
        // WAIT, previous task said set them to FALSE.
        // "Set the following settings to false: 尾N→鼻化音"ⁿ", 第6調 (ǎ), 大寫模式 (ALL CAPS)"
        // I should update HTML to unchecked default or handle it here.
        // The HTML I wrote in Step 12 has checked for nasal and allcaps. 
        // I should enforce the defaults requested in previous turn (even though this is a new turn, "same settings" implies following the established config).
        // Let's force them to the "Simple" defaults which were requested to be false.

        // Actually the current user request says: "let ... have the same settings ... in the setting tab of tl_poj_converter.html"
        // Let's check tl_poj_converter.html defaults.
        // In the view of tl_poj_converter.html (Step 4), lines 751, 763, 776:
        // nasal: checked
        // tone6: unchecked
        // all-caps: checked
        // BUT the user in Conversation 81f50342 asked to set them to false.
        // Did I strictly follow that in the previous task for `tl_poj_converter.html`?
        // Step 1 says "Set the following settings to false...".
        // But the file content I read in Step 4 shows them as CHECKED in HTML?
        // Line 751: <input ... checked>
        // Line 776: <input ... checked>
        // Maybe I missed updating the HTML attributes in the previous conversation or I am misreading.

        // Let's trust the current file `tl_poj_converter.html` as source of truth for "same settings".
        // If `tl_poj_converter.html` has them checked, I will make them checked.
        // The user says "same settings... three default value".

        // In `tl_poj_converter_simple.html` script start (Step 5 line 206), I saw:
        // window.TL_USE_NASAL_SUPERSCRIPT = false;
        // window.TL_TONE6_USE_CARON = false;
        // window.TL_ALL_CAPS_SUPPORT = false;

        // I will sync to what is in HTML of simple.html which I just wrote (nasal=checked, allcaps=checked).
        // If I want to exactly match `tl_poj_converter.html` HTML:
        // Nasal: checked
        // Tone6: unchecked
        // AllCaps: checked.

        function downloadText(content, filename) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('btn-download').addEventListener('click', () => {
            const content = inputArea.value;
            // Generate filename based on current html filename logic requested
            const filename = UI_STRINGS.config.downloadFilename;
            downloadText(content, filename);
        });

        // So I will make sure updateSettings() is called to sync JS window vars with HTML checkboxes.
        updateSettings();

        inputArea.focus();

        async function downloadCleanVersion() {
            if (!confirm(UI_STRINGS.messages.downloadConfirm)) {
                return;
            }

            try {
                const btn = document.getElementById('ui-btn-download-offline');
                const btnText = document.getElementById('ui-btn-download-offline-text');
                const originalText = btnText.innerText;
                btnText.innerText = UI_STRINGS.messages.downloading;
                btn.disabled = true;

                const res = await fetch('https://raw.githubusercontent.com/CyberOoHim/CyberOoHim.github.io/main/pages/tl_poj_converter_simple.html');
                let text = await res.text();

                // Strip Jekyll front matter (---...---) and the HTML comment after it
                text = text.replace(/^---[\s\S]*?---\n/, '');
                text = text.replace(/^< !--[\s\S ]*?- ->\n/, '');
                text = text.trim();

                const blob = new Blob([text], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tl_poj_converter_simple.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                btnText.innerText = originalText;
                btn.disabled = false;
            } catch (err) {
                alert(UI_STRINGS.messages.downloadFailed);
            }
        }
    </script>
</body>

</html>