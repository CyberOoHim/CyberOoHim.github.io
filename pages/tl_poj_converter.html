---
layout: apps
title: TL to POJ Real-time Converter
version: v0.2d
permalink: /pages/tl_poj_converter.html
updated: 2026-01-06
note: 1. Enhance edge cases conversion 2. add settings/help tab
<!DOCTYPE html>
<!--
  Copyright (c) 2026 Cyber OÕò-h√Æm ki-tƒì
  Licensed under the MIT License: https://opensource.org/licenses/MIT
-->
<!-- Note: 1. This is a real-time TL -> POJ converter. -->
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TL to POJ Real-time Converter</title>
    <!-- Google Fonts: Huninn will be loaded dynamically with specific characters -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
        /* CSS Variables - From Image Resizer (Tech Theme) */
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --text-link: #58a6ff;
            --text-accent: #238636;
            --border-color: #30363d;
            --font-mono: 'Times New Roman', serif;
            --font-sans: 'Times New Roman', serif;
            --font-taigi: 'Huninn', 'Times New Roman', serif;
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 2rem;
            --spacing-lg: 4rem;
            --primary-color: var(--text-link);
            /* Mapping for backward compatibility if needed */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-sans);
            line-height: 1.6;
            padding: var(--spacing-md);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        header {
            text-align: center;
            margin-bottom: 0;
        }

        h1 {
            font-family: var(--font-mono);
            font-size: 1.2rem;
            margin-bottom: 0;
            color: var(--text-primary);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: 0;
            justify-content: center;
        }



        .tab-btn:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--bg-tertiary);
            /* Active state */
            color: var(--text-link);
            border-color: var(--text-link);
        }

        /* Panels */
        .panel {
            display: none;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: var(--spacing-sm);
        }

        .panel.active {
            display: block;
        }

        /* Real-time Mode Styles */
        .split-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            height: 600px;
        }

        @media (max-width: 768px) {
            .split-view {
                grid-template-columns: 1fr;
                height: auto;
            }
        }

        /* Handset Vertical Optimization */
        @media (max-width: 480px) {
            body {
                padding: var(--spacing-sm);
                /* Reduce body padding */
            }

            .container {
                gap: 0.25rem;
                /* Tighter vertical gaps */
            }

            h1 {
                font-size: 1.1rem;
                /* Slightly smaller title */
            }

            .tab-btn {
                padding: 0.5rem 1rem;
                /* Smaller tabs */
                font-size: 1rem;
            }

            .toolbar {
                flex-wrap: wrap;
                /* Allow toolbar items to wrap if needed */
                gap: 0.5rem;
            }

            .toolbar label {
                font-size: 1rem;
            }

            textarea {
                font-size: 1.2rem;
                /* Slightly smaller text for mobile readability */
                padding: 0.75rem;
            }
        }

        .text-area-container {
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100%;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xs);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--spacing-xs);
        }

        .toolbar label {
            font-family: var(--font-mono);
            font-size: 1.2rem;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .tool-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
            padding: 4px 8px;
            font-family: var(--font-mono);
            font-size: 1.1rem;
            cursor: pointer;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            color: var(--text-primary);
            border-color: var(--text-primary);
        }

        textarea {
            flex: 1;
            padding: var(--spacing-sm);
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            resize: none;
            font-family: var(--font-taigi);
            /* Huninn for Taigi, Times New Roman fallback */
            font-size: 1.4rem;
            line-height: 1.6;
            outline: none;
            width: 100%;
            color: var(--text-primary);
            box-sizing: border-box;
            min-height: 200px;
        }

        textarea:focus {
            border-color: var(--text-link);
            box-shadow: 0 0 0 1px var(--text-link);
        }

        /* Brighten placeholders */
        textarea::placeholder,
        input::placeholder {
            color: var(--text-secondary);
            opacity: 0.8;
            font-size: 1.2rem;
        }

        /* File Mode Styles */
        .file-drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 6px;
            padding: var(--spacing-lg);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(22, 27, 34, 0.5);
            /* Semi-transparent like upload area */
            margin-bottom: var(--spacing-md);
        }

        .file-drop-zone:hover,
        .file-drop-zone.drag-over {
            border-color: var(--text-link);
            background: rgba(88, 166, 255, 0.05);
        }

        .file-drop-zone p {
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 1.4rem;
            margin-bottom: var(--spacing-xs);
        }

        .btn {
            padding: 10px 20px;
            font-family: var(--font-mono);
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: var(--text-accent);
            color: white;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .btn:hover:not(:disabled) {
            background-color: #2ea043;
            box-shadow: 0 0 10px rgba(46, 160, 67, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #outputPreview {
            width: 100%;
            height: 400px;
        }

        /* Expander Styles */
        details {
            margin-bottom: 0.5rem;
        }

        details summary {
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 0.5rem;
            user-select: none;
            color: var(--text-primary);
        }

        /* Options Panel */
        .options-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .options-panel label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-family: var(--font-mono);
        }

        .options-panel input[type="checkbox"],
        .options-panel input[type="radio"] {
            accent-color: var(--text-link);
        }

        /* Columns/Keys List */
        .columns-list {
            max-height: 150px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            border-radius: 4px;
            background: var(--bg-primary);
        }

        /* Table Preview */
        #csv-preview-table-container {
            display: none;
            flex: 1;
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            max-height: 400px;
        }

        #csv-preview-table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--font-mono);
            font-size: 0.9rem;
        }

        #csv-preview-table th,
        #csv-preview-table td {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        #csv-preview-table th {
            background: var(--bg-tertiary);
            position: sticky;
            top: 0;
        }

        #csv-preview-table tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Warning Messages */
        #preview-messages {
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Toggle Switch Styles */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .switch-input {
            display: none;
        }

        .switch-label {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .switch-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            border-radius: 14px;
            transition: all 0.3s ease;
        }

        .switch-slider::before {
            content: "";
            position: absolute;
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .switch-input:checked+.switch-label .switch-slider {
            background-color: var(--text-link);
        }

        .switch-input:checked+.switch-label .switch-slider::before {
            transform: translateX(14px);
        }

        .switch-text {
            user-select: none;
            white-space: nowrap;
            color: var(--text-primary);
        }

        /* Help Tab Specifics */
        .tab-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: var(--font-mono);
            font-size: 1.2rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
            display: inline-flex;
            /* Changed to inline-flex for baseline alignment */
            align-items: baseline;
            justify-content: center;
            gap: 0.5rem;
        }

        #ui-tab-help {
            padding-left: 12px;
            padding-right: 12px;
        }

        #ui-tab-help svg {
            display: block;
            transform: translateY(3px);
            /* Optical alignment with text baseline */
        }

        /* Help Content Styles */
        .settings-section,
        .help-section,
        .about-section {
            color: var(--text-primary);
        }

        .help-content h4 {
            margin-top: 1rem;
            color: var(--text-link);
        }

        .help-content p {
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        #msg-specific-warning {
            color: #f0ad4e;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1 id="ui-title"></h1>
        </header>

        <div class="tabs" style="justify-content: center; align-items: center;">
            <button class="tab-btn active" onclick="switchMode('realtime')" id="ui-tab-realtime"></button>
            <button class="tab-btn" onclick="switchMode('file')" id="ui-tab-file"></button>
            <button class="tab-btn" onclick="switchMode('help')" id="ui-tab-help">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 40" width="72" height="24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <g transform="translate(28, 8)">
                        <path
                            d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                        <circle cx="12" cy="12" r="3" />
                    </g>
                    <line x1="55" y1="32" x2="65" y2="8" stroke-width="2.5" />
                    <g transform="translate(68, 8)">
                        <circle cx="12" cy="12" r="10" />
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                        <path d="M12 17h.01" />
                    </g>
                </svg>
            </button>
        </div>

        <!-- Real-time Panel -->
        <div id="panel-realtime" class="panel active">
            <div class="split-view">
                <div class="text-area-container">
                    <div class="toolbar">
                        <label for="rt-input" id="ui-label-input"></label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="tool-btn" onclick="pasteFromClipboard('rt-input')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2">
                                    </path>
                                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                                </svg>
                                <span id="ui-btn-paste"></span>
                            </button>
                            <button class="tool-btn" onclick="clearInput('rt-input')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                                <span id="ui-btn-clear"></span>
                            </button>
                        </div>
                    </div>
                    <textarea id="rt-input" placeholder="" spellcheck="false"></textarea>
                    <button class="tool-btn" id="ui-btn-quick-test" onclick="injectTestText()"
                        style="margin-top: var(--spacing-xs); align-self: center;"></button>
                </div>
                <div class="text-area-container">
                    <div class="toolbar">
                        <label for="rt-output" id="ui-label-output"></label>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="tool-btn" onclick="copyToClipboard('rt-output', 'ui-btn-copy-rt')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                <span id="ui-btn-copy-rt"></span>
                            </button>
                            <button class="tool-btn" onclick="downloadText('rt-output', 'poj_conversion.txt')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                <span id="ui-btn-download-rt"></span>
                            </button>
                        </div>
                    </div>
                    <textarea id="rt-output" readonly placeholder="" spellcheck="false"></textarea>
                </div>
            </div>
        </div>

        <!-- File Converter Panel -->
        <div id="panel-file" class="panel">
            <!-- File Upload Section -->
            <details id="file-upload-expander" open>
                <summary id="ui-file-upload-header" style="font-size: 1.2rem;"></summary>
                <div class="file-drop-zone" id="dropZone">
                    <p id="ui-drop-text"></p>
                    <input type="file" id="fileInput" accept=".txt,.md,.srt,.vtt,.csv,.tsv,.json,.pdf"
                        style="display: none;">
                    <button class="btn" id="btn-choose-file"
                        style="display: inline-flex; align-items: center; gap: 8px; margin-top: 0.5rem;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <span id="ui-btn-choose-file"></span>
                    </button>
                </div>
            </details>

            <!-- CSV Options Section -->
            <details id="csv-options-expander" style="display: none;">
                <summary id="ui-csv-options-header"></summary>
                <div class="options-panel">
                    <label id="lbl-select-columns" style="font-weight: bold;"></label>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.25rem;">
                        <button type="button" id="btn-csv-select-all" class="tool-btn"
                            style="font-size: 0.75rem;"></button>
                        <button type="button" id="btn-csv-deselect-all" class="tool-btn"
                            style="font-size: 0.75rem;"></button>
                    </div>
                    <div id="csv-columns-list" class="columns-list"></div>

                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label id="lbl-output-mode" style="font-weight: bold;"></label>
                        <label><input type="radio" name="csv-mode" value="only" checked> <span
                                class="csv-mode-only"></span></label>
                        <label><input type="radio" name="csv-mode" value="original-plus"> <span
                                class="csv-mode-original-plus"></span></label>
                        <label><input type="radio" name="csv-mode" value="insert"> <span
                                class="csv-mode-insert"></span></label>
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <button id="btn-convert-csv" class="btn" style="flex: 1;"></button>
                        <button id="btn-reset-csv" class="tool-btn"></button>
                    </div>
                </div>
            </details>

            <!-- JSON Options Section -->
            <details id="json-options-expander" style="display: none;">
                <summary id="ui-json-options-header"></summary>
                <div class="options-panel">
                    <label id="lbl-select-keys" style="font-weight: bold;"></label>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.25rem;">
                        <button type="button" id="btn-json-select-all" class="tool-btn"
                            style="font-size: 0.75rem;"></button>
                        <button type="button" id="btn-json-deselect-all" class="tool-btn"
                            style="font-size: 0.75rem;"></button>
                    </div>
                    <div id="json-keys-list" class="columns-list" style="font-family: monospace; font-size: 0.85rem;">
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label id="lbl-json-output-mode" style="font-weight: bold;"></label>
                        <label><input type="radio" name="json-mode" value="only" checked> <span
                                class="json-mode-only"></span></label>
                        <label><input type="radio" name="json-mode" value="original-plus"> <span
                                class="json-mode-original-plus"></span></label>
                        <label><input type="radio" name="json-mode" value="insert"> <span
                                class="json-mode-insert"></span></label>
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <button id="btn-convert-json" class="btn" style="flex: 1;"></button>
                        <button id="btn-reset-json" class="tool-btn"></button>
                    </div>
                </div>
            </details>

            <!-- Subtitle Options Section -->
            <details id="subtitle-options-expander" style="display: none;">
                <summary id="ui-subtitle-options-header"></summary>
                <div class="options-panel">
                    <label id="lbl-select-lines" style="font-weight: bold;"></label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label><input type="radio" name="subtitle-mode" value="all" checked> <span
                                class="subtitle-mode-all"></span></label>
                        <label><input type="radio" name="subtitle-mode" value="line1"> <span
                                class="subtitle-mode-line1"></span></label>
                        <label><input type="radio" name="subtitle-mode" value="line2"> <span
                                class="subtitle-mode-line2"></span></label>
                        <label><input type="radio" name="subtitle-mode" value="line3plus"> <span
                                class="subtitle-mode-line3plus"></span></label>
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <button id="btn-convert-subtitle" class="btn" style="flex: 1;"></button>
                        <button id="btn-reset-subtitle" class="tool-btn"></button>
                    </div>
                </div>
            </details>

            <!-- Output Section -->
            <div id="fileOutputSection" style="display: none;">
                <div id="preview-messages">
                    <span id="msg-general-warning"></span>
                    <span id="msg-specific-warning" style="display: none;"></span>
                </div>
                <div class="toolbar">
                    <label id="ui-label-result"></label>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="tool-btn" id="btn-reset-file" title="Ap-l√≥Õò Êñ∞ √™ Êõ∏È°û">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                        </button>
                        <button class="tool-btn" id="btn-copy-file">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            <span id="ui-btn-copy-file"></span>
                        </button>
                        <button class="tool-btn" id="btn-download-file">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <span id="ui-btn-download-file"></span>
                        </button>
                    </div>
                </div>
                <textarea id="outputPreview" readonly placeholder=""></textarea>
                <div id="csv-preview-table-container"></div>
            </div>
        </div>

        <!-- Help & Settings Panel -->
        <div id="panel-help" class="panel">
            <div class="settings-section" style="padding: 1rem; border-bottom: 1px solid var(--border-color);">
                <h3 id="ui-header-settings" style="margin-top: 0; font-size: 1.1rem; color: var(--text-primary);">
                    Settings</h3>
                <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="ui-lbl-nasal-toggle"
                        style="color: var(--text-primary); font-family: var(--font-mono);">Nasal Superscript</span>
                    <div class="switch-container">
                        <input type="checkbox" id="nasal-superscript-toggle" class="switch-input" checked>
                        <label for="nasal-superscript-toggle" class="switch-label">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="setting-item"
                    style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                    <span id="ui-lbl-tone6-toggle"
                        style="color: var(--text-primary); font-family: var(--font-mono);">Tone 6</span>
                    <div class="switch-container">
                        <input type="checkbox" id="tone6-toggle" class="switch-input">
                        <label for="tone6-toggle" class="switch-label">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="setting-item"
                    style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                    <span id="ui-lbl-allcaps-toggle"
                        style="color: var(--text-primary); font-family: var(--font-mono);">All
                        Caps</span>
                    <div class="switch-container">
                        <input type="checkbox" id="all-caps-toggle" class="switch-input" checked>
                        <label for="all-caps-toggle" class="switch-label">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="setting-item" style="margin-top: 1.5rem; text-align: center;">
                    <button id="ui-btn-run-test" class="tool-btn" style="width: 100%; justify-content: center;">
                        Run UI Test
                    </button>
                    <button id="ui-btn-reset-settings" class="tool-btn"
                        style="width: 100%; justify-content: center; margin-top: 0.5rem; background-color: var(--border-color); color: var(--text-primary);">
                        Reset to Default
                    </button>
                </div>
            </div>

            <div class="help-section" style="padding: 1rem;">
                <h3 id="ui-header-help" style="font-size: 1.1rem; color: var(--text-primary); margin-bottom: 1rem;">Help
                </h3>
                <div class="help-content" style="font-size: 0.9rem; line-height: 1.5; color: var(--text-primary);">
                    <h4 style="margin-bottom: 0.5rem;">1. ÊãçÈö®ËΩâ (Real-time Mode)</h4>
                    <p style="margin-top: 0; margin-bottom: 1rem;">
                        Input TL or POJ with numeric tones.<br>
                        - Input box: Type/Paste text.<br>
                        - Output box: View converted POJ.<br>
                    </p>

                    <h4 style="margin-bottom: 0.5rem;">2. ËΩâÊõ∏È°û (File Mode)</h4>
                    <p style="margin-top: 0; margin-bottom: 1rem;">
                        Convert files in bulk.<br>
                        - Supported: .txt, .md, .srt, .vtt, .csv, .tsv, .json, .pdf<br>
                        - Preview and download converted results.
                    </p>
                </div>

                <div class="about-section"
                    style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <h4 id="ui-header-about" style="margin-bottom: 0.5rem;">About</h4>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0;">
                        TL -> POJ Èö®ÊôÇËΩâ Converter<br>
                        Copyright ¬© 2026 Cyber OÕò-h√Æm ki-tƒì<br>
                        Licensed under MIT License
                    </p>

                    <h5 style="margin-bottom: 0.25rem; font-size: 0.8rem; margin-top: 1rem;">Libraries & Assets</h5>
                    <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0;">
                        <strong>PDF.js</strong> (Mozilla Foundation)<br>
                        Licensed under Apache License 2.0<br><br>
                        <strong>Huninn </strong> (justfont)<br>
                        Licensed under SIL Open Font License 1.1<br><br>
                    </p>
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: var(--spacing-sm);">
            <button class="tool-btn" id="ui-btn-download-offline" onclick="downloadCleanVersion()"
                style="padding: 10px 20px; display: inline-flex; border-style: dashed;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span id="ui-btn-download-offline-text"></span>
            </button>
        </div>

        <footer
            style="text-align: center; margin-top: var(--spacing-md); color: var(--text-secondary); font-size: 0.9rem;">
            <p id="ui-footer"></p>
        </footer>
    </div>

    <script>

        const taigiCharsToLoad = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ√°√†√¢ƒÅaÃç√©√®√™ƒìeÃç√≠√¨√Æƒ´iÃç√≥√≤√¥≈çoÃç√∫√π√ª≈´uÃç√Å√Ä√ÇƒÄAÃç√â√à√äƒíEÃç√ç√å√éƒ™IÃç√ì√í√î≈åOÃç√ö√ô√õ≈™UÃçoÕò√≥Õò√≤Õò√¥Õò≈çÕòoÃçÕòOÕò√ìÕò√íÕò√îÕò≈åÕòOÃçÕòa‚Åøe‚Åøi‚Åøo‚Åøu‚ÅøoÕò‚ÅøA‚ÅøE‚ÅøI‚ÅøO‚ÅøU‚ÅøOÃçÕò‚Åø√°‚Åø√†‚Åø√¢‚ÅøƒÅ‚ÅøaÃç‚Åø√©‚Åø√®‚Åø√™‚ÅøƒìeÃç‚Åø√≠‚Åø√¨‚Åø√Æ‚Åøƒ´iÃç‚Åø√≥‚Åø√≤‚Åø√¥‚Åø≈çÕò‚ÅøoÃçÕò‚Åø√∫‚Åø√π‚Åø√ª‚Åø≈´‚ÅøuÃç‚Åø√≥Õò‚Åø√≤Õò‚Åø√¥Õò‚Åø≈çÕò‚ÅøoÃçÕò‚Åø√Å‚Åø√Ä‚Åø√Ç‚ÅøƒÄ‚ÅøAÃç‚Åø√â‚Åø√à√ä‚Åøƒí‚ÅøEÃç‚Åø√ç√å√éƒ™IÃç‚Åø√ì√í√î≈å‚ÅøOÃç‚Åø√ö‚Åø√ô‚Åø√õ‚Åø≈™‚ÅøUÃç‚Åø√ìÕò‚Åø√íÕò‚Åø√îÕò‚Åø≈åÕò‚ÅøOÃçÕò‚ÅøƒÉƒïƒ≠≈è≈≠≈èÕòƒÇƒîƒ¨≈é≈¨≈éÕò·∏ømÃÄmÃÇmÃÑmÃçmÃÜ·∏æMÃÄMÃÇMÃÑMÃçMÃÜ≈Ñ«πnÃÇnÃÑnÃçnÃÜ≈É«∏NÃÇNÃÑNÃçNÃÜ-0123456789.,;:?!'\"()[]{}<>@#$%^&*_+=\\|/";

        // Dynamically load Google Font "Huninn" with specific Taigi characters
        (function loadHuninnFont() {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = `https://fonts.googleapis.com/css2?family=Huninn&display=swap&text=${encodeURIComponent(taigiCharsToLoad)}`;
            document.head.appendChild(link);
        })();

        // --- UI Constants ---
        const UI_STRINGS = {
            title: "TL -> POJ Èö®ÊôÇËΩâ",
            tabs: {
                realtime: "ÊãçÈö®ËΩâ",
                file: "ËΩâÊõ∏È°û"
            },
            labels: {
                input: "TL / TL & POJ Â∏∂Êï∏Â≠óË™øËôü",
                output: "POJ Ëº∏Âá∫",
                result: "ËΩâsoahÁµêÊûú"
            },
            buttons: {
                paste: "Ë≤º TL",
                copy: "khoÕò--Ëµ∑‰æÜ",
                download: "T√°ng-l√≥Õò",
                chooseFile: "Ap-l√≥Õò",
                copied: "khoÕò Â•Ω--ah!",
                quickTest: "ÁúãË¶ãÊú¨/Âø´ÈÄüÊ∏¨",
                downloadOffline: "‚¨á T√°ng-l√≥Õò App ÂÆ∂Â∑±ÈõªËÖ¶Áî®",
                clear: "Á∏ΩÊ∏Ö",
                cancel: "ÂèñÊ∂à"
            },
            placeholders: {
                input: `Ë™™ÊòéÔºö
1. Êãç/Ë≤º TL heÃçk-chi√° TL/POJ Ê®ôÊï∏Â≠óË™øËôü...(e.g. T√¢i-u√¢nÔºåTai5-uan5ÔºåiaÃçh-sƒ´ Tai5-oan5). 
2. ÁÑ° beh ËΩâ √™ ÊñáÂ≠ó kƒÅ Áî® \\[ ... ] ÂåÖ--Ëµ∑‰æÜ„ÄÇ
3. ÁúãË¶ãÊú¨ iaÃçh-sƒ´ Âø´ÈÄüÊ∏¨ÔºåchhiÃçh ‰∏ãË∑§ chhiÃçh-li√∫„ÄÇ
4. T√°ng-l√≥Õò(download) ÈÄôÊîØ AppÔºå‰∏ä‰∏ãË∑§Êúâ chhiÃçh-li√∫„ÄÇ
5. ÊØãthang Êãç Á¨¶ËôüË™øËôü POJ koh ËêΩÂéªËΩâÔºåÁÑ°‰øùË≠âÁµêÊûú„ÄÇ`,
                output: "POJ Ëº∏Âá∫...",
                preview: "Ëº∏Âá∫ÊúÉ tƒ´ chia..."
            },
            dropZone: {
                main: "KƒÅ Êõ∏È°û Êãñ‰æÜ chia, iaÃçh-sƒ´ chhiÃçh Ap-l√≥Õò ÊèÄÊõ∏È°û, .txt/.md/.srt/.vtt/.csv/.tsv/.json/.pdf l√≥ng ÊúÉ‰Ωø„ÄÇ"
            },
            file: {
                uploadHeader: "üìÅ Ap-l√≥Õò Êõ∏È°û",
                previewLabel: "ËΩâsoahÁµêÊûú",
                fileTypes: {
                    csv: " (CSV Ë°®Ê†º)",
                    tsv: " (TSV Ë°®Ê†º)",
                    json: " (JSON Ë≥áÊñô)",
                    pdf: " (PDF Êñá‰ª∂)",
                    text: " (Text Êñá‰ª∂)",
                    md: " (Markdown Êñá‰ª∂)",
                    srt: " (SRT Â≠óÂπï)",
                    vtt: " (VTT Â≠óÂπï)"
                },
                messages: {
                    general: "* √Äi Á¥∞ËÜ©ÔºåËã±Êñá aÃçh-sƒ´ ÂÖ∂‰ªñÂ§ñË™û √™ ÁæÖÈ¶¨Â≠ó k√°m ÊúâË™§ËΩâ„ÄÇ",
                    pdf: "* ÊéíÁâàËã•Ëµ∞Á≤æ--ÂéªÔºåÊúÉÁî®ÂæóÊèêÂéª h≈çÕò AI ÈáçÊéí„ÄÇ"
                }
            },
            csv: {
                optionsHeader: "‚öôÔ∏è CSV/TSV Ë®≠ÂÆö",
                selectColumns: "ÊèÄÊ¨≤ËΩâ √™ Áõ¥ÈÄù:",
                outputMode: "Output Ê®°Âºè:",
                modeOnly: "kan-ta ËΩâÂ•Ω--√™",
                modeOriginalPlus: "ÂéüÁõ¥ÈÄù + ËΩâÂ•Ω--√™",
                modeInsert: "Êèí tƒ´ ÂéüÁõ¥ÈÄùÂæåÂ£Å",
                btnConvert: "ÈñãÂßãËΩâ CSV"
            },
            json: {
                optionsHeader: "‚öôÔ∏è JSON Ë®≠ÂÆö",
                selectKeys: "ÊèÄÊ¨≤ËΩâ √™ Key:",
                outputMode: "Output Ê®°Âºè:",
                modeOnly: "kan-ta ËΩâÂ•Ω--√™",
                modeOriginalPlus: "Âéü Key + ËΩâÂ•Ω--√™",
                modeInsert: "Êèí tƒ´ Âéü Key ÂæåÂ£Å",
                btnConvert: "ÈñãÂßãËΩâ JSON"
            },
            subtitle: {
                optionsHeader: "‚öôÔ∏è Â≠óÂπïË®≠ÂÆö",
                selectLines: "ÊèÄÊ¨≤ËΩâ‰Ωó‰∏ÄÈÄù:",
                modeAll: "L√≥ng-ch√≥ng",
                modeLine1: "kan-ta È†≠ÈÄù",
                modeLine2: "kan-ta Á¨¨ 2 ÈÄù",
                modeLine3Plus: "kan-ta Á¨¨ 3 ÈÄù‰ª•Âæå",
                btnConvert: "ÈñãÂßãËΩâÂ≠óÂπï",
                detectPrompt: "ÈÄô‰ªΩ .txt ÁúãËµ∑‰æÜÊúâÂ≠óÂπïÊôÇÊ®ôÔºåk√†m beh Áî®Â≠óÂπïÊ®°ÂºèËΩâÔºü"
            },

            settings: {
                tabName: "Help & Settings",
                headerSettings: "Ë®≠ÂÆö (Settings)",
                headerHelp: "Ë™™Êòé (Help)",
                headerAbout: "ÈóúÊñº (About)",
                nasalLabel: 'Â∞æN‚ÜíÈºªÂåñÈü≥"‚Åø"',
                tone6Label: "Á¨¨6Ë™ø («é)",
                allCapsLabel: "Â§ßÂØ´Ê®°Âºè (ALL CAPS)",
                btnRunTest: "Áúã TL->POJ √™ Ë¶ãÊú¨ aÃçh-sƒ´ Ê∏¨ÁúãË¶ì",
                btnReset: "ÊÅ¢Âæ©ÂàùË®≠ (Reset Default)"
            },
            selectionButtons: {
                selectAll: "Á∏ΩÊèÄ",
                deselectAll: "Á∏ΩÊ∏Ö"
            },
            tooltips: {
                resetFile: "Ap-l√≥Õò Êñ∞ √™ Êõ∏È°û"
            },
            footer: "¬© 2026 Cyber OÕò-h√Æm ki-tƒì",
            messages: {
                clipboardError: "ÁÑ°Ê≥ïÂ∫¶Ëá™ÂãïË≤ºÔºåchhiÃçh Ctrl+V Ë≤ºÁúãË¶ì„ÄÇ",
                truncated: "\n\n...\n\n----------\n\n‚Üë ÂÖàÁúã--‰∏Ä‰∏ãÁàæÔºåÂÆåÊï¥--√™ √†i t√°ng-l√≥Õò...",
                downloadConfirm: "K√°m ÊúâÁ¢∫ÂÆö beh t√°ng-l√≥Õò tƒ´ ÂÆ∂Â∑±ÈõªËÖ¶Áî®Ôºü",
                fileTypeError: "Êõ∏È°ûÊ†ºÂºèÁÑ°ÊîØÊè¥„ÄÇ√Äi ap-l√≥ÕòÔºö ",
                selectColumnsError: "‰∏äÁÑ°ÊèÄ‰∏ÄÈÄùÁõ¥ÈÄù‰æÜËΩâ„ÄÇ",
                selectKeysError: "‰∏äÁÑ°ÊèÄ‰∏Ä‰∏™ Key ‰æÜËΩâ„ÄÇ",
                selectSubtitleLinesError: "‰∏äÁÑ°ÊèÄ‰∏ÄÈÄù‰æÜËΩâ„ÄÇ",
                pdfParseError: "PDF ÊúâÈáçËÄΩÔºåËÆÄÁÑ°Ôºö ",
                jsonParseError: "JSON ÊúâÈáçËÄΩÔºåËÆÄÁÑ°Ôºö ",
                downloadFailed: "T√°ng-l√≥Õò Â§±Êïó„ÄÇkoh Ë©¶ÁúãË¶ì„ÄÇ",
                downloading: "Tng teh t√°ng-l√≥Õò ..."
            },
            testSample: `=== TL Diacritic Input ===
TL: T√¢i-u√¢n sƒ´ chiÃçt-√™ h√≥ s√≥Õò-chƒÅi.
TsiÃçt-hƒÅng tƒÅi-ts√¨ tsin-tsi√†nn h√≥.

POJ: G√≥a √†i lim t√™, i √†i chiaÃçh pnÃÑg.

=== TL/POJ Number Tonemarks ===
TL: Tai5-uan5 si7 chit8-e5 ho2 so2-chai7.
Chit8-hang7 tai7-chi3 chin-chiann3 ho2.

POJ: Goa2 ai3 lim te5, i ai3 chiah8 png7.

=== Syllabic Nasals & Special Cases ===
Nasal: sann, sinn, aÃçhnn
Nasal h-stop: annh‚Üíah‚Åø(always), aNh‚Üíah‚Åø(toggle ON)/aNh(toggle OFF)
Tone 4/8: a4, a8 (no stop), ah4, ah8 (stop)

√∫i √≥o √¥ng mÃÇ «πg nÃÇg
m2 ng5 mh8 ngh8

=== Tone Number Tests (1-9) ===
a1 a2 a3 ah4 a5 a6 a7 ah8 a9
A1 A2 A3 AH4 A5 A6 A7 AH8 A9

=== Settings Toggle Tests ===
1. Nasal Toggle (Â∞æN->‚Åø):
   - annh -> ah‚Åø (Always converted)
   - aNh -> ah‚Åø (Toggle ON) / aNh (Toggle OFF)
   - inh -> ih‚Åø (Toggle ON) / inh (Toggle OFF)

2. Tone 6 Toggle («é vs √°):
   - a6 -> «é (Caron ON) / √° (Acute OFF)
   - ng6 -> nngÃå (Caron ON) / nngÃÅ (Acute OFF)

3. All Caps Toggle:
   - TSUI -> CHUI (Toggle ON) / TSUI (Toggle OFF)
   - TSHUT -> CHHUT (Toggle ON) / TSHUT (Toggle OFF)
   - OO -> OÕò (Toggle ON) / OO (Toggle OFF)

=== Tonemark Position (ua‚Üíoa, ue‚Üíoe) ===
TL tu√† (live) ‚Üí POJ t√≤a
TL ku√© (rice pudding) ‚Üí POJ k√≥e
TL su√≠ (pretty) ‚Üí POJ su√≠
TL u√° (lean) ‚Üí POJ √≤a

=== False Positives (Need Escape to preserved as-is) ===
\\[cats] (cats)
\\[book] (book)
\\[Google] (Google)
\\[Blue] sky (Blue sky)
\\[Singing] (Singing)
\\[Wiki] (Wiki)`
        };

        function initUI() {
            document.getElementById('ui-title').innerText = UI_STRINGS.title;

            // Icons for tabs
            const iconRealtime = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`;
            const iconFile = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>`;

            document.getElementById('ui-tab-realtime').innerHTML = `${iconRealtime} <span>${UI_STRINGS.tabs.realtime}</span>`;
            document.getElementById('ui-tab-file').innerHTML = `${iconFile} <span>${UI_STRINGS.tabs.file}</span>`;

            document.getElementById('ui-label-input').innerText = UI_STRINGS.labels.input;
            document.getElementById('ui-label-output').innerText = UI_STRINGS.labels.output;
            document.getElementById('ui-label-result').innerText = UI_STRINGS.labels.result;

            document.getElementById('ui-btn-paste').innerText = UI_STRINGS.buttons.paste;
            document.getElementById('ui-btn-copy-rt').innerText = UI_STRINGS.buttons.copy;
            document.getElementById('ui-btn-download-rt').innerText = UI_STRINGS.buttons.download;
            document.getElementById('ui-btn-copy-file').innerText = UI_STRINGS.buttons.copy;
            document.getElementById('ui-btn-download-file').innerText = UI_STRINGS.buttons.download;
            document.getElementById('ui-btn-choose-file').innerText = UI_STRINGS.buttons.chooseFile;
            document.getElementById('ui-btn-quick-test').innerText = UI_STRINGS.buttons.quickTest;
            document.getElementById('ui-btn-download-offline-text').innerText = UI_STRINGS.buttons.downloadOffline;
            document.getElementById('ui-btn-clear').innerText = UI_STRINGS.buttons.clear;
            document.getElementById('ui-footer').innerText = UI_STRINGS.footer;

            // Help & Settings
            document.getElementById('ui-header-settings').innerText = UI_STRINGS.settings.headerSettings;
            document.getElementById('ui-lbl-nasal-toggle').innerText = UI_STRINGS.settings.nasalLabel;
            document.getElementById('ui-lbl-tone6-toggle').innerText = UI_STRINGS.settings.tone6Label;
            document.getElementById('ui-lbl-allcaps-toggle').innerText = UI_STRINGS.settings.allCapsLabel;
            document.getElementById('ui-btn-run-test').innerText = UI_STRINGS.settings.btnRunTest;
            document.getElementById('ui-btn-reset-settings').innerText = UI_STRINGS.settings.btnReset;
            document.getElementById('ui-header-help').innerText = UI_STRINGS.settings.headerHelp;
            document.getElementById('ui-header-about').innerText = UI_STRINGS.settings.headerAbout;

            document.getElementById('ui-drop-text').innerText = UI_STRINGS.dropZone.main;

            document.getElementById('rt-input').placeholder = UI_STRINGS.placeholders.input;
            document.getElementById('rt-output').placeholder = UI_STRINGS.placeholders.output;
            document.getElementById('outputPreview').placeholder = UI_STRINGS.placeholders.preview;

            // File upload header
            document.getElementById('ui-file-upload-header').innerText = UI_STRINGS.file.uploadHeader;
            document.getElementById('msg-general-warning').innerText = UI_STRINGS.file.messages.general;

            // CSV Options
            document.getElementById('ui-csv-options-header').innerText = UI_STRINGS.csv.optionsHeader;
            document.getElementById('lbl-select-columns').innerText = UI_STRINGS.csv.selectColumns;
            document.getElementById('lbl-output-mode').innerText = UI_STRINGS.csv.outputMode;
            document.querySelector('.csv-mode-only').innerText = UI_STRINGS.csv.modeOnly;
            document.querySelector('.csv-mode-original-plus').innerText = UI_STRINGS.csv.modeOriginalPlus;
            document.querySelector('.csv-mode-insert').innerText = UI_STRINGS.csv.modeInsert;
            document.getElementById('btn-convert-csv').innerText = UI_STRINGS.csv.btnConvert;
            document.getElementById('btn-reset-csv').innerText = UI_STRINGS.buttons.cancel;

            // JSON Options
            document.getElementById('ui-json-options-header').innerText = UI_STRINGS.json.optionsHeader;
            document.getElementById('lbl-select-keys').innerText = UI_STRINGS.json.selectKeys;
            document.getElementById('lbl-json-output-mode').innerText = UI_STRINGS.json.outputMode;
            document.querySelector('.json-mode-only').innerText = UI_STRINGS.json.modeOnly;
            document.querySelector('.json-mode-original-plus').innerText = UI_STRINGS.json.modeOriginalPlus;
            document.querySelector('.json-mode-insert').innerText = UI_STRINGS.json.modeInsert;
            document.getElementById('btn-convert-json').innerText = UI_STRINGS.json.btnConvert;
            document.getElementById('btn-reset-json').innerText = UI_STRINGS.buttons.cancel;

            // Subtitle Options
            document.getElementById('ui-subtitle-options-header').innerText = UI_STRINGS.subtitle.optionsHeader;
            document.getElementById('lbl-select-lines').innerText = UI_STRINGS.subtitle.selectLines;
            document.querySelector('.subtitle-mode-all').innerText = UI_STRINGS.subtitle.modeAll;
            document.querySelector('.subtitle-mode-line1').innerText = UI_STRINGS.subtitle.modeLine1;
            document.querySelector('.subtitle-mode-line2').innerText = UI_STRINGS.subtitle.modeLine2;
            document.querySelector('.subtitle-mode-line3plus').innerText = UI_STRINGS.subtitle.modeLine3Plus;
            document.getElementById('btn-convert-subtitle').innerText = UI_STRINGS.subtitle.btnConvert;
            document.getElementById('btn-reset-subtitle').innerText = UI_STRINGS.buttons.cancel;

            // Select All / Deselect All buttons
            document.getElementById('btn-csv-select-all').innerText = UI_STRINGS.selectionButtons.selectAll;
            document.getElementById('btn-csv-deselect-all').innerText = UI_STRINGS.selectionButtons.deselectAll;
            document.getElementById('btn-json-select-all').innerText = UI_STRINGS.selectionButtons.selectAll;
            document.getElementById('btn-json-deselect-all').innerText = UI_STRINGS.selectionButtons.deselectAll;

            // Tooltips
            document.getElementById('btn-reset-file').title = UI_STRINGS.tooltips.resetFile;
        }

        document.addEventListener('DOMContentLoaded', initUI);

        // --- Nasal Superscript Toggle (N ‚Üí ‚Åø) ---
        window.TL_USE_NASAL_SUPERSCRIPT = true; // Default ON
        document.getElementById('nasal-superscript-toggle')?.addEventListener('change', (e) => {
            window.TL_USE_NASAL_SUPERSCRIPT = e.target.checked;
            triggerReconversion();
        });

        // --- Tone 6 Caron Flag (default OFF = use acute like tone 2) ---
        window.TL_TONE6_USE_CARON = false; // Set to true for caron («é) instead of acute (√°)
        const tone6Toggle = document.getElementById('tone6-toggle');
        if (tone6Toggle) {
            tone6Toggle.checked = window.TL_TONE6_USE_CARON;
            tone6Toggle.addEventListener('change', (e) => {
                window.TL_TONE6_USE_CARON = e.target.checked;
                triggerReconversion();
            });
        }

        // --- All-Caps Support Flag (default OFF) ---
        window.TL_ALL_CAPS_SUPPORT = true; // Set to true to enable all-caps conversion (OO‚ÜíOÕò, TS‚ÜíCH, etc.)
        const allCapsToggle = document.getElementById('all-caps-toggle');
        if (allCapsToggle) {
            allCapsToggle.checked = window.TL_ALL_CAPS_SUPPORT;
            allCapsToggle.addEventListener('change', (e) => {
                window.TL_ALL_CAPS_SUPPORT = e.target.checked;
                triggerReconversion();
            });
        }

        function triggerReconversion() {
            const rtInput = document.getElementById('rt-input');
            if (rtInput && rtInput.value) {
                document.getElementById('rt-output').value = TLtiau_2_POJtiau(rtInput.value);
            }
        }

        // --- Run UI Test Button ---
        document.getElementById('ui-btn-run-test')?.addEventListener('click', () => {
            const rtInput = document.getElementById('rt-input');
            if (rtInput) {
                rtInput.value = UI_STRINGS.testSample;
                switchMode('realtime');
                rtInput.dispatchEvent(new Event('input')); // Trigger conversion
            }
        });

        // --- Reset Settings Button ---
        document.getElementById('ui-btn-reset-settings')?.addEventListener('click', () => {
            // Apply Defaults
            window.TL_USE_NASAL_SUPERSCRIPT = true;
            window.TL_TONE6_USE_CARON = false;
            window.TL_ALL_CAPS_SUPPORT = true;

            // Update Toggles
            const nasalToggle = document.getElementById('nasal-superscript-toggle');
            if (nasalToggle) nasalToggle.checked = true;

            const tone6Toggle = document.getElementById('tone6-toggle');
            if (tone6Toggle) tone6Toggle.checked = false;

            const allCapsToggle = document.getElementById('all-caps-toggle');
            if (allCapsToggle) allCapsToggle.checked = true;

            // Trigger Reconversion
            triggerReconversion();
        });

        // --- CSV/JSON Select All / Deselect All ---
        document.getElementById('btn-csv-select-all')?.addEventListener('click', () => {
            document.getElementById('csv-columns-list')?.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
        });
        document.getElementById('btn-csv-deselect-all')?.addEventListener('click', () => {
            document.getElementById('csv-columns-list')?.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        });
        document.getElementById('btn-json-select-all')?.addEventListener('click', () => {
            document.getElementById('json-keys-list')?.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
        });
        document.getElementById('btn-json-deselect-all')?.addEventListener('click', () => {
            document.getElementById('json-keys-list')?.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        });

        // --- Converter Logic (Ported from Python) ---

        // Constants for regex tails
        // TL_bue: Syllable endings used for tone mark positioning
        // Updated to include p,t,k,h (entering tone endings) to allow non-standard tone/syllable combinations (e.g., √≠k -> √©k)
        const TL_bue = '((?:rm|rng|rn|r|m|ng|n|nnh|nn|‚Åø|N)?)';

        // Helper to escape regex special characters in a string
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Helper to create replacement regex from TL vowel + optional trailing consonants
        // Matches the Python RC_ function: vowel + optional tail chars
        function createRC(char) {
            // Matches vowel followed by optional consonant-like chars (for tone number placement)
            return new RegExp(char + '([aAeEgGhHiIkKmMnNoOpPtTuU]*)', 'g');
        }

        // Helper for RC1 (tailo[:-1] + TL_bue + tailo[-1])
        function createRC1(tailo) {
            const prefix = tailo.slice(0, -1);
            const lastChar = tailo.slice(-1);
            return new RegExp(prefix + TL_bue + lastChar, 'g');
        }

        // Helper for RC2 (tailo[0] + '(u|i)((?:N|‚Åø|nn)?)' + tailo[1])
        function createRC2(tailo) {
            return new RegExp(tailo[0] + '(u|i)((?:N|‚Åø|nn)?)' + tailo[1], 'g');
        }

        // Helper for RC3 (simple)
        function createRC3(tailo) {
            // Python regexes had re.A (ASCII only) but here we trust the input range or JS regex default
            // We ensure we match exact sequences. 
            // Note: Python's re.sub matches literal strings if not regex. 
            // But here we are building regexes. 
            return new RegExp(tailo, 'g');
        }

        function createRC3_Regex(pattern) {
            return new RegExp(pattern, 'g');
        }

        // Helper for RC4
        function createRC4(tailo) {
            const prefix = tailo.slice(0, -1);
            const lastChar = tailo.slice(-1);
            return new RegExp(prefix + '(h(?:N|‚Åø|nn)?|H(?:N|‚Åø|nn)?|p|P|t|T|k|K)' + lastChar + '?', 'g');
        }

        // Helper for RC8
        function createRC8(tailo) {
            const prefix = tailo.slice(0, -1);
            const lastChar = tailo.slice(-1);
            return new RegExp(prefix + '(h(?:N|‚Åø|nn)?|H(?:N|‚Åø|nn)?|p|P|t|T|k|K)' + lastChar, 'g');
        }

        // 1. TL Tone Marks -> TL Numbers
        function TLtiau_2_TLsoo(tl_tiau, nasal = 'nn', use14 = false) {
            let tl_soo = tl_tiau;
            if (!tl_soo) return '';

            // Mapping table (regex, replacement string)
            // Note: In JS replacement string, $1 refers to capture group 1.

            const TL_T2S = [
                { r: createRC('√°'), s: 'a$12' }, { r: createRC('√Å'), s: 'A$12' },
                { r: createRC('√†'), s: 'a$13' }, { r: createRC('√Ä'), s: 'A$13' },
                { r: createRC('√¢'), s: 'a$15' }, { r: createRC('√Ç'), s: 'A$15' },
                { r: createRC('«é'), s: 'a$16' }, { r: createRC('«ç'), s: 'A$16' },
                { r: createRC('ƒÅ'), s: 'a$17' }, { r: createRC('ƒÄ'), s: 'A$17' },
                { r: createRC('aÃç'), s: 'a$18' }, { r: createRC('AÃç'), s: 'A$18' },
                { r: createRC('aÃã'), s: 'a$19' }, { r: createRC('AÃã'), s: 'A$19' },
                { r: createRC('√©'), s: 'e$12' }, { r: createRC('√â'), s: 'E$12' },
                { r: createRC('√®'), s: 'e$13' }, { r: createRC('√à'), s: 'E$13' },
                { r: createRC('√™'), s: 'e$15' }, { r: createRC('√ä'), s: 'E$15' },
                { r: createRC('ƒõ'), s: 'e$16' }, { r: createRC('ƒö'), s: 'E$16' },
                { r: createRC('ƒì'), s: 'e$17' }, { r: createRC('ƒí'), s: 'E$17' },
                { r: createRC('eÃç'), s: 'e$18' }, { r: createRC('EÃç'), s: 'E$18' },
                { r: createRC('eÃã'), s: 'e$19' }, { r: createRC('EÃã'), s: 'E$19' },
                { r: createRC('√≠'), s: 'i$12' }, { r: createRC('√ç'), s: 'I$12' },
                { r: createRC('√¨'), s: 'i$13' }, { r: createRC('√å'), s: 'I$13' },
                { r: createRC('√Æ'), s: 'i$15' }, { r: createRC('√é'), s: 'I$15' },
                { r: createRC('«ê'), s: 'i$16' }, { r: createRC('«è'), s: 'I$16' },
                { r: createRC('ƒ´'), s: 'i$17' }, { r: createRC('ƒ™'), s: 'I$17' },
                { r: createRC('iÃç'), s: 'i$18' }, { r: createRC('IÃç'), s: 'I$18' },
                { r: createRC('iÃã'), s: 'i$19' }, { r: createRC('IÃã'), s: 'I$19' },
                // oo chars - specific casing
                { r: createRC('√≥Õò'), s: 'oo$12' }, { r: createRC('√ìÕò'), s: 'Oo$12' },
                { r: createRC('√≤Õò'), s: 'oo$13' }, { r: createRC('√íÕò'), s: 'Oo$13' },
                { r: createRC('√¥Õò'), s: 'oo$15' }, { r: createRC('√îÕò'), s: 'Oo$15' },
                { r: createRC('«íÕò'), s: 'oo$16' }, { r: createRC('«ëÕò'), s: 'Oo$16' },
                { r: createRC('≈çÕò'), s: 'oo$17' }, { r: createRC('≈åÕò'), s: 'Oo$17' },
                { r: createRC('oÃçÕò'), s: 'oo$18' }, { r: createRC('OÃçÕò'), s: 'Oo$18' },
                { r: createRC('≈ëÕò'), s: 'oo$19' }, { r: createRC('≈êÕò'), s: 'Oo$19' },
                // straight o
                { r: createRC('√≥'), s: 'o$12' }, { r: createRC('√ì'), s: 'O$12' },
                { r: createRC('√≤'), s: 'o$13' }, { r: createRC('√í'), s: 'O$13' },
                { r: createRC('√¥'), s: 'o$15' }, { r: createRC('√î'), s: 'O$15' },
                { r: createRC('«í'), s: 'o$16' }, { r: createRC('«ë'), s: 'O$16' },
                { r: createRC('≈ç'), s: 'o$17' }, { r: createRC('≈å'), s: 'O$17' },
                { r: createRC('oÃç'), s: 'o$18' }, { r: createRC('OÃç'), s: 'O$18' },
                { r: createRC('≈ë'), s: 'o$19' }, { r: createRC('≈ê'), s: 'O$19' },
                // u
                { r: createRC('√∫'), s: 'u$12' }, { r: createRC('√ö'), s: 'U$12' },
                { r: createRC('√π'), s: 'u$13' }, { r: createRC('√ô'), s: 'U$13' },
                { r: createRC('√ª'), s: 'u$15' }, { r: createRC('√õ'), s: 'U$15' },
                { r: createRC('«î'), s: 'u$16' }, { r: createRC('«ì'), s: 'U$16' },
                { r: createRC('≈´'), s: 'u$17' }, { r: createRC('≈™'), s: 'U$17' },
                { r: createRC('uÃç'), s: 'u$18' }, { r: createRC('UÃç'), s: 'U$18' },
                { r: createRC('≈±'), s: 'u$19' }, { r: createRC('≈∞'), s: 'U$19' },
                // m
                { r: createRC('·∏ø'), s: 'm$12' }, { r: createRC('·∏æ'), s: 'M$12' },
                { r: createRC('mÃÄ'), s: 'm$13' }, { r: createRC('MÃÄ'), s: 'M$13' },
                { r: createRC('mÃÇ'), s: 'm$15' }, { r: createRC('MÃÇ'), s: 'M$15' },
                { r: createRC('mÃå'), s: 'm$16' }, { r: createRC('MÃå'), s: 'M$16' },
                { r: createRC('mÃÑ'), s: 'm$17' }, { r: createRC('MÃÑ'), s: 'M$17' },
                { r: createRC('mÃç'), s: 'm$18' }, { r: createRC('MÃç'), s: 'M$18' },
                { r: createRC('mÃã'), s: 'm$19' }, { r: createRC('MÃã'), s: 'M$19' },
                // n
                { r: createRC('≈Ñ'), s: 'n$12' }, { r: createRC('≈É'), s: 'N$12' },
                { r: createRC('«π'), s: 'n$13' }, { r: createRC('«∏'), s: 'N$13' },
                { r: createRC('nÃÇ'), s: 'n$15' }, { r: createRC('NÃÇ'), s: 'N$15' },
                { r: createRC('≈à'), s: 'n$16' }, { r: createRC('NÃã'), s: 'N$16' },
                { r: createRC('nÃÑ'), s: 'n$17' }, { r: createRC('NÃÑ'), s: 'N$17' },
                { r: createRC('nÃç'), s: 'n$18' }, { r: createRC('NÃç'), s: 'N$18' },
                { r: createRC('nÃã'), s: 'n$19' }, { r: createRC('NÃã'), s: 'N$19' }
            ];

            for (const map of TL_T2S) {
                tl_soo = tl_soo.replace(map.r, map.s);
            }

            // Handle plain oÕò (no tone mark) -> oo. Must come after toned oÕò conversions.
            tl_soo = tl_soo.replace(/oÕò/g, 'oo');
            tl_soo = tl_soo.replace(/OÕò/g, 'Oo');

            tl_soo = tl_soo.replace(/‚Åø/g, 'nn');

            if (nasal === 'N') {
                tl_soo = tl_soo.replace(/(?<=[aeiouAEIOU])nn/g, 'N'); // Lookbehind support in modern JS
            }

            if (use14) {
                const add1 = /(a|A|e|E|i|I|o|O|u|U|m|M|ng|Ng|n)\b/g;
                const add4 = /(h|H|p|P|t|T|k|K)\b/g;
                tl_soo = tl_soo.replace(add1, '$11');
                tl_soo = tl_soo.replace(add4, '$14');
            }

            return tl_soo;
        }

        // 2. TL Numbers -> POJ Numbers
        function TLsoo_2_POJsoo(tailo_soo, keep14 = false) {
            if (!tailo_soo) return '';

            let poj_soo = tailo_soo;

            if (!keep14) {
                const remove1 = /([aeiouAEIOU](?:nn|N)?|[aeiouAEIOU](?:ng|n|m)|(?:p|P|ph|Ph|m|M|b|B|t|T|th|Th|n|N|l|L|k|K|kh|Kh|ng|Ng|g|G|s|S|h|H)?(?:ng|Ng|m|M))1/g;
                poj_soo = poj_soo.replace(remove1, '$1');

                const remove4 = /([aeiouAEIOU](?:(?:nn|N)?(?:h|H)|p|P|t|T|k|K)|(?:m|M|ng|Ng)(?:h|H))4/g;
                poj_soo = poj_soo.replace(remove4, '$1');
            }

            // String replacements
            const tailo2poj = [
                ['oonn', 'oÕòN'], ['Oonn', 'OÕòN'],
                ['onn', 'oÕòN'], ['Onn', 'OÕòN'],
                ['ts', 'ch'], ['Ts', 'Ch'],
                ['oo', 'oÕò'], ['Oo', 'OÕò'],
                ['ua', 'oa'], ['Ua', 'Oa'], ['ue', 'oe'], ['Ue', 'Oe'],
                ['ing', 'eng'], ['Ing', 'Eng'], ['ik', 'ek'], ['Ik', 'Ek'],
                // nnh ‚Üí hnn (will always convert to h‚Åø via nn rule)
                // Nh is NOT converted here - handled in POJsoo_2_POJtiau (toggle-dependent)
                ['nnh', 'hnn']
            ];
            // Add all-caps variants if flag enabled
            if (window.TL_ALL_CAPS_SUPPORT) {
                tailo2poj.push(
                    ['OONN', 'OÕòN'], ['ONN', 'OÕòN'],
                    ['TS', 'CH'], ['OO', 'OÕò'],
                    ['UA', 'OA'], ['UE', 'OE'],
                    ['ING', 'ENG'], ['IK', 'EK'],
                    ['NNH', 'HNN']
                );
            }

            for (const [k, v] of tailo2poj) {
                poj_soo = poj_soo.replace(new RegExp(k, 'g'), v); // Use regex for global replace
            }

            // Only normalize N patterns, don't convert nn to N here
            // nn will be handled in POJsoo_2_POJtiau (always converts to ‚Åø)
            // N will be handled in POJsoo_2_POJtiau (toggle-dependent)

            return poj_soo;
        }

        // 3. POJ Numbers -> POJ Tone Marks
        function POJsoo_2_POJtiau(poj_soo) {
            if (!poj_soo) return '';
            let poj_tiau = poj_soo;

            // Nasal superscript conversion:
            // - nn at syllable tail (after vowel or vowel+h or m+h): ALWAYS convert to ‚Åø
            // - N at syllable tail (after vowel or vowel+h or m+h): Only convert when toggle is ON
            // - Standalone nn/N (not after valid pattern): Preserve as-is
            // Patterns: vowel+nn, vowel+h+nn, m+h+nn (and same for N)
            const nn_to_superscript = /([aeiouAEIOUmM]h?|[aeiouAEIOU])nn(\d?)\b/g;
            poj_tiau = poj_tiau.replace(nn_to_superscript, '$1‚Åø$2');

            const useNasalSuperscript = typeof window !== 'undefined' &&
                window.TL_USE_NASAL_SUPERSCRIPT !== false;
            if (useNasalSuperscript) {
                const N_to_superscript = /([aeiouAEIOUmM]h?|[aeiouAEIOU])N(\d?)\b/g;
                poj_tiau = poj_tiau.replace(N_to_superscript, '$1‚Åø$2');
                // Also handle Nh pattern (reorder and convert): aNh ‚Üí ah‚Åø
                const Nh_to_superscript = /([aeiouAEIOUmM])Nh?(\d?)\b/g;
                poj_tiau = poj_tiau.replace(Nh_to_superscript, '$1h‚Åø$2');
            }

            // Tone 6 character selection: caron («é) or acute (√°) like tone 2
            // Default is false = use acute (same as tone 2)
            const useTone6Caron = typeof window !== 'undefined' &&
                window.TL_TONE6_USE_CARON === true;
            const t6 = useTone6Caron
                ? { a: '«é', A: '«ç', e: 'ƒõ', E: 'ƒö', i: '«ê', I: '«è', o: '«í', O: '«ë', u: '«î', U: '«ì', 'oÕò': '«íÕò', 'OÕò': '«ëÕò', m: 'mÃå', M: 'MÃå', n: '≈à', N: '≈á' }
                : { a: '√°', A: '√Å', e: '√©', E: '√â', i: '√≠', I: '√ç', o: '√≥', O: '√ì', u: '√∫', U: '√ö', 'oÕò': '√≥Õò', 'OÕò': '√ìÕò', m: '·∏ø', M: '·∏æ', n: '≈Ñ', N: '≈É' };

            // Mapping
            const POJ_S2T = [
                // use RC2
                { r: createRC2('a1'), s: 'a$1$2' }, { r: createRC2('A1'), s: 'A$1$2' },
                { r: createRC2('a2'), s: '√°$1$2' }, { r: createRC2('A2'), s: '√Å$1$2' },
                { r: createRC2('a3'), s: '√†$1$2' }, { r: createRC2('A3'), s: '√Ä$1$2' },
                // use RC3
                { r: createRC3_Regex('a(i|u)((?:N|‚Åø|nn)?)h4'), s: 'a$1$2h' },
                { r: createRC3_Regex('A(i|u)((?:N|‚Åø|nn)?)h4'), s: 'A$1$2h' },
                // use RC2
                { r: createRC2('a5'), s: '√¢$1$2' }, { r: createRC2('A5'), s: '√Ç$1$2' },
                { r: createRC2('a6'), s: t6.a + '$1$2' }, { r: createRC2('A6'), s: t6.A + '$1$2' },
                { r: createRC2('a7'), s: 'ƒÅ$1$2' }, { r: createRC2('A7'), s: 'ƒÄ$1$2' },
                // use RC3
                { r: createRC3_Regex('a(i|u)h(?:N|‚Åø|nn)8'), s: 'aÃç$1h‚Åø' },
                { r: createRC3_Regex('A(i|u)h(?:N|‚Åø|nn)8'), s: 'AÃç$1h‚Åø' },
                { r: createRC3_Regex('a(i|u)h8'), s: 'aÃç$1h' },
                { r: createRC3_Regex('A(i|u)h8'), s: 'AÃç$1h' },
                // use RC2
                { r: createRC2('a9'), s: 'ƒÉ$1$2' }, { r: createRC2('A9'), s: 'ƒÇ$1$2' },

                // use RC2
                { r: createRC2('u1'), s: 'u$1$2' }, { r: createRC2('U1'), s: 'U$1$2' },
                { r: createRC2('u2'), s: '√∫$1$2' }, { r: createRC2('U2'), s: '√ö$1$2' },
                { r: createRC2('u3'), s: '√π$1$2' }, { r: createRC2('U3'), s: '√ô$1$2' },
                // use RC3
                { r: createRC3_Regex('uih((?:N|‚Åø|nn)?)4'), s: 'uih$1' },
                { r: createRC3_Regex('Uih((?:N|‚Åø|nn)?)4'), s: 'Uih$1' },
                // use RC2
                { r: createRC2('u5'), s: '√ª$1$2' }, { r: createRC2('U5'), s: '√õ$1$2' },
                { r: createRC2('u6'), s: t6.u + '$1$2' }, { r: createRC2('U6'), s: t6.U + '$1$2' },
                { r: createRC2('u7'), s: '≈´$1$2' }, { r: createRC2('U7'), s: '≈™$1$2' },
                // use RC3
                { r: createRC3_Regex('uih((?:N|‚Åø|nn)?)8'), s: 'uÃçih$1' },
                { r: createRC3_Regex('Uih((?:N|‚Åø|nn)?)8'), s: 'UÃçih$1' },
                // use RC2
                { r: createRC2('u9'), s: '≈≠$1$2' }, { r: createRC2('U9'), s: '≈¨$1$2' },

                // use RC3 - Complex O/o handling (oa, oe diphthongs)
                { r: createRC3_Regex('(o|O)([ae])((?:N|‚Åø|nn)?)1?\\b'), s: '$1$2$3' },
                { r: createRC3_Regex('o([ae])((?:N|‚Åø|nn)?)2\\b'), s: '√≥$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|‚Åø|nn)?)2\\b'), s: '√ì$1$2' },
                { r: createRC3_Regex('o([ae])((?:N|‚Åø|nn)?)3\\b'), s: '√≤$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|‚Åø|nn)?)3\\b'), s: '√í$1$2' },
                { r: createRC3_Regex('o([ae])((?:N|‚Åø|nn)?)5\\b'), s: '√¥$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|‚Åø|nn)?)5\\b'), s: '√î$1$2' },
                { r: createRC3_Regex('o([ae])((?:N|‚Åø|nn)?)6\\b'), s: t6.o + '$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|‚Åø|nn)?)6\\b'), s: t6.O + '$1$2' },
                { r: createRC3_Regex('o([ae])((?:N|‚Åø|nn)?)7\\b'), s: '≈ç$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|‚Åø|nn)?)7\\b'), s: '≈å$1$2' },
                { r: createRC3_Regex('o([ae])((?:N|‚Åø|nn)?)9\\b'), s: '≈è$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|‚Åø|nn)?)9\\b'), s: '≈é$1$2' },

                // use RC1
                { r: createRC1('a1'), s: 'a$1' }, { r: createRC1('A1'), s: 'A$1' },
                { r: createRC1('a2'), s: '√°$1' }, { r: createRC1('A2'), s: '√Å$1' },
                { r: createRC1('a3'), s: '√†$1' }, { r: createRC1('A3'), s: '√Ä$1' },
                { r: createRC4('a4'), s: 'a$1' }, { r: createRC4('A4'), s: 'A$1' },
                { r: createRC1('a5'), s: '√¢$1' }, { r: createRC1('A5'), s: '√Ç$1' },
                { r: createRC1('a6'), s: t6.a + '$1' }, { r: createRC1('A6'), s: t6.A + '$1' },
                { r: createRC1('a7'), s: 'ƒÅ$1' }, { r: createRC1('A7'), s: 'ƒÄ$1' },
                { r: createRC8('a8'), s: 'aÃç$1' }, { r: createRC8('A8'), s: 'AÃç$1' },
                { r: createRC1('a9'), s: 'ƒÉ$1' }, { r: createRC1('A9'), s: 'ƒÇ$1' },

                { r: createRC1('e1'), s: 'e$1' }, { r: createRC1('E1'), s: 'E$1' },
                { r: createRC1('e2'), s: '√©$1' }, { r: createRC1('E2'), s: '√â$1' },
                { r: createRC1('e3'), s: '√®$1' }, { r: createRC1('E3'), s: '√à$1' },
                { r: createRC4('e4'), s: 'e$1' }, { r: createRC4('E4'), s: 'E$1' },
                { r: createRC1('e5'), s: '√™$1' }, { r: createRC1('E5'), s: '√ä$1' },
                { r: createRC1('e6'), s: t6.e + '$1' }, { r: createRC1('E6'), s: t6.E + '$1' },
                { r: createRC1('e7'), s: 'ƒì$1' }, { r: createRC1('E7'), s: 'ƒí$1' },
                { r: createRC8('e8'), s: 'eÃç$1' }, { r: createRC8('E8'), s: 'EÃç$1' },
                { r: createRC1('e9'), s: 'ƒï$1' }, { r: createRC1('E9'), s: 'ƒî$1' },

                { r: createRC1('i1'), s: 'i$1' }, { r: createRC1('I1'), s: 'I$1' },
                { r: createRC1('i2'), s: '√≠$1' }, { r: createRC1('I2'), s: '√ç$1' },
                { r: createRC1('i3'), s: '√¨$1' }, { r: createRC1('I3'), s: '√å$1' },
                { r: createRC4('i4'), s: 'i$1' }, { r: createRC4('I4'), s: 'I$1' },
                { r: createRC1('i5'), s: '√Æ$1' }, { r: createRC1('I5'), s: '√é$1' },
                { r: createRC1('i6'), s: t6.i + '$1' }, { r: createRC1('I6'), s: t6.I + '$1' },
                { r: createRC1('i7'), s: 'ƒ´$1' }, { r: createRC1('I7'), s: 'ƒ™$1' },
                { r: createRC8('i8'), s: 'iÃç$1' }, { r: createRC8('I8'), s: 'IÃç$1' },
                { r: createRC1('i9'), s: 'ƒ≠$1' }, { r: createRC1('I9'), s: 'ƒ¨$1' },

                // oÕò handling
                { r: createRC1('oÕò1'), s: 'oÕò$1' }, { r: createRC1('OÕò1'), s: 'OÕò$1' },
                { r: createRC1('oÕò2'), s: '√≥Õò$1' }, { r: createRC1('OÕò2'), s: '√ìÕò$1' },
                { r: createRC1('oÕò3'), s: '√≤Õò$1' }, { r: createRC1('OÕò3'), s: '√íÕò$1' },
                { r: createRC4('oÕò4'), s: 'oÕò$1' }, { r: createRC4('OÕò4'), s: 'OÕò$1' },
                { r: createRC1('oÕò5'), s: '√¥Õò$1' }, { r: createRC1('OÕò5'), s: '√îÕò$1' },
                { r: createRC1('oÕò6'), s: t6['oÕò'] + '$1' }, { r: createRC1('OÕò6'), s: t6['OÕò'] + '$1' },
                { r: createRC1('oÕò7'), s: '≈çÕò$1' }, { r: createRC1('OÕò7'), s: '≈åÕò$1' },
                { r: createRC8('oÕò8'), s: 'oÃçÕò$1' }, { r: createRC8('OÕò8'), s: 'OÃçÕò$1' },
                { r: createRC1('oÕò9'), s: '≈èÕò$1' }, { r: createRC1('OÕò9'), s: '≈éÕò$1' },

                { r: createRC1('o1'), s: 'o$1' }, { r: createRC1('O1'), s: 'O$1' },
                { r: createRC1('o2'), s: '√≥$1' }, { r: createRC1('O2'), s: '√ì$1' },
                { r: createRC1('o3'), s: '√≤$1' }, { r: createRC1('O3'), s: '√í$1' },
                { r: createRC4('o4'), s: 'o$1' }, { r: createRC4('O4'), s: 'O$1' },
                { r: createRC1('o5'), s: '√¥$1' }, { r: createRC1('O5'), s: '√î$1' },
                { r: createRC1('o6'), s: t6.o + '$1' }, { r: createRC1('O6'), s: t6.O + '$1' },
                { r: createRC1('o7'), s: '≈ç$1' }, { r: createRC1('O7'), s: '≈å$1' },
                { r: createRC8('o8'), s: 'oÃç$1' }, { r: createRC8('O8'), s: 'OÃç$1' },
                { r: createRC1('o9'), s: '≈è$1' }, { r: createRC1('O9'), s: '≈é$1' },

                { r: createRC1('u1'), s: 'u$1' }, { r: createRC1('U1'), s: 'U$1' },
                { r: createRC1('u2'), s: '√∫$1' }, { r: createRC1('U2'), s: '√ö$1' },
                { r: createRC1('u3'), s: '√π$1' }, { r: createRC1('U3'), s: '√ô$1' },
                { r: createRC4('u4'), s: 'u$1' }, { r: createRC4('U4'), s: 'U$1' },
                { r: createRC1('u5'), s: '√ª$1' }, { r: createRC1('U5'), s: '√õ$1' },
                { r: createRC1('u6'), s: t6.u + '$1' }, { r: createRC1('U6'), s: t6.U + '$1' },
                { r: createRC1('u7'), s: '≈´$1' }, { r: createRC1('U7'), s: '≈™$1' },
                { r: createRC8('u8'), s: 'uÃç$1' }, { r: createRC8('U8'), s: 'UÃç$1' },
                { r: createRC1('u9'), s: '≈≠$1' }, { r: createRC1('U9'), s: '≈¨$1' },

                // use RC3 mappings
                { r: createRC3_Regex('m1'), s: 'm' }, { r: createRC3_Regex('M1'), s: 'M' },
                { r: createRC3_Regex('m2'), s: '·∏ø' }, { r: createRC3_Regex('M2'), s: '·∏æ' },
                { r: createRC3_Regex('m3'), s: 'mÃÄ' }, { r: createRC3_Regex('M3'), s: 'MÃÄ' },
                { r: createRC3_Regex('mh4'), s: 'mh' }, { r: createRC3_Regex('Mh4'), s: 'Mh' },
                { r: createRC3_Regex('m5'), s: 'mÃÇ' }, { r: createRC3_Regex('M5'), s: 'MÃÇ' },
                { r: createRC3_Regex('m6'), s: t6.m }, { r: createRC3_Regex('M6'), s: t6.M },
                { r: createRC3_Regex('m7'), s: 'mÃÑ' }, { r: createRC3_Regex('M7'), s: 'MÃÑ' },
                { r: createRC3_Regex('mh8'), s: 'mÃçh' }, { r: createRC3_Regex('Mh8'), s: 'MÃçh' },
                { r: createRC3_Regex('m9'), s: 'mÃÜ' }, { r: createRC3_Regex('M9'), s: 'MÃÜ' },

                { r: createRC3_Regex('ng1'), s: 'ng' }, { r: createRC3_Regex('Ng1'), s: 'Ng' },
                { r: createRC3_Regex('ng2'), s: '≈Ñg' }, { r: createRC3_Regex('Ng2'), s: '≈Ég' },
                { r: createRC3_Regex('ng3'), s: '«πg' }, { r: createRC3_Regex('Ng3'), s: '«∏g' },
                { r: createRC3_Regex('ngh4'), s: 'ngh' }, { r: createRC3_Regex('Ngh4'), s: 'Ngh' },
                { r: createRC3_Regex('ng5'), s: 'nÃÇg' }, { r: createRC3_Regex('Ng5'), s: 'NÃÇg' },
                { r: createRC3_Regex('ng6'), s: t6.n + 'g' }, { r: createRC3_Regex('Ng6'), s: t6.N + 'g' },
                { r: createRC3_Regex('ng7'), s: 'nÃÑg' }, { r: createRC3_Regex('Ng7'), s: 'NÃÑg' },
                { r: createRC3_Regex('ngh8'), s: 'nÃçgh' }, { r: createRC3_Regex('Ngh8'), s: 'NÃçgh' },
                { r: createRC3_Regex('ng9'), s: 'nÃÜg' }, { r: createRC3_Regex('Ng9'), s: 'NÃÜg' }
            ];
            // Add all-caps NG rules if flag enabled
            if (window.TL_ALL_CAPS_SUPPORT) {
                POJ_S2T.push(
                    { r: createRC3_Regex('NG1'), s: 'NG' },
                    { r: createRC3_Regex('NG2'), s: t6.N + 'G' },
                    { r: createRC3_Regex('NG3'), s: '«∏G' },
                    { r: createRC3_Regex('NGH4'), s: 'NGH' },
                    { r: createRC3_Regex('NG5'), s: 'NÃÇG' },
                    { r: createRC3_Regex('NG6'), s: t6.N + 'G' },
                    { r: createRC3_Regex('NG7'), s: 'NÃÑG' },
                    { r: createRC3_Regex('NGH8'), s: 'NÃçGH' },
                    { r: createRC3_Regex('NG9'), s: 'NÃÜG' }
                );
            }

            for (const map of POJ_S2T) {
                poj_tiau = poj_tiau.replace(map.r, map.s);
            }

            return poj_tiau;
        }

        function TLtiau_2_POJtiau(tl_tiau) {
            // 0. Handle escape sequences: \[text] is preserved as-is
            const escapeRegex = /\\\[([^\]]*)\]/g;
            const escapes = [];
            let processedInput = tl_tiau.replace(escapeRegex, (match, content) => {
                escapes.push(content);
                return `‚ü™ESC${escapes.length - 1}‚ü´`;
            });

            // 1. Convert TL-style tone marks to corresponding numbers
            const tl_soo = TLtiau_2_TLsoo(processedInput);
            // 2. Convert TL number-style to POJ number-style
            const poj_soo = TLsoo_2_POJsoo(tl_soo);
            // 3. Convert POJ number-style to POJ tone marks
            let poj_tiau = POJsoo_2_POJtiau(poj_soo);

            // 4. Restore escaped content
            poj_tiau = poj_tiau.replace(/‚ü™ESC(\d+)‚ü´/g, (match, index) => {
                return escapes[parseInt(index)];
            });

            return poj_tiau;
        }

        // --- UI Logic ---

        function clearInput(id) {
            const el = document.getElementById(id);
            el.value = '';
            el.dispatchEvent(new Event('input'));
        }

        async function downloadCleanVersion() {
            if (!confirm(UI_STRINGS.messages.downloadConfirm)) {
                return;
            }

            try {
                const btn = document.getElementById('ui-btn-download-offline');
                const originalText = btn.innerText;
                btn.innerText = UI_STRINGS.messages.downloading;
                btn.disabled = true;

                const res = await fetch('https://raw.githubusercontent.com/CyberOoHim/CyberOoHim.github.io/main/pages/tl_poj_converter.html');
                let text = await res.text();

                // Strip Jekyll front matter (---...---) and the HTML comment after it
                text = text.replace(/^---[\s\S]*?---\n/, '');
                text = text.replace(/^< !--[\s\S ]*?- ->\n/, '');
                text = text.trim();

                const blob = new Blob([text], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tl_poj_converter.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                btn.innerText = originalText;
                btn.disabled = false;
            } catch (err) {
                alert(UI_STRINGS.messages.downloadFailed);
            }
        }

        function injectTestText() {
            const rtInput = document.getElementById('rt-input');
            rtInput.value = UI_STRINGS.testSample;
            rtInput.dispatchEvent(new Event('input'));
        }

        function switchMode(mode) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

            document.getElementById(`ui-tab-${mode}`).classList.add('active');
            document.getElementById(`panel-${mode}`).classList.add('active');
        }

        // Real-time conversion
        const rtInput = document.getElementById('rt-input');
        const rtOutput = document.getElementById('rt-output');

        rtInput.addEventListener('input', (e) => {
            const text = e.target.value;
            const converted = TLtiau_2_POJtiau(text);
            rtOutput.value = converted;
        });

        // File conversion - State variables
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const outputPreview = document.getElementById('outputPreview');
        const fileOutputSection = document.getElementById('fileOutputSection');
        const btnChooseFile = document.getElementById('btn-choose-file');

        let currentFileOutput = '';
        let currentFileName = 'poj_output.txt';

        // CSV State
        let currentCsvData = null;
        let currentCsvSeparator = ',';
        const csvColumnsList = document.getElementById('csv-columns-list');

        // JSON State
        let currentJsonData = null;
        let currentJsonRawContent = '';
        let currentJsonPaths = [];
        let currentJsonIsArray = false;

        // Subtitle State
        let currentSubtitleData = null;
        let currentSubtitleRawContent = '';
        let currentSubtitleExt = 'srt';

        // Event Listeners
        btnChooseFile.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
        });
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) processFile(e.target.files[0]);
        });

        // Reset View
        function resetFileView() {
            const expander = document.getElementById('file-upload-expander');
            if (expander) expander.open = true;
            document.getElementById('csv-options-expander').style.display = 'none';
            document.getElementById('json-options-expander').style.display = 'none';
            document.getElementById('subtitle-options-expander').style.display = 'none';
            fileOutputSection.style.display = 'none';
            document.getElementById('csv-preview-table-container').style.display = 'none';
            outputPreview.style.display = 'block';
            currentCsvData = null;
            currentJsonData = null;
            currentJsonPaths = [];
            currentSubtitleData = null;
            fileInput.value = '';
            currentFileOutput = '';
        }

        // Helper: Dynamically load a script
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Reset button handlers
        document.getElementById('btn-reset-csv').addEventListener('click', resetFileView);
        document.getElementById('btn-reset-json').addEventListener('click', resetFileView);
        document.getElementById('btn-reset-subtitle').addEventListener('click', resetFileView);
        document.getElementById('btn-reset-file').addEventListener('click', resetFileView);

        // Copy/Download for file output
        document.getElementById('btn-copy-file').addEventListener('click', async () => {
            if (currentFileOutput) {
                await navigator.clipboard.writeText(currentFileOutput);
                const btn = document.getElementById('ui-btn-copy-file');
                const original = btn.innerText;
                btn.innerText = UI_STRINGS.buttons.copied;
                setTimeout(() => btn.innerText = original, 2000);
            }
        });

        document.getElementById('btn-download-file').addEventListener('click', () => {
            if (currentFileOutput) {
                downloadTextContent(currentFileOutput, currentFileName);
            }
        });

        // Helper: Download text content
        function downloadTextContent(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Helper: Update preview label with file type
        function updatePreviewLabel(type) {
            const label = document.getElementById('ui-label-result');
            if (label && UI_STRINGS.file.fileTypes[type]) {
                label.innerText = UI_STRINGS.file.previewLabel + UI_STRINGS.file.fileTypes[type];
            } else if (label) {
                label.innerText = UI_STRINGS.file.previewLabel + UI_STRINGS.file.fileTypes.text;
            }

            // Toggle specific messages
            const msgSpecific = document.getElementById('msg-specific-warning');
            if (msgSpecific) {
                if (type === 'pdf') {
                    msgSpecific.innerText = ' ' + UI_STRINGS.file.messages.pdf;
                    msgSpecific.style.display = 'inline';
                } else {
                    msgSpecific.style.display = 'none';
                }
            }
        }

        // Parse CSV/TSV
        function parseCSV(text, separator) {
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length === 0) return null;

            const headers = lines[0].split(separator).map(h => h.trim());
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(separator);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((h, index) => {
                        row[h] = values[index];
                    });
                    rows.push(row);
                }
            }
            return { headers, rows, rawLines: lines };
        }

        // Generate CSV
        function generateCSV(headers, rows, separator) {
            const headerLine = headers.join(separator);
            const dataLines = rows.map(row => {
                return headers.map(h => row[h] || '').join(separator);
            }).join('\n');
            return headerLine + '\n' + dataLines;
        }

        // Run tests on load if enabled
        const ENABLE_SELF_TEST = false;
        if (ENABLE_SELF_TEST) {
            runTests();
        }

        // Render Table
        function renderTable(headers, rows) {
            const table = document.createElement('table');
            table.id = 'csv-preview-table';

            const thead = document.createElement('thead');
            const trHead = document.createElement('tr');
            headers.forEach(h => {
                const th = document.createElement('th');
                th.textContent = h;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            rows.slice(0, 100).forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(h => {
                    const td = document.createElement('td');
                    td.textContent = row[h];
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            return table;
        }

        // Extract JSON Keys
        function extractJsonKeys(obj) {
            const keys = [];

            if (Array.isArray(obj) && obj.length > 0 && typeof obj[0] === 'object' && obj[0] !== null) {
                currentJsonIsArray = true;
                const schemaKeys = Object.keys(obj[0]);
                schemaKeys.forEach(key => {
                    if (typeof obj[0][key] === 'string') {
                        const count = obj.filter(item => typeof item[key] === 'string').length;
                        keys.push({
                            key: key,
                            isArrayKey: true,
                            sampleValue: obj[0][key],
                            count: count
                        });
                    }
                });
            } else if (typeof obj === 'object' && obj !== null) {
                currentJsonIsArray = false;
                function traverse(current, path) {
                    if (typeof current === 'string') {
                        keys.push({
                            key: path,
                            isArrayKey: false,
                            sampleValue: current,
                            count: 1
                        });
                    } else if (Array.isArray(current)) {
                        current.forEach((item, i) => {
                            traverse(item, `${path}[${i}]`);
                        });
                    } else if (current !== null && typeof current === 'object') {
                        Object.keys(current).forEach(k => {
                            const newPath = path ? `${path}.${k}` : k;
                            traverse(current[k], newPath);
                        });
                    }
                }
                traverse(obj, '');
            }

            return keys;
        }

        // Set nested value in object
        function setNestedValue(obj, path, value) {
            const parts = path.replace(/\[(\d+)\]/g, '.$1').split('.');
            let current = obj;
            for (let i = 0; i < parts.length - 1; i++) {
                const key = parts[i];
                const nextKey = parts[i + 1];
                if (!(key in current)) {
                    current[key] = /^\d+$/.test(nextKey) ? [] : {};
                }
                current = current[key];
            }
            current[parts[parts.length - 1]] = value;
        }

        // Helper to detect timecode lines (both standard and bracket formats)
        function isTimecode(line) {
            if (!line) return false;
            // Standard SRT/VTT: 00:00:00,000 --> 00:00:00,000
            if (line.includes('-->')) return true;
            // Bracket style: [00:00] or [00:00:00]
            if (/^\s*\[\d{1,2}:\d{2}(?::\d{2})?\]/.test(line)) return true;
            return false;
        }

        // Smart detection for subtitle format in .txt files
        function detectSubtitleFormat(content) {
            const lines = content.split(/\r?\n/).slice(0, 50);

            // VTT header check
            if (lines[0]?.trim().toUpperCase() === 'WEBVTT') return 'vtt';

            // SRT/VTT timecode pattern
            const srtTimecodePattern = /\d{1,2}:\d{2}(?::\d{2})?[,.:]\d{3}\s*-->/;
            const bracketTimecodePattern = /^\s*\[\d{1,2}:\d{2}(?::\d{2})?\]/;

            let bracketCount = 0;
            for (const line of lines) {
                if (srtTimecodePattern.test(line)) return 'srt';
                if (bracketTimecodePattern.test(line)) bracketCount++;
            }

            if (bracketCount >= 3) return 'srt';
            return null;
        }

        // Parse Subtitle (SRT/VTT) with bracket timecode and header support
        function parseSubtitle(content, ext) {
            const lines = content.split(/\r?\n/);
            const blocks = [];
            let i = 0;
            const headerLines = { urlLines: [], titleBlock: null };

            // Parse header section (before first timecode) for URL and TITLE
            while (i < lines.length && !isTimecode(lines[i])) {
                const line = lines[i].trim();
                if (/^url:/i.test(line)) {
                    headerLines.urlLines.push(lines[i]);
                } else if (/^title:/i.test(line)) {
                    const match = lines[i].match(/^(title:\s*)/i);
                    const prefix = match ? match[1] : 'TITLE: ';
                    const firstLineContent = lines[i].substring(prefix.length);
                    const titleTextLines = [];
                    if (firstLineContent.trim() !== '') {
                        titleTextLines.push(firstLineContent);
                    }
                    i++;
                    while (i < lines.length && lines[i].trim() !== '' && !isTimecode(lines[i])) {
                        titleTextLines.push(lines[i]);
                        i++;
                    }
                    headerLines.titleBlock = { prefix, textLines: titleTextLines };
                    continue;
                }
                i++;
            }

            // Parse subtitle blocks
            while (i < lines.length) {
                while (i < lines.length && lines[i].trim() === '') i++;
                if (i >= lines.length) break;

                const block = { cueId: '', timestamp: '', textLines: [], rawLines: [] };

                if (isTimecode(lines[i])) {
                    block.timestamp = lines[i];
                    block.rawLines.push(lines[i]);
                    i++;
                } else {
                    block.cueId = lines[i];
                    block.rawLines.push(lines[i]);
                    i++;

                    if (i < lines.length && isTimecode(lines[i])) {
                        block.timestamp = lines[i];
                        block.rawLines.push(lines[i]);
                        i++;
                    }
                }

                // Text lines until empty line or next timecode
                while (i < lines.length && lines[i].trim() !== '' && !isTimecode(lines[i])) {
                    const line = lines[i];
                    block.rawLines.push(line);
                    block.textLines.push({ text: line, isUrl: false });
                    i++;
                }

                if (block.timestamp || block.textLines.length > 0) {
                    blocks.push(block);
                }
            }

            return { blocks, headerLines };
        }

        // Convert Subtitle based on mode
        function convertSubtitle(parsed, mode) {
            const resultLines = [];

            // Add header lines first
            // URL lines - preserved as-is
            if (parsed.headerLines) {
                parsed.headerLines.urlLines.forEach(line => {
                    resultLines.push(line);
                });

                // TITLE block - apply same line selection rules as subtitle blocks
                if (parsed.headerLines.titleBlock) {
                    const titleBlock = parsed.headerLines.titleBlock;
                    titleBlock.textLines.forEach((lineText, lineIndex) => {
                        const lineNum = lineIndex + 1;
                        let shouldConvert = false;

                        if (mode === 'all') shouldConvert = true;
                        else if (mode === 'line1' && lineNum === 1) shouldConvert = true;
                        else if (mode === 'line2' && lineNum === 2) shouldConvert = true;
                        else if (mode === 'line3plus' && lineNum >= 3) shouldConvert = true;

                        const prefix = lineIndex === 0 ? titleBlock.prefix : '';
                        if (shouldConvert) {
                            resultLines.push(prefix + TLtiau_2_POJtiau(lineText));
                        } else {
                            resultLines.push(prefix + lineText);
                        }
                    });
                }

                // Add blank line after header if there were header lines
                if (parsed.headerLines.urlLines.length > 0 || parsed.headerLines.titleBlock) {
                    resultLines.push('');
                }
            }

            parsed.blocks.forEach(block => {
                if (block.cueId) resultLines.push(block.cueId);
                resultLines.push(block.timestamp);

                block.textLines.forEach((lineObj, lineIndex) => {
                    const lineNum = lineIndex + 1;
                    let shouldConvert = false;

                    if (mode === 'all') shouldConvert = true;
                    else if (mode === 'line1' && lineNum === 1) shouldConvert = true;
                    else if (mode === 'line2' && lineNum === 2) shouldConvert = true;
                    else if (mode === 'line3plus' && lineNum >= 3) shouldConvert = true;

                    if (shouldConvert) {
                        resultLines.push(TLtiau_2_POJtiau(lineObj.text));
                    } else {
                        resultLines.push(lineObj.text);
                    }
                });

                resultLines.push('');
            });

            return resultLines.join('\n');
        }

        // Main File Processor
        function processFile(file) {
            const allowedExtensions = ['.txt', '.md', '.srt', '.vtt', '.csv', '.tsv', '.json', '.pdf'];
            const fileName = file.name.toLowerCase();

            const namePart = file.name.substring(0, file.name.lastIndexOf('.'));
            let extPart = file.name.substring(file.name.lastIndexOf('.'));

            // If PDF, change extension to .txt for the output file
            if (extPart.toLowerCase() === '.pdf') {
                extPart = '.txt';
            }

            currentFileName = `${namePart}_POJ${extPart}`;

            const isValid = allowedExtensions.some(ext => fileName.endsWith(ext));
            if (!isValid) {
                alert(UI_STRINGS.messages.fileTypeError + allowedExtensions.join(', '));
                return;
            }

            const isCsv = fileName.endsWith('.csv') || fileName.endsWith('.tsv');
            const isPdf = fileName.endsWith('.pdf');
            const separator = fileName.endsWith('.tsv') ? '\t' : ',';

            // Handle PDF separately with ArrayBuffer reader
            if (isPdf) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        // Dynamically load PDF.js if not already loaded
                        if (typeof pdfjsLib === 'undefined') {
                            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js');
                            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                        }

                        const pdf = await pdfjsLib.getDocument({ data: e.target.result }).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            // Preserve newlines by checking hasEOL property on each text item
                            // Also add spaces between items to prevent word concatenation
                            let pageText = '';
                            textContent.items.forEach((item, idx) => {
                                pageText += item.str;
                                if (item.hasEOL) {
                                    pageText += '\n';
                                } else if (idx < textContent.items.length - 1) {
                                    pageText += ' ';
                                }
                            });
                            fullText += pageText + '\n';
                        }

                        // Collapse upload expander
                        document.getElementById('file-upload-expander').open = false;
                        document.getElementById('csv-options-expander').style.display = 'none';
                        document.getElementById('json-options-expander').style.display = 'none';
                        document.getElementById('subtitle-options-expander').style.display = 'none';

                        const converted = TLtiau_2_POJtiau(fullText);
                        currentFileOutput = converted;
                        updatePreviewLabel('pdf');
                        document.getElementById('csv-preview-table-container').style.display = 'none';
                        outputPreview.style.display = 'block';
                        outputPreview.value = converted.slice(0, 2000) + (converted.length > 2000 ? UI_STRINGS.messages.truncated : '');
                        fileOutputSection.style.display = 'block';
                    } catch (error) {
                        alert(UI_STRINGS.messages.pdfParseError + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;

                // Collapse upload expander
                document.getElementById('file-upload-expander').open = false;

                if (isCsv) {
                    // CSV/TSV Mode
                    currentCsvSeparator = separator;
                    const parsed = parseCSV(content, separator);
                    if (parsed && parsed.headers.length > 0) {
                        currentCsvData = parsed;

                        updatePreviewLabel(fileName.endsWith('.tsv') ? 'tsv' : 'csv');

                        document.getElementById('csv-options-expander').style.display = 'block';
                        document.getElementById('csv-options-expander').open = true;
                        document.getElementById('json-options-expander').style.display = 'none';
                        document.getElementById('subtitle-options-expander').style.display = 'none';
                        fileOutputSection.style.display = 'none';

                        // Populate columns
                        csvColumnsList.innerHTML = '';
                        parsed.headers.forEach(header => {
                            const div = document.createElement('div');
                            div.style.display = 'flex';
                            div.style.alignItems = 'center';
                            div.style.gap = '0.5rem';

                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.value = header;
                            checkbox.id = `col-${header}`;

                            const label = document.createElement('label');
                            label.htmlFor = `col-${header}`;
                            label.textContent = header;
                            label.style.cursor = 'pointer';

                            div.appendChild(checkbox);
                            div.appendChild(label);
                            csvColumnsList.appendChild(div);
                        });
                    }
                } else if (fileName.endsWith('.json')) {
                    // JSON Mode
                    try {
                        const jsonData = JSON.parse(content);
                        currentJsonData = jsonData;
                        currentJsonRawContent = content;

                        updatePreviewLabel('json');

                        document.getElementById('csv-options-expander').style.display = 'none';
                        document.getElementById('json-options-expander').style.display = 'block';
                        document.getElementById('json-options-expander').open = true;
                        document.getElementById('subtitle-options-expander').style.display = 'none';
                        fileOutputSection.style.display = 'none';

                        const keys = extractJsonKeys(jsonData);
                        currentJsonPaths = keys;

                        const jsonKeysList = document.getElementById('json-keys-list');
                        jsonKeysList.innerHTML = '';
                        keys.forEach((keyInfo, index) => {
                            const div = document.createElement('div');
                            div.style.display = 'flex';
                            div.style.alignItems = 'flex-start';
                            div.style.gap = '0.5rem';

                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.value = index;
                            checkbox.id = `json-key-${index}`;

                            const label = document.createElement('label');
                            label.htmlFor = `json-key-${index}`;
                            label.style.cursor = 'pointer';
                            label.style.wordBreak = 'break-all';

                            const preview = keyInfo.sampleValue.length > 25 ? keyInfo.sampleValue.slice(0, 25) + '...' : keyInfo.sampleValue;
                            if (keyInfo.isArrayKey) {
                                label.textContent = `${keyInfo.key} (√ó${keyInfo.count}): "${preview}"`;
                            } else {
                                label.textContent = `${keyInfo.key}: "${preview}"`;
                            }

                            div.appendChild(checkbox);
                            div.appendChild(label);
                            jsonKeysList.appendChild(div);
                        });
                    } catch (err) {
                        alert(UI_STRINGS.messages.jsonParseError + err.message);
                    }
                } else if (fileName.endsWith('.srt') || fileName.endsWith('.vtt')) {
                    // Subtitle Mode
                    const ext = fileName.endsWith('.vtt') ? 'vtt' : 'srt';
                    updatePreviewLabel(ext);

                    const parsedSubtitle = parseSubtitle(content, ext);
                    currentSubtitleData = parsedSubtitle;
                    currentSubtitleRawContent = content;
                    currentSubtitleExt = ext;

                    const hasMultiLine = parsedSubtitle.blocks.some(b => b.textLines.length > 1);

                    document.getElementById('csv-options-expander').style.display = 'none';
                    document.getElementById('json-options-expander').style.display = 'none';

                    if (hasMultiLine) {
                        document.getElementById('subtitle-options-expander').style.display = 'block';
                        document.getElementById('subtitle-options-expander').open = true;
                        fileOutputSection.style.display = 'none';
                    } else {
                        document.getElementById('subtitle-options-expander').style.display = 'none';
                        const converted = convertSubtitle(parsedSubtitle, 'all');
                        currentFileOutput = converted;
                        document.getElementById('csv-preview-table-container').style.display = 'none';
                        outputPreview.style.display = 'block';
                        outputPreview.value = converted.slice(0, 2000) + (converted.length > 2000 ? UI_STRINGS.messages.truncated : '');
                        fileOutputSection.style.display = 'block';
                    }
                } else {
                    // Standard Mode (txt, md) - with smart subtitle detection for .txt
                    const ext = fileName.substring(fileName.lastIndexOf('.') + 1);

                    // Smart detect subtitle format in .txt files
                    if (ext === 'txt') {
                        const detectedFormat = detectSubtitleFormat(content);
                        if (detectedFormat) {
                            // Show confirmation dialog
                            const useSubtitleMode = confirm(UI_STRINGS.subtitle?.detectPrompt || "ÈÄô‰ªΩ .txt ÁúãËµ∑‰æÜÊúâÂ≠óÂπïÊôÇÊ®ôÔºåk√†m beh Áî®Â≠óÂπïÊ®°ÂºèËΩâÔºü");
                            if (useSubtitleMode) {
                                // User chose subtitle mode
                                currentFileName = currentFileName.replace(/\.txt$/i, '.' + detectedFormat);
                                updatePreviewLabel(detectedFormat);

                                const parsedSubtitle = parseSubtitle(content, detectedFormat);
                                currentSubtitleData = parsedSubtitle;
                                currentSubtitleRawContent = content;
                                currentSubtitleExt = detectedFormat;

                                const hasMultiLine = parsedSubtitle.blocks.some(b => b.textLines.length > 1);

                                document.getElementById('csv-options-expander').style.display = 'none';
                                document.getElementById('json-options-expander').style.display = 'none';

                                if (hasMultiLine) {
                                    document.getElementById('subtitle-options-expander').style.display = 'block';
                                    document.getElementById('subtitle-options-expander').open = true;
                                    fileOutputSection.style.display = 'none';
                                } else {
                                    document.getElementById('subtitle-options-expander').style.display = 'none';
                                    const converted = convertSubtitle(parsedSubtitle, 'all');
                                    currentFileOutput = converted;
                                    document.getElementById('csv-preview-table-container').style.display = 'none';
                                    outputPreview.style.display = 'block';
                                    outputPreview.value = converted.slice(0, 2000) + (converted.length > 2000 ? UI_STRINGS.messages.truncated : '');
                                    fileOutputSection.style.display = 'block';
                                }
                                return; // Exit, async subtitle handling done
                            }
                            // User chose plain text mode - fall through
                        }
                    }

                    // Process as plain text (md or txt without subtitle format)
                    updatePreviewLabel(ext === 'md' ? 'md' : 'text');

                    document.getElementById('csv-options-expander').style.display = 'none';
                    document.getElementById('json-options-expander').style.display = 'none';
                    document.getElementById('subtitle-options-expander').style.display = 'none';
                    document.getElementById('csv-preview-table-container').style.display = 'none';
                    outputPreview.style.display = 'block';

                    const converted = TLtiau_2_POJtiau(content);
                    currentFileOutput = converted;
                    outputPreview.value = converted.slice(0, 2000) + (converted.length > 2000 ? UI_STRINGS.messages.truncated : '');
                    fileOutputSection.style.display = 'block';
                }
            };
            reader.readAsText(file);
        }

        // CSV Convert Button
        document.getElementById('btn-convert-csv').addEventListener('click', () => {
            if (!currentCsvData) return;

            const checkboxes = csvColumnsList.querySelectorAll('input[type="checkbox"]:checked');
            const selectedCols = Array.from(checkboxes).map(cb => cb.value);

            if (selectedCols.length === 0) {
                alert(UI_STRINGS.messages.selectColumnsError);
                return;
            }

            const mode = document.querySelector('input[name="csv-mode"]:checked').value;

            // Convert selected columns
            const convertedData = {};
            selectedCols.forEach(col => {
                const colValues = currentCsvData.rows.map(r => r[col] || '');
                const combinedText = colValues.join('\n:::SEP:::\n');
                const convertedCombined = TLtiau_2_POJtiau(combinedText);
                convertedData[col] = convertedCombined.split('\n:::SEP:::\n');
            });

            // Build new headers and rows
            const newHeaders = [];
            const finalRows = currentCsvData.rows.map(() => ({}));

            if (mode === 'insert') {
                currentCsvData.headers.forEach(h => {
                    newHeaders.push(h);
                    currentCsvData.rows.forEach((row, i) => {
                        finalRows[i][h] = row[h];
                    });

                    if (selectedCols.includes(h)) {
                        const pojColName = h + '_POJ';
                        newHeaders.push(pojColName);
                        currentCsvData.rows.forEach((row, i) => {
                            finalRows[i][pojColName] = convertedData[h][i] || '';
                        });
                    }
                });
            } else if (mode === 'original-plus') {
                selectedCols.forEach(col => {
                    newHeaders.push(col);
                    currentCsvData.rows.forEach((row, i) => {
                        finalRows[i][col] = row[col];
                    });

                    const pojColName = col + '_POJ';
                    newHeaders.push(pojColName);
                    currentCsvData.rows.forEach((row, i) => {
                        finalRows[i][pojColName] = convertedData[col][i] || '';
                    });
                });
            } else {
                // 'only' mode
                selectedCols.forEach(col => {
                    const pojColName = col + '_POJ';
                    newHeaders.push(pojColName);
                    currentCsvData.rows.forEach((row, i) => {
                        finalRows[i][pojColName] = convertedData[col][i] || '';
                    });
                });
            }

            const resultCSV = generateCSV(newHeaders, finalRows, currentCsvSeparator);
            currentFileOutput = resultCSV;

            const tableContainer = document.getElementById('csv-preview-table-container');
            tableContainer.innerHTML = '';
            tableContainer.appendChild(renderTable(newHeaders, finalRows));
            tableContainer.style.display = 'block';
            outputPreview.style.display = 'none';

            document.getElementById('csv-options-expander').open = false;
            fileOutputSection.style.display = 'block';
        });

        // JSON Convert Button
        document.getElementById('btn-convert-json').addEventListener('click', () => {
            if (!currentJsonData) return;

            const jsonKeysList = document.getElementById('json-keys-list');
            const checkboxes = jsonKeysList.querySelectorAll('input[type="checkbox"]:checked');
            const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (selectedIndices.length === 0) {
                alert(UI_STRINGS.messages.selectKeysError);
                return;
            }

            const mode = document.querySelector('input[name="json-mode"]:checked').value;
            const selectedKeys = selectedIndices.map(i => currentJsonPaths[i]);

            let result;

            if (currentJsonIsArray) {
                const convertedData = {};

                selectedKeys.forEach(keyInfo => {
                    const values = currentJsonData.map(item => item[keyInfo.key] || '');
                    const combined = values.join('\n:::JSON_SEP:::\n');
                    const converted = TLtiau_2_POJtiau(combined);
                    convertedData[keyInfo.key] = converted.split('\n:::JSON_SEP:::\n');
                });

                if (mode === 'only') {
                    result = currentJsonData.map((item, i) => {
                        const newItem = {};
                        selectedKeys.forEach(keyInfo => {
                            newItem[keyInfo.key + '_POJ'] = convertedData[keyInfo.key][i] || '';
                        });
                        return newItem;
                    });
                } else if (mode === 'original-plus') {
                    result = currentJsonData.map((item, i) => {
                        const newItem = {};
                        selectedKeys.forEach(keyInfo => {
                            newItem[keyInfo.key] = item[keyInfo.key];
                            newItem[keyInfo.key + '_POJ'] = convertedData[keyInfo.key][i] || '';
                        });
                        return newItem;
                    });
                } else {
                    const selectedKeyNames = new Set(selectedKeys.map(k => k.key));
                    result = currentJsonData.map((item, i) => {
                        const newItem = {};
                        Object.keys(item).forEach(key => {
                            newItem[key] = item[key];
                            if (selectedKeyNames.has(key)) {
                                newItem[key + '_POJ'] = convertedData[key][i] || '';
                            }
                        });
                        return newItem;
                    });
                }
            } else {
                const combinedText = selectedKeys.map(k => k.sampleValue).join('\n:::JSON_SEP:::\n');
                const convertedCombined = TLtiau_2_POJtiau(combinedText);
                const convertedValues = convertedCombined.split('\n:::JSON_SEP:::\n');

                if (mode === 'only') {
                    result = {};
                    selectedKeys.forEach((keyInfo, i) => {
                        setNestedValue(result, keyInfo.key + '_POJ', convertedValues[i] || '');
                    });
                } else if (mode === 'original-plus') {
                    result = {};
                    selectedKeys.forEach((keyInfo, i) => {
                        setNestedValue(result, keyInfo.key, keyInfo.sampleValue);
                        setNestedValue(result, keyInfo.key + '_POJ', convertedValues[i] || '');
                    });
                } else {
                    result = JSON.parse(JSON.stringify(currentJsonData));
                    selectedKeys.forEach((keyInfo, i) => {
                        setNestedValue(result, keyInfo.key + '_POJ', convertedValues[i] || '');
                    });
                }
            }

            const prettyJson = JSON.stringify(result, null, 2);
            currentFileOutput = prettyJson;

            document.getElementById('csv-preview-table-container').style.display = 'none';
            outputPreview.style.display = 'block';
            outputPreview.value = prettyJson.slice(0, 5000) + (prettyJson.length > 5000 ? '\n...(truncated)' : '');

            document.getElementById('json-options-expander').open = false;
            fileOutputSection.style.display = 'block';
        });

        // Subtitle Convert Button
        document.getElementById('btn-convert-subtitle').addEventListener('click', () => {
            if (!currentSubtitleData) return;

            const modeRadio = document.querySelector('input[name="subtitle-mode"]:checked');
            if (!modeRadio) {
                alert(UI_STRINGS.messages.selectSubtitleLinesError);
                return;
            }

            const mode = modeRadio.value;
            const converted = convertSubtitle(currentSubtitleData, mode);
            currentFileOutput = converted;

            document.getElementById('csv-preview-table-container').style.display = 'none';
            outputPreview.style.display = 'block';
            outputPreview.value = converted.slice(0, 2000) + (converted.length > 2000 ? '\n...' : '');

            document.getElementById('subtitle-options-expander').open = false;
            fileOutputSection.style.display = 'block';
        });

        // Clipboard and Download Helpers
        async function copyToClipboard(elementId, feedbackElementId) {
            const el = document.getElementById(elementId);
            if (!el) return;

            // For textarea, we can select and copy, or use Clipboard API
            // Clipboard API is cleaner
            try {
                // If it's the preview showing truncated text, we should copy the FULL text if possible
                // But we store full text in variables for file mode.
                // For RT, the textarea has the full text.
                let textToCopy = el.value;
                if (elementId === 'outputPreview' && currentFileOutput) {
                    textToCopy = currentFileOutput; // Copy full file content
                }

                await navigator.clipboard.writeText(textToCopy);

                // Visual feedback (optional)
                if (feedbackElementId) {
                    const btnSpan = document.getElementById(feedbackElementId);
                    if (btnSpan) {
                        const originalText = btnSpan.innerText;
                        btnSpan.innerText = UI_STRINGS.buttons.copied;
                        setTimeout(() => btnSpan.innerText = originalText, 2000);
                    }
                }

            } catch (err) {
                console.error('Failed to copy: ', err);
                // Fallback: select and execCommand
                el.select();
                document.execCommand('copy');
            }
        }

        async function pasteFromClipboard(elementId) {
            try {
                const text = await navigator.clipboard.readText();
                const el = document.getElementById(elementId);
                if (el) {
                    el.value = text;
                    // Trigger input event for real-time conversion
                    el.dispatchEvent(new Event('input'));
                }
            } catch (err) {
                console.error('Failed to read clipboard: ', err);
                alert(UI_STRINGS.messages.clipboardError);
            }
        }

        function downloadText(elementId, filename) {
            let content = '';
            if (elementId === 'outputPreview' && currentFileOutput) {
                content = currentFileOutput;
            } else {
                content = document.getElementById(elementId).value;
            }

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- Comprehensive Self-Test ---
        function runTests() {
            console.log("Running comprehensive self-test...");

            const originalNasal = window.TL_USE_NASAL_SUPERSCRIPT;
            const originalTone6 = window.TL_TONE6_USE_CARON;
            const originalAllCaps = window.TL_ALL_CAPS_SUPPORT;

            const runTestCase = (input, expected, config = {}) => {
                // Apply config or defaults
                window.TL_USE_NASAL_SUPERSCRIPT = config.nasal !== undefined ? config.nasal : true;
                window.TL_TONE6_USE_CARON = config.tone6 !== undefined ? config.tone6 : false;
                window.TL_ALL_CAPS_SUPPORT = config.allCaps !== undefined ? config.allCaps : true;

                const result = TLtiau_2_POJtiau(input);
                if (result !== expected) {
                    console.error(`[FAIL] In: "${input}" | Expected: "${expected}" | Got: "${result}" | Config: ${JSON.stringify(config)}`);
                    return false;
                }
                return true;
            };

            let passed = 0;
            let total = 0;

            const testCases = [
                // 1. Basic Rules
                { in: "phah", out: "phah" },
                { in: "T√¢i-u√¢n", out: "T√¢i-o√¢n" },
                { in: "tsu√≠", out: "ch√∫i" },
                { in: "tshu√≠", out: "chh√∫i" },
                { in: "ing", out: "eng" },
                { in: "tsa", out: "cha" },
                { in: "a7", out: "ƒÅ" },
                { in: "ah8", out: "aÃçh" },
                { in: "a9", out: "ƒÉ" },
                // Tonemark position tests (ua->oa, ue->oe)
                { in: "tu√†", out: "t√≤a" }, // TL tu√† (live) -> POJ t√≤a
                { in: "ku√©", out: "k√≥e" }, // TL ku√© (rice pudding) -> POJ k√≥e  
                { in: "su√≠", out: "s√∫i" }, // TL su√≠ (pretty) -> POJ s√∫i (no change, tone on u)
                { in: "u√°", out: "√≥a" }, // TL u√° (lean) -> POJ √≥a

                // Tone 4 vs 8 Rules
                { in: "a4", out: "a4" },   // TL a4 (no stop)
                { in: "a8", out: "a8" },   // TL a8 (no stop)
                { in: "ah4", out: "ah" },  // TL ah4 (stop)
                { in: "ah8", out: "aÃçh" },   // TL ah8 (stop)
                { in: "ah3", out: "ah3" },  // TL ah3 (no stop)
                { in: "ak7", out: "ak7" },   // TL ak7 (no stop)
                { in: "SUT8", out: "SUÃçT" },   // TL SUT8 (stop)

                // Escape syntax tests
                { in: "ts\\[ts]ts", out: "chtsch" },  // Edge case: \[ts] preserved, bare ts converted

                // English False Positives (Escaped)
                { in: "\\[cats]", out: "cats" },
                { in: "Read a \\[book]", out: "Read a book" },
                { in: "\\[Google]", out: "Google" },
                { in: "\\[Blue] sky", out: "Blue sky" },
                { in: "\\[Singing]", out: "Singing" },
                { in: "\\[Wiki]", out: "Wiki" }
            ];

            tests.forEach(t => {
                const res = TLtiau_2_POJtiau(t.in);
                if (res !== t.out) {
                    console.error(`Test failed: ${t.in} -> expected ${t.out}, got ${res}`);
                } else {
                    console.log(`Test passed: ${t.in} -> ${res}`);
                }
            });
        }

    </script>
</body>

</html>