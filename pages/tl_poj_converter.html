---
layout: apps
title: TL to POJ Real-time Converter
version: v0.2a
permalink: /pages/tl_poj_converter.html
updated: 2026-01-04
note: 1. Enhanced file conversion feature with multiple file types support. 2. Added subtitle detection for .txt files.
---
<!DOCTYPE html>
<!-- Note: 1. This is a real-time converter. It will convert the text as you type, paste from clipboard, or drag and drop files. 2. The converter will also convert number tonemarks to char tonemarks for both POJ and TL-POJ. -->
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TL to POJ Real-time Converter</title>
    <!-- Google Fonts: Huninn will be loaded dynamically with specific characters -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <style>
        /* CSS Variables - From Image Resizer (Tech Theme) */
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --text-link: #58a6ff;
            --text-accent: #238636;
            --border-color: #30363d;
            --font-mono: 'Times New Roman', serif;
            --font-sans: 'Times New Roman', serif;
            --font-taigi: 'Huninn', 'Times New Roman', serif;
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 2rem;
            --spacing-lg: 4rem;
            --primary-color: var(--text-link);
            /* Mapping for backward compatibility if needed */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: var(--font-sans);
            line-height: 1.6;
            padding: var(--spacing-md);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        header {
            text-align: center;
            margin-bottom: 0;
        }

        h1 {
            font-family: var(--font-mono);
            font-size: 1.2rem;
            margin-bottom: 0;
            color: var(--text-primary);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: 0;
            justify-content: center;
        }

        .tab-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: var(--font-mono);
            font-size: 1.2rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-btn:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--bg-tertiary);
            /* Active state */
            color: var(--text-link);
            border-color: var(--text-link);
        }

        /* Panels */
        .panel {
            display: none;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: var(--spacing-sm);
        }

        .panel.active {
            display: block;
        }

        /* Real-time Mode Styles */
        .split-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            height: 600px;
        }

        @media (max-width: 768px) {
            .split-view {
                grid-template-columns: 1fr;
                height: auto;
            }
        }

        /* Handset Vertical Optimization */
        @media (max-width: 480px) {
            body {
                padding: var(--spacing-sm);
                /* Reduce body padding */
            }

            .container {
                gap: 0.25rem;
                /* Tighter vertical gaps */
            }

            h1 {
                font-size: 1.1rem;
                /* Slightly smaller title */
            }

            .tab-btn {
                padding: 0.5rem 1rem;
                /* Smaller tabs */
                font-size: 1rem;
            }

            .toolbar {
                flex-wrap: wrap;
                /* Allow toolbar items to wrap if needed */
                gap: 0.5rem;
            }

            .toolbar label {
                font-size: 1rem;
            }

            textarea {
                font-size: 1.2rem;
                /* Slightly smaller text for mobile readability */
                padding: 0.75rem;
            }
        }

        .text-area-container {
            display: flex;
            flex-direction: column;
            position: relative;
            height: 100%;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xs);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--spacing-xs);
        }

        .toolbar label {
            font-family: var(--font-mono);
            font-size: 1.2rem;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .tool-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
            padding: 4px 8px;
            font-family: var(--font-mono);
            font-size: 1.1rem;
            cursor: pointer;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            color: var(--text-primary);
            border-color: var(--text-primary);
        }

        textarea {
            flex: 1;
            padding: var(--spacing-sm);
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            resize: none;
            font-family: var(--font-taigi);
            /* Huninn for Taigi, Times New Roman fallback */
            font-size: 1.4rem;
            line-height: 1.6;
            outline: none;
            width: 100%;
            color: var(--text-primary);
            box-sizing: border-box;
            min-height: 200px;
        }

        textarea:focus {
            border-color: var(--text-link);
            box-shadow: 0 0 0 1px var(--text-link);
        }

        /* Brighten placeholders */
        textarea::placeholder,
        input::placeholder {
            color: var(--text-secondary);
            opacity: 0.8;
            font-size: 1.2rem;
        }

        /* File Mode Styles */
        .file-drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: 6px;
            padding: var(--spacing-lg);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(22, 27, 34, 0.5);
            /* Semi-transparent like upload area */
            margin-bottom: var(--spacing-md);
        }

        .file-drop-zone:hover,
        .file-drop-zone.drag-over {
            border-color: var(--text-link);
            background: rgba(88, 166, 255, 0.05);
        }

        .file-drop-zone p {
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 1.4rem;
            margin-bottom: var(--spacing-xs);
        }

        .btn {
            padding: 10px 20px;
            font-family: var(--font-mono);
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: var(--text-accent);
            color: white;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .btn:hover:not(:disabled) {
            background-color: #2ea043;
            box-shadow: 0 0 10px rgba(46, 160, 67, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #outputPreview {
            width: 100%;
            height: 400px;
        }

        /* Expander Styles */
        details {
            margin-bottom: 0.5rem;
        }

        details summary {
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 0.5rem;
            user-select: none;
            color: var(--text-primary);
        }

        /* Options Panel */
        .options-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }

        .options-panel label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-family: var(--font-mono);
        }

        .options-panel input[type="checkbox"],
        .options-panel input[type="radio"] {
            accent-color: var(--text-link);
        }

        /* Columns/Keys List */
        .columns-list {
            max-height: 150px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            border-radius: 4px;
            background: var(--bg-primary);
        }

        /* Table Preview */
        #csv-preview-table-container {
            display: none;
            flex: 1;
            overflow: auto;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            max-height: 400px;
        }

        #csv-preview-table {
            width: 100%;
            border-collapse: collapse;
            font-family: var(--font-mono);
            font-size: 0.9rem;
        }

        #csv-preview-table th,
        #csv-preview-table td {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            text-align: left;
        }

        #csv-preview-table th {
            background: var(--bg-tertiary);
            position: sticky;
            top: 0;
        }

        #csv-preview-table tbody tr:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Warning Messages */
        #preview-messages {
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        #msg-specific-warning {
            color: #f0ad4e;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1 id="ui-title"></h1>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchMode('realtime')" id="ui-tab-realtime"></button>
            <button class="tab-btn" onclick="switchMode('file')" id="ui-tab-file"></button>
        </div>

        <!-- Real-time Panel -->
        <div id="panel-realtime" class="panel active">
            <div class="split-view">
                <div class="text-area-container">
                    <div class="toolbar">
                        <label for="rt-input" id="ui-label-input"></label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <button class="tool-btn" onclick="pasteFromClipboard('rt-input')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2">
                                    </path>
                                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                                </svg>
                                <span id="ui-btn-paste"></span>
                            </button>
                            <button class="tool-btn" onclick="clearInput('rt-input')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                                <span id="ui-btn-clear"></span>
                            </button>
                        </div>
                    </div>
                    <textarea id="rt-input" placeholder="" spellcheck="false"></textarea>
                    <button class="tool-btn" id="ui-btn-quick-test" onclick="injectTestText()"
                        style="margin-top: var(--spacing-xs); align-self: center;"></button>
                </div>
                <div class="text-area-container">
                    <div class="toolbar">
                        <label for="rt-output" id="ui-label-output"></label>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="tool-btn" onclick="copyToClipboard('rt-output', 'ui-btn-copy-rt')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                                <span id="ui-btn-copy-rt"></span>
                            </button>
                            <button class="tool-btn" onclick="downloadText('rt-output', 'poj_conversion.txt')">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                <span id="ui-btn-download-rt"></span>
                            </button>
                        </div>
                    </div>
                    <textarea id="rt-output" readonly placeholder="" spellcheck="false"></textarea>
                </div>
            </div>
        </div>

        <!-- File Converter Panel -->
        <div id="panel-file" class="panel">
            <!-- File Upload Section -->
            <details id="file-upload-expander" open>
                <summary id="ui-file-upload-header">ğŸ“ Ap-lÃ³Í˜ æ›¸é¡</summary>
                <div class="file-drop-zone" id="dropZone">
                    <p id="ui-drop-text"></p>
                    <input type="file" id="fileInput" accept=".txt,.md,.srt,.vtt,.csv,.tsv,.json,.pdf"
                        style="display: none;">
                    <button class="btn" id="btn-choose-file"
                        style="display: inline-flex; align-items: center; gap: 8px; margin-top: 0.5rem;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <span id="ui-btn-choose-file"></span>
                    </button>
                </div>
            </details>

            <!-- CSV Options Section -->
            <details id="csv-options-expander" style="display: none;">
                <summary id="ui-csv-options-header">âš™ï¸ CSV/TSV è¨­å®š</summary>
                <div class="options-panel">
                    <label id="lbl-select-columns" style="font-weight: bold;"></label>
                    <div id="csv-columns-list" class="columns-list"></div>

                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label id="lbl-output-mode" style="font-weight: bold;"></label>
                        <label><input type="radio" name="csv-mode" value="only" checked> <span
                                class="csv-mode-only"></span></label>
                        <label><input type="radio" name="csv-mode" value="original-plus"> <span
                                class="csv-mode-original-plus"></span></label>
                        <label><input type="radio" name="csv-mode" value="insert"> <span
                                class="csv-mode-insert"></span></label>
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <button id="btn-convert-csv" class="btn" style="flex: 1;"></button>
                        <button id="btn-reset-csv" class="tool-btn"></button>
                    </div>
                </div>
            </details>

            <!-- JSON Options Section -->
            <details id="json-options-expander" style="display: none;">
                <summary id="ui-json-options-header">âš™ï¸ JSON è¨­å®š</summary>
                <div class="options-panel">
                    <label id="lbl-select-keys" style="font-weight: bold;"></label>
                    <div id="json-keys-list" class="columns-list" style="font-family: monospace; font-size: 0.85rem;">
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label id="lbl-json-output-mode" style="font-weight: bold;"></label>
                        <label><input type="radio" name="json-mode" value="only" checked> <span
                                class="json-mode-only"></span></label>
                        <label><input type="radio" name="json-mode" value="original-plus"> <span
                                class="json-mode-original-plus"></span></label>
                        <label><input type="radio" name="json-mode" value="insert"> <span
                                class="json-mode-insert"></span></label>
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <button id="btn-convert-json" class="btn" style="flex: 1;"></button>
                        <button id="btn-reset-json" class="tool-btn"></button>
                    </div>
                </div>
            </details>

            <!-- Subtitle Options Section -->
            <details id="subtitle-options-expander" style="display: none;">
                <summary id="ui-subtitle-options-header">âš™ï¸ å­—å¹•è¨­å®š</summary>
                <div class="options-panel">
                    <label id="lbl-select-lines" style="font-weight: bold;"></label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label><input type="radio" name="subtitle-mode" value="all" checked> <span
                                class="subtitle-mode-all"></span></label>
                        <label><input type="radio" name="subtitle-mode" value="line1"> <span
                                class="subtitle-mode-line1"></span></label>
                        <label><input type="radio" name="subtitle-mode" value="line2"> <span
                                class="subtitle-mode-line2"></span></label>
                        <label><input type="radio" name="subtitle-mode" value="line3plus"> <span
                                class="subtitle-mode-line3plus"></span></label>
                    </div>

                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <button id="btn-convert-subtitle" class="btn" style="flex: 1;"></button>
                        <button id="btn-reset-subtitle" class="tool-btn"></button>
                    </div>
                </div>
            </details>

            <!-- Output Section -->
            <div id="fileOutputSection" style="display: none;">
                <div id="preview-messages">
                    <span id="msg-general-warning"></span>
                    <span id="msg-specific-warning" style="display: none;"></span>
                </div>
                <div class="toolbar">
                    <label id="ui-label-result"></label>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="tool-btn" id="btn-reset-file" title="Ap-lÃ³Í˜ æ–° Ãª æ›¸é¡">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                        </button>
                        <button class="tool-btn" id="btn-copy-file">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                            <span id="ui-btn-copy-file"></span>
                        </button>
                        <button class="tool-btn" id="btn-download-file">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            <span id="ui-btn-download-file"></span>
                        </button>
                    </div>
                </div>
                <textarea id="outputPreview" readonly placeholder=""></textarea>
                <div id="csv-preview-table-container"></div>
            </div>
        </div>

        <div style="text-align: center; margin-top: var(--spacing-sm);">
            <button class="tool-btn" id="ui-btn-download-offline" onclick="downloadCleanVersion()"
                style="padding: 10px 20px; display: inline-flex; border-style: dashed;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span id="ui-btn-download-offline-text"></span>
            </button>
        </div>

        <footer
            style="text-align: center; margin-top: var(--spacing-md); color: var(--text-secondary); font-size: 0.9rem;">
            <p id="ui-footer"></p>
        </footer>
    </div>

    <script>

        const taigiCharsToLoad = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZÃ¡Ã Ã¢ÄaÌÃ©Ã¨ÃªÄ“eÌÃ­Ã¬Ã®Ä«iÌÃ³Ã²Ã´ÅoÌÃºÃ¹Ã»Å«uÌÃÃ€Ã‚Ä€AÌÃ‰ÃˆÃŠÄ’EÌÃÃŒÃÄªIÌÃ“Ã’Ã”ÅŒOÌÃšÃ™Ã›ÅªUÌoÍ˜Ã³Í˜Ã²Í˜Ã´Í˜ÅÍ˜oÌÍ˜OÍ˜Ã“Í˜Ã’Í˜Ã”Í˜ÅŒÍ˜OÌÍ˜aâ¿eâ¿iâ¿oâ¿uâ¿oÍ˜â¿Aâ¿Eâ¿Iâ¿Oâ¿Uâ¿OÌÍ˜â¿Ã¡â¿Ã â¿Ã¢â¿Äâ¿aÌâ¿Ã©â¿Ã¨â¿Ãªâ¿Ä“eÌâ¿Ã­â¿Ã¬â¿Ã®â¿Ä«iÌâ¿Ã³â¿Ã²â¿Ã´â¿ÅÍ˜â¿oÌÍ˜â¿Ãºâ¿Ã¹â¿Ã»â¿Å«â¿uÌâ¿Ã³Í˜â¿Ã²Í˜â¿Ã´Í˜â¿ÅÍ˜â¿oÌÍ˜â¿Ãâ¿Ã€â¿Ã‚â¿Ä€â¿AÌâ¿Ã‰â¿ÃˆÃŠâ¿Ä’â¿EÌâ¿ÃÃŒÃÄªIÌâ¿Ã“Ã’Ã”ÅŒâ¿OÌâ¿Ãšâ¿Ã™â¿Ã›â¿Åªâ¿UÌâ¿Ã“Í˜â¿Ã’Í˜â¿Ã”Í˜â¿ÅŒÍ˜â¿OÌÍ˜â¿ÄƒÄ•Ä­ÅÅ­ÅÍ˜Ä‚Ä”Ä¬ÅÅ¬ÅÍ˜á¸¿mÌ€mÌ‚mÌ„mÌmÌ†á¸¾MÌ€MÌ‚MÌ„MÌMÌ†Å„Ç¹nÌ‚nÌ„nÌnÌ†ÅƒÇ¸NÌ‚NÌ„NÌNÌ†-0123456789.,;:?!'\"()[]{}<>@#$%^&*_+=\\|/";

        // Dynamically load Google Font "Huninn" with specific Taigi characters
        (function loadHuninnFont() {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = `https://fonts.googleapis.com/css2?family=Huninn&display=swap&text=${encodeURIComponent(taigiCharsToLoad)}`;
            document.head.appendChild(link);
        })();

        // --- UI Constants ---
        const UI_STRINGS = {
            title: "TL -> POJ éš¨æ™‚è½‰",
            tabs: {
                realtime: "æ‹éš¨è½‰",
                file: "è½‰æ›¸é¡"
            },
            labels: {
                input: "TL / TL & POJ å¸¶æ•¸å­—èª¿è™Ÿ",
                output: "POJ è¼¸å‡º",
                result: "è½‰soahçµæœ"
            },
            buttons: {
                paste: "è²¼ TL",
                copy: "khoÍ˜--èµ·ä¾†",
                download: "TÃ¡ng-lÃ³Í˜",
                chooseFile: "Ap-lÃ³Í˜",
                copied: "khoÍ˜ å¥½--ah!",
                quickTest: "çœ‹è¦‹æœ¬/å¿«é€Ÿæ¸¬",
                downloadOffline: "â¬‡ TÃ¡ng-lÃ³Í˜ App å®¶å·±é›»è…¦ç”¨",
                clear: "ç¸½æ¸…",
                cancel: "ChhÃº-siau"
            },
            placeholders: {
                input: `èªªæ˜ï¼š
1. æ‹/è²¼ TL heÌk-chiÃ¡ TL/POJ æ¨™æ•¸å­—èª¿è™Ÿ...(e.g. TÃ¢i-uÃ¢nï¼ŒTai5-uan5ï¼ŒiaÌh-sÄ« Tai5-oan5). 
2. ç„¡ beh è½‰ Ãª æ–‡å­— kÄ ç”¨ \\[ ... ] åŒ…--èµ·ä¾†ã€‚
3. çœ‹è¦‹æœ¬ iaÌh-sÄ« å¿«é€Ÿæ¸¬ï¼ŒchhiÌh ä¸‹è·¤ chhiÌh-liÃºã€‚
4. TÃ¡ng-lÃ³Í˜(download) é€™æ”¯ Appï¼Œä¸Šä¸‹è·¤æœ‰ chhiÌh-liÃºã€‚
5. æ¯‹thang æ‹ ç¬¦è™Ÿèª¿è™Ÿ POJ koh è½å»è½‰ï¼Œç„¡ä¿è­‰çµæœã€‚`,
                output: "POJ è¼¸å‡º...",
                preview: "è¼¸å‡ºæœƒ tÄ« chia..."
            },
            dropZone: {
                main: "KÄ æ›¸é¡ æ‹–ä¾† chia, iaÌh-sÄ« chhiÌh Ap-lÃ³Í˜ æ€æ›¸é¡, .txt/.md/.srt/.vtt/.csv/.tsv/.json/.pdf lÃ³ng æœƒä½¿ã€‚"
            },
            file: {
                uploadHeader: "ğŸ“ Ap-lÃ³Í˜ æ›¸é¡",
                previewLabel: "è½‰soahçµæœ",
                fileTypes: {
                    csv: " (CSV è¡¨æ ¼)",
                    tsv: " (TSV è¡¨æ ¼)",
                    json: " (JSON è³‡æ–™)",
                    pdf: " (PDF æ–‡ä»¶)",
                    text: " (Text æ–‡ä»¶)",
                    md: " (Markdown æ–‡ä»¶)",
                    srt: " (SRT å­—å¹•)",
                    vtt: " (VTT å­—å¹•)"
                },
                messages: {
                    general: "* Ã€i ç´°è†©ï¼Œè‹±æ–‡ aÌh-sÄ« å…¶ä»–å¤–èª Ãª ç¾…é¦¬å­— kÃ¡m æœ‰èª¤è½‰ã€‚",
                    pdf: "* æ’ç‰ˆè‹¥èµ°ç²¾--å»ï¼Œæœƒç”¨å¾—æå» hÅÍ˜ AI é‡æ’ã€‚"
                }
            },
            csv: {
                optionsHeader: "âš™ï¸ CSV/TSV è¨­å®š",
                selectColumns: "æ€æ¬²è½‰ Ãª ç›´é€:",
                outputMode: "Output æ¨¡å¼:",
                modeOnly: "kan-ta è½‰å¥½--Ãª",
                modeOriginalPlus: "åŸç›´é€ + è½‰å¥½--Ãª",
                modeInsert: "æ’ tÄ« åŸç›´é€å¾Œå£",
                btnConvert: "é–‹å§‹è½‰ CSV"
            },
            json: {
                optionsHeader: "âš™ï¸ JSON è¨­å®š",
                selectKeys: "æ€æ¬²è½‰ Ãª Key:",
                outputMode: "Output æ¨¡å¼:",
                modeOnly: "kan-ta è½‰å¥½--Ãª",
                modeOriginalPlus: "åŸ Key + è½‰å¥½--Ãª",
                modeInsert: "æ’ tÄ« åŸ Key å¾Œå£",
                btnConvert: "é–‹å§‹è½‰ JSON"
            },
            subtitle: {
                optionsHeader: "âš™ï¸ å­—å¹•è¨­å®š",
                selectLines: "æ€æ¬²è½‰ä½—ä¸€é€:",
                modeAll: "LÃ³ng-chÃ³ng",
                modeLine1: "kan-ta é ­é€",
                modeLine2: "kan-ta ç¬¬ 2 é€",
                modeLine3Plus: "kan-ta ç¬¬ 3 é€ä»¥å¾Œ",
                btnConvert: "é–‹å§‹è½‰å­—å¹•",
                detectPrompt: "é€™ä»½ .txt çœ‹èµ·ä¾†æœ‰å­—å¹•æ™‚æ¨™ï¼ŒkÃ m beh ç”¨å­—å¹•æ¨¡å¼è½‰ï¼Ÿ"
            },
            messages: {
                clipboardError: "ç„¡æ³•åº¦è‡ªå‹•è²¼ï¼ŒchhiÌh Ctrl+V è²¼çœ‹è¦“ã€‚",
                truncated: "\n\n...\n\n----------\n\nâ†‘ å…ˆçœ‹--ä¸€ä¸‹çˆ¾ï¼Œå®Œæ•´--Ãª Ã i tÃ¡ng-lÃ³Í˜...",
                downloadConfirm: "KÃ¡m æœ‰ç¢ºå®š beh tÃ¡ng-lÃ³Í˜ tÄ« å®¶å·±é›»è…¦ç”¨ï¼Ÿ"
            },
            testSample: `=== TL Diacritic Input ===
TL: TÃ¢i-uÃ¢n sÄ« chiÌt-Ãª hÃ³ sÃ³Í˜-chÄi.
TsiÌt-hÄng tÄi-tsÃ¬ tsin-tsiÃ nn hÃ³.

POJ: GÃ³a Ã i lim tÃª, i Ã i chiaÌh pnÌ„g.

=== TL/POJ Number Tonemarks ===
TL: Tai5-uan5 si7 chit8-e5 ho2 so2-chai7.
Chit8-hang7 tai7-chi3 chin-chiann3 ho2.

POJ: Goa2 ai3 lim te5, i ai3 chiah8 png7.

=== Syllabic Nasals & Special Cases ===
Nasal: sann, sinn, hnn
Tone 4/8: a4, a8 (no stop), ah4, ah8 (stop)

Ãºi Ã³o Ã´ng mÌ‚ Ç¹g nÌ‚g
m2 ng5 mh8 ngh8

=== Tone Number Tests (1-9) ===
a1 a2 a3 ah4 a5 a6 a7 ah8 a9

=== Tonemark Position (uaâ†’oa, ueâ†’oe) ===
TL tuÃ  (live) â†’ POJ tÃ²a
TL kuÃ© (rice pudding) â†’ POJ kÃ³e
TL suÃ­ (pretty) â†’ POJ suÃ­
TL uÃ¡ (lean) â†’ POJ Ã²a

=== False Positives (Need Escape to preserved as-is) ===
\\[cats] (cats)
\\[book] (book)
\\[Google] (Google)
\\[Blue] sky (Blue sky)
\\[Singing] (Singing)
\\[Wiki] (Wiki)`,
            footer: "Â© 2026 Cyber OÍ˜-hÃ®m ki-tÄ“"
        };

        function initUI() {
            document.getElementById('ui-title').innerText = UI_STRINGS.title;

            // Icons for tabs
            const iconRealtime = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>`;
            const iconFile = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>`;

            document.getElementById('ui-tab-realtime').innerHTML = `${iconRealtime} <span>${UI_STRINGS.tabs.realtime}</span>`;
            document.getElementById('ui-tab-file').innerHTML = `${iconFile} <span>${UI_STRINGS.tabs.file}</span>`;

            document.getElementById('ui-label-input').innerText = UI_STRINGS.labels.input;
            document.getElementById('ui-label-output').innerText = UI_STRINGS.labels.output;
            document.getElementById('ui-label-result').innerText = UI_STRINGS.labels.result;

            document.getElementById('ui-btn-paste').innerText = UI_STRINGS.buttons.paste;
            document.getElementById('ui-btn-copy-rt').innerText = UI_STRINGS.buttons.copy;
            document.getElementById('ui-btn-download-rt').innerText = UI_STRINGS.buttons.download;
            document.getElementById('ui-btn-copy-file').innerText = UI_STRINGS.buttons.copy;
            document.getElementById('ui-btn-download-file').innerText = UI_STRINGS.buttons.download;
            document.getElementById('ui-btn-choose-file').innerText = UI_STRINGS.buttons.chooseFile;
            document.getElementById('ui-btn-quick-test').innerText = UI_STRINGS.buttons.quickTest;
            document.getElementById('ui-btn-download-offline-text').innerText = UI_STRINGS.buttons.downloadOffline;
            document.getElementById('ui-btn-clear').innerText = UI_STRINGS.buttons.clear;
            document.getElementById('ui-footer').innerText = UI_STRINGS.footer;

            document.getElementById('ui-drop-text').innerText = UI_STRINGS.dropZone.main;

            document.getElementById('rt-input').placeholder = UI_STRINGS.placeholders.input;
            document.getElementById('rt-output').placeholder = UI_STRINGS.placeholders.output;
            document.getElementById('outputPreview').placeholder = UI_STRINGS.placeholders.preview;

            // File upload header
            document.getElementById('ui-file-upload-header').innerText = UI_STRINGS.file.uploadHeader;
            document.getElementById('msg-general-warning').innerText = UI_STRINGS.file.messages.general;

            // CSV Options
            document.getElementById('ui-csv-options-header').innerText = UI_STRINGS.csv.optionsHeader;
            document.getElementById('lbl-select-columns').innerText = UI_STRINGS.csv.selectColumns;
            document.getElementById('lbl-output-mode').innerText = UI_STRINGS.csv.outputMode;
            document.querySelector('.csv-mode-only').innerText = UI_STRINGS.csv.modeOnly;
            document.querySelector('.csv-mode-original-plus').innerText = UI_STRINGS.csv.modeOriginalPlus;
            document.querySelector('.csv-mode-insert').innerText = UI_STRINGS.csv.modeInsert;
            document.getElementById('btn-convert-csv').innerText = UI_STRINGS.csv.btnConvert;
            document.getElementById('btn-reset-csv').innerText = UI_STRINGS.buttons.cancel;

            // JSON Options
            document.getElementById('ui-json-options-header').innerText = UI_STRINGS.json.optionsHeader;
            document.getElementById('lbl-select-keys').innerText = UI_STRINGS.json.selectKeys;
            document.getElementById('lbl-json-output-mode').innerText = UI_STRINGS.json.outputMode;
            document.querySelector('.json-mode-only').innerText = UI_STRINGS.json.modeOnly;
            document.querySelector('.json-mode-original-plus').innerText = UI_STRINGS.json.modeOriginalPlus;
            document.querySelector('.json-mode-insert').innerText = UI_STRINGS.json.modeInsert;
            document.getElementById('btn-convert-json').innerText = UI_STRINGS.json.btnConvert;
            document.getElementById('btn-reset-json').innerText = UI_STRINGS.buttons.cancel;

            // Subtitle Options
            document.getElementById('ui-subtitle-options-header').innerText = UI_STRINGS.subtitle.optionsHeader;
            document.getElementById('lbl-select-lines').innerText = UI_STRINGS.subtitle.selectLines;
            document.querySelector('.subtitle-mode-all').innerText = UI_STRINGS.subtitle.modeAll;
            document.querySelector('.subtitle-mode-line1').innerText = UI_STRINGS.subtitle.modeLine1;
            document.querySelector('.subtitle-mode-line2').innerText = UI_STRINGS.subtitle.modeLine2;
            document.querySelector('.subtitle-mode-line3plus').innerText = UI_STRINGS.subtitle.modeLine3Plus;
            document.getElementById('btn-convert-subtitle').innerText = UI_STRINGS.subtitle.btnConvert;
            document.getElementById('btn-reset-subtitle').innerText = UI_STRINGS.buttons.cancel;
        }

        document.addEventListener('DOMContentLoaded', initUI);

        // --- Converter Logic (Ported from Python) ---

        // Constants for regex tails
        // TL_bue: Syllable endings used for tone mark positioning
        // Updated to include p,t,k,h (entering tone endings) to allow non-standard tone/syllable combinations (e.g., Ã­k -> Ã©k)
        const TL_bue = '((?:rm|rng|rn|r|m|ng|n|nnh|nn|â¿|N|hN|p|t|k|h)?)';

        // Helper to escape regex special characters in a string
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Helper to create replacement regex from TL vowel + optional trailing consonants
        // Matches the Python RC_ function: vowel + optional tail chars
        function createRC(char) {
            // Matches vowel followed by optional consonant-like chars (for tone number placement)
            return new RegExp(char + '([aAeEgGhHiIkKmMnNoOpPtTuU]*)', 'g');
        }

        // Helper for RC1 (tailo[:-1] + TL_bue + tailo[-1])
        function createRC1(tailo) {
            const prefix = tailo.slice(0, -1);
            const lastChar = tailo.slice(-1);
            return new RegExp(prefix + TL_bue + lastChar, 'g');
        }

        // Helper for RC2 (tailo[0] + '(u|i)((?:N|â¿|nn)?)' + tailo[1])
        function createRC2(tailo) {
            return new RegExp(tailo[0] + '(u|i)((?:N|â¿|nn)?)' + tailo[1], 'g');
        }

        // Helper for RC3 (simple)
        function createRC3(tailo) {
            // Python regexes had re.A (ASCII only) but here we trust the input range or JS regex default
            // We ensure we match exact sequences. 
            // Note: Python's re.sub matches literal strings if not regex. 
            // But here we are building regexes. 
            return new RegExp(tailo, 'g');
        }

        function createRC3_Regex(pattern) {
            return new RegExp(pattern, 'g');
        }

        // Helper for RC4
        function createRC4(tailo) {
            const prefix = tailo.slice(0, -1);
            const lastChar = tailo.slice(-1);
            return new RegExp(prefix + '(h(?:N|â¿|nn)?|p|t|k)' + lastChar + '?', 'g');
        }

        // Helper for RC8
        function createRC8(tailo) {
            const prefix = tailo.slice(0, -1);
            const lastChar = tailo.slice(-1);
            return new RegExp(prefix + '(h(?:N|â¿|nn)?|p|t|k)' + lastChar, 'g');
        }

        // 1. TL Tone Marks -> TL Numbers
        function TLtiau_2_TLsoo(tl_tiau, nasal = 'nn', use14 = false) {
            let tl_soo = tl_tiau;
            if (!tl_soo) return '';

            // Mapping table (regex, replacement string)
            // Note: In JS replacement string, $1 refers to capture group 1.

            const TL_T2S = [
                { r: createRC('Ã¡'), s: 'a$12' }, { r: createRC('Ã'), s: 'A$12' },
                { r: createRC('Ã '), s: 'a$13' }, { r: createRC('Ã€'), s: 'A$13' },
                { r: createRC('Ã¢'), s: 'a$15' }, { r: createRC('Ã‚'), s: 'A$15' },
                { r: createRC('Ç'), s: 'a$16' }, { r: createRC('Ç'), s: 'A$16' },
                { r: createRC('Ä'), s: 'a$17' }, { r: createRC('Ä€'), s: 'A$17' },
                { r: createRC('aÌ'), s: 'a$18' }, { r: createRC('AÌ'), s: 'A$18' },
                { r: createRC('aÌ‹'), s: 'a$19' }, { r: createRC('AÌ‹'), s: 'A$19' },
                { r: createRC('Ã©'), s: 'e$12' }, { r: createRC('Ã‰'), s: 'E$12' },
                { r: createRC('Ã¨'), s: 'e$13' }, { r: createRC('Ãˆ'), s: 'E$13' },
                { r: createRC('Ãª'), s: 'e$15' }, { r: createRC('ÃŠ'), s: 'E$15' },
                { r: createRC('Ä›'), s: 'e$16' }, { r: createRC('Äš'), s: 'E$16' },
                { r: createRC('Ä“'), s: 'e$17' }, { r: createRC('Ä’'), s: 'E$17' },
                { r: createRC('eÌ'), s: 'e$18' }, { r: createRC('EÌ'), s: 'E$18' },
                { r: createRC('eÌ‹'), s: 'e$19' }, { r: createRC('EÌ‹'), s: 'E$19' },
                { r: createRC('Ã­'), s: 'i$12' }, { r: createRC('Ã'), s: 'I$12' },
                { r: createRC('Ã¬'), s: 'i$13' }, { r: createRC('ÃŒ'), s: 'I$13' },
                { r: createRC('Ã®'), s: 'i$15' }, { r: createRC('Ã'), s: 'I$15' },
                { r: createRC('Ç'), s: 'i$16' }, { r: createRC('Ç'), s: 'I$16' },
                { r: createRC('Ä«'), s: 'i$17' }, { r: createRC('Äª'), s: 'I$17' },
                { r: createRC('iÌ'), s: 'i$18' }, { r: createRC('IÌ'), s: 'I$18' },
                { r: createRC('iÌ‹'), s: 'i$19' }, { r: createRC('IÌ‹'), s: 'I$19' },
                // oo chars - specific casing
                { r: createRC('Ã³Í˜'), s: 'oo$12' }, { r: createRC('Ã“Í˜'), s: 'Oo$12' },
                { r: createRC('Ã²Í˜'), s: 'oo$13' }, { r: createRC('Ã’Í˜'), s: 'Oo$13' },
                { r: createRC('Ã´Í˜'), s: 'oo$15' }, { r: createRC('Ã”Í˜'), s: 'Oo$15' },
                { r: createRC('Ç’Í˜'), s: 'oo$16' }, { r: createRC('Ç‘Í˜'), s: 'Oo$16' },
                { r: createRC('ÅÍ˜'), s: 'oo$17' }, { r: createRC('ÅŒÍ˜'), s: 'Oo$17' },
                { r: createRC('oÌÍ˜'), s: 'oo$18' }, { r: createRC('OÌÍ˜'), s: 'Oo$18' },
                { r: createRC('Å‘Í˜'), s: 'oo$19' }, { r: createRC('ÅÍ˜'), s: 'Oo$19' },
                // straight o
                { r: createRC('Ã³'), s: 'o$12' }, { r: createRC('Ã“'), s: 'O$12' },
                { r: createRC('Ã²'), s: 'o$13' }, { r: createRC('Ã’'), s: 'O$13' },
                { r: createRC('Ã´'), s: 'o$15' }, { r: createRC('Ã”'), s: 'O$15' },
                { r: createRC('Ç’'), s: 'o$16' }, { r: createRC('Ç‘'), s: 'O$16' },
                { r: createRC('Å'), s: 'o$17' }, { r: createRC('ÅŒ'), s: 'O$17' },
                { r: createRC('oÌ'), s: 'o$18' }, { r: createRC('OÌ'), s: 'O$18' },
                { r: createRC('Å‘'), s: 'o$19' }, { r: createRC('Å'), s: 'O$19' },
                // u
                { r: createRC('Ãº'), s: 'u$12' }, { r: createRC('Ãš'), s: 'U$12' },
                { r: createRC('Ã¹'), s: 'u$13' }, { r: createRC('Ã™'), s: 'U$13' },
                { r: createRC('Ã»'), s: 'u$15' }, { r: createRC('Ã›'), s: 'U$15' },
                { r: createRC('Ç”'), s: 'u$16' }, { r: createRC('Ç“'), s: 'U$16' },
                { r: createRC('Å«'), s: 'u$17' }, { r: createRC('Åª'), s: 'U$17' },
                { r: createRC('uÌ'), s: 'u$18' }, { r: createRC('UÌ'), s: 'U$18' },
                { r: createRC('Å±'), s: 'u$19' }, { r: createRC('Å°'), s: 'U$19' },
                // m
                { r: createRC('á¸¿'), s: 'm$12' }, { r: createRC('á¸¾'), s: 'M$12' },
                { r: createRC('mÌ€'), s: 'm$13' }, { r: createRC('MÌ€'), s: 'M$13' },
                { r: createRC('mÌ‚'), s: 'm$15' }, { r: createRC('MÌ‚'), s: 'M$15' },
                { r: createRC('mÌŒ'), s: 'm$16' }, { r: createRC('MÌŒ'), s: 'M$16' },
                { r: createRC('mÌ„'), s: 'm$17' }, { r: createRC('MÌ„'), s: 'M$17' },
                { r: createRC('mÌ'), s: 'm$18' }, { r: createRC('MÌ'), s: 'M$18' },
                { r: createRC('mÌ‹'), s: 'm$19' }, { r: createRC('MÌ‹'), s: 'M$19' },
                // n
                { r: createRC('Å„'), s: 'n$12' }, { r: createRC('Åƒ'), s: 'N$12' },
                { r: createRC('Ç¹'), s: 'n$13' }, { r: createRC('Ç¸'), s: 'N$13' },
                { r: createRC('nÌ‚'), s: 'n$15' }, { r: createRC('NÌ‚'), s: 'N$15' },
                { r: createRC('Åˆ'), s: 'n$16' }, { r: createRC('NÌ‹'), s: 'N$16' },
                { r: createRC('nÌ„'), s: 'n$17' }, { r: createRC('NÌ„'), s: 'N$17' },
                { r: createRC('nÌ'), s: 'n$18' }, { r: createRC('NÌ'), s: 'N$18' },
                { r: createRC('nÌ‹'), s: 'n$19' }, { r: createRC('NÌ‹'), s: 'N$19' }
            ];

            for (const map of TL_T2S) {
                tl_soo = tl_soo.replace(map.r, map.s);
            }

            // Handle plain oÍ˜ (no tone mark) -> oo. Must come after toned oÍ˜ conversions.
            tl_soo = tl_soo.replace(/oÍ˜/g, 'oo');
            tl_soo = tl_soo.replace(/OÍ˜/g, 'Oo');

            tl_soo = tl_soo.replace(/â¿/g, 'nn');

            if (nasal === 'N') {
                tl_soo = tl_soo.replace(/(?<=[aeiouAEIOU])nn/g, 'N'); // Lookbehind support in modern JS
            }

            if (use14) {
                const add1 = /(a|A|e|E|i|I|o|O|u|U|m|M|ng|Ng|n)\b/g;
                const add4 = /(h|p|t|k)\b/g;
                tl_soo = tl_soo.replace(add1, '$11');
                tl_soo = tl_soo.replace(add4, '$14');
            }

            return tl_soo;
        }

        // 2. TL Numbers -> POJ Numbers
        function TLsoo_2_POJsoo(tailo_soo, keep14 = false) {
            if (!tailo_soo) return '';

            let poj_soo = tailo_soo;

            if (!keep14) {
                const remove1 = /([aeiouAEIOU](?:nn|N)?|[aeiouAEIOU](?:ng|n|m)|(?:p|P|ph|Ph|m|M|b|B|t|T|th|Th|n|N|l|L|k|K|kh|Kh|ng|Ng|g|G|s|S|h|H)?(?:ng|Ng|m|M))1/g;
                poj_soo = poj_soo.replace(remove1, '$1');

                const remove4 = /([aeiouAEIOU](?:(?:nn|N)?h|p|t|k)|(?:m|M|ng|Ng)h)4/g;
                poj_soo = poj_soo.replace(remove4, '$1');
            }

            // String replacements
            const tailo2poj = [
                ['oonn', 'oÍ˜N'], ['Oonn', 'OÍ˜N'],
                ['onn', 'oÍ˜N'], ['Onn', 'OÍ˜N'],
                ['ts', 'ch'], ['Ts', 'Ch'],
                ['oo', 'oÍ˜'], ['Oo', 'OÍ˜'],
                ['ua', 'oa'], ['Ua', 'Oa'], ['ue', 'oe'], ['Ue', 'Oe'],
                ['ing', 'eng'], ['Ing', 'Eng'], ['ik', 'ek'], ['Ik', 'Ek'],
                ['nnh', 'hN'], ['Nh', 'hN'], ['hnn', 'hN']
            ];

            for (const [k, v] of tailo2poj) {
                poj_soo = poj_soo.replace(new RegExp(k, 'g'), v); // Use regex for global replace
            }

            const nn_2_N = /([aeiouAEIOU])(?:nn|N)(h?\d?)\b/g;
            poj_soo = poj_soo.replace(nn_2_N, '$1N$2');

            return poj_soo;
        }

        // 3. POJ Numbers -> POJ Tone Marks
        function POJsoo_2_POJtiau(poj_soo) {
            if (!poj_soo) return '';
            let poj_tiau = poj_soo;

            const N_2_n = /(?:N|nn)(\d?)\b/g;
            poj_tiau = poj_tiau.replace(N_2_n, 'â¿$1');

            // Mapping
            const POJ_S2T = [
                // use RC2
                { r: createRC2('a1'), s: 'a$1$2' }, { r: createRC2('A1'), s: 'A$1$2' },
                { r: createRC2('a2'), s: 'Ã¡$1$2' }, { r: createRC2('A2'), s: 'Ã$1$2' },
                { r: createRC2('a3'), s: 'Ã $1$2' }, { r: createRC2('A3'), s: 'Ã€$1$2' },
                // use RC3
                { r: createRC3_Regex('a(i|u)((?:N|â¿|nn)?)h4'), s: 'a$1$2h' },
                { r: createRC3_Regex('A(i|u)((?:N|â¿|nn)?)h4'), s: 'A$1$2h' },
                // use RC2
                { r: createRC2('a5'), s: 'Ã¢$1$2' }, { r: createRC2('A5'), s: 'Ã‚$1$2' },
                { r: createRC2('a6'), s: 'Ã¡$1$2' }, { r: createRC2('A6'), s: 'Ã$1$2' },
                { r: createRC2('a7'), s: 'Ä$1$2' }, { r: createRC2('A7'), s: 'Ä€$1$2' },
                // use RC3
                { r: createRC3_Regex('a(i|u)h(?:N|â¿|nn)8'), s: 'aÌ$1hâ¿' },
                { r: createRC3_Regex('A(i|u)h(?:N|â¿|nn)8'), s: 'AÌ$1hâ¿' },
                { r: createRC3_Regex('a(i|u)h8'), s: 'aÌ$1h' },
                { r: createRC3_Regex('A(i|u)h8'), s: 'AÌ$1h' },
                // use RC2
                { r: createRC2('a9'), s: 'Äƒ$1$2' }, { r: createRC2('A9'), s: 'Ä‚$1$2' },

                // use RC2
                { r: createRC2('u1'), s: 'u$1$2' }, { r: createRC2('U1'), s: 'U$1$2' },
                { r: createRC2('u2'), s: 'Ãº$1$2' }, { r: createRC2('U2'), s: 'Ãš$1$2' },
                { r: createRC2('u3'), s: 'Ã¹$1$2' }, { r: createRC2('U3'), s: 'Ã™$1$2' },
                // use RC3
                { r: createRC3_Regex('uih((?:N|â¿|nn)?)4'), s: 'uih$1' },
                { r: createRC3_Regex('Uih((?:N|â¿|nn)?)4'), s: 'Uih$1' },
                // use RC2
                { r: createRC2('u5'), s: 'Ã»$1$2' }, { r: createRC2('U5'), s: 'Ã›$1$2' },
                { r: createRC2('u6'), s: 'Ãº$1$2' }, { r: createRC2('U6'), s: 'Ãš$1$2' },
                { r: createRC2('u7'), s: 'Å«$1$2' }, { r: createRC2('U7'), s: 'Åª$1$2' },
                // use RC3
                { r: createRC3_Regex('uih((?:N|â¿|nn)?)8'), s: 'uÌih$1' },
                { r: createRC3_Regex('Uih((?:N|â¿|nn)?)8'), s: 'UÌih$1' },
                // use RC2
                { r: createRC2('u9'), s: 'Å­$1$2' }, { r: createRC2('U9'), s: 'Å¬$1$2' },

                // use RC3 - Complex O/o handling (oa, oe diphthongs)
                { r: createRC3_Regex('(o|O)([ae])((?:N|â¿|nn)?)1?\\b'), s: '$1$2$3' },
                { r: createRC3_Regex('o([ae])((?:N|â¿|nn)?)2\\b'), s: 'Ã³$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|â¿|nn)?)2\\b'), s: 'Ã“$1$2' },
                { r: createRC3_Regex('o([ae])((?:N|â¿|nn)?)3\\b'), s: 'Ã²$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|â¿|nn)?)3\\b'), s: 'Ã’$1$2' },
                { r: createRC3_Regex('o([ae])((?:N|â¿|nn)?)5\\b'), s: 'Ã´$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|â¿|nn)?)5\\b'), s: 'Ã”$1$2' },
                { r: createRC3_Regex('o([ae])((?:N|â¿|nn)?)6\\b'), s: 'Ã³$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|â¿|nn)?)6\\b'), s: 'Ã“$1$2' },
                { r: createRC3_Regex('o([ae])((?:N|â¿|nn)?)7\\b'), s: 'Å$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|â¿|nn)?)7\\b'), s: 'ÅŒ$1$2' },
                { r: createRC3_Regex('o([ae])((?:N|â¿|nn)?)9\\b'), s: 'Å$1$2' },
                { r: createRC3_Regex('O([ae])((?:N|â¿|nn)?)9\\b'), s: 'Å$1$2' },

                // use RC1
                { r: createRC1('a1'), s: 'a$1' }, { r: createRC1('A1'), s: 'A$1' },
                { r: createRC1('a2'), s: 'Ã¡$1' }, { r: createRC1('A2'), s: 'Ã$1' },
                { r: createRC1('a3'), s: 'Ã $1' }, { r: createRC1('A3'), s: 'Ã€$1' },
                { r: createRC4('a4'), s: 'a$1' }, { r: createRC4('A4'), s: 'A$1' },
                { r: createRC1('a5'), s: 'Ã¢$1' }, { r: createRC1('A5'), s: 'Ã‚$1' },
                { r: createRC1('a6'), s: 'Ã¡$1' }, { r: createRC1('A6'), s: 'Ã$1' },
                { r: createRC1('a7'), s: 'Ä$1' }, { r: createRC1('A7'), s: 'Ä€$1' },
                { r: createRC8('a8'), s: 'aÌ$1' }, { r: createRC8('A8'), s: 'AÌ$1' },
                { r: createRC1('a9'), s: 'Äƒ$1' }, { r: createRC1('A9'), s: 'Ä‚$1' },

                { r: createRC1('e1'), s: 'e$1' }, { r: createRC1('E1'), s: 'E$1' },
                { r: createRC1('e2'), s: 'Ã©$1' }, { r: createRC1('E2'), s: 'Ã‰$1' },
                { r: createRC1('e3'), s: 'Ã¨$1' }, { r: createRC1('E3'), s: 'Ãˆ$1' },
                { r: createRC4('e4'), s: 'e$1' }, { r: createRC4('E4'), s: 'E$1' },
                { r: createRC1('e5'), s: 'Ãª$1' }, { r: createRC1('E5'), s: 'ÃŠ$1' },
                { r: createRC1('e6'), s: 'Ã©$1' }, { r: createRC1('E6'), s: 'Ã‰$1' },
                { r: createRC1('e7'), s: 'Ä“$1' }, { r: createRC1('E7'), s: 'Ä’$1' },
                { r: createRC8('e8'), s: 'eÌ$1' }, { r: createRC8('E8'), s: 'EÌ$1' },
                { r: createRC1('e9'), s: 'Ä•$1' }, { r: createRC1('E9'), s: 'Ä”$1' },

                { r: createRC1('i1'), s: 'i$1' }, { r: createRC1('I1'), s: 'I$1' },
                { r: createRC1('i2'), s: 'Ã­$1' }, { r: createRC1('I2'), s: 'Ã$1' },
                { r: createRC1('i3'), s: 'Ã¬$1' }, { r: createRC1('I3'), s: 'ÃŒ$1' },
                { r: createRC4('i4'), s: 'i$1' }, { r: createRC4('I4'), s: 'I$1' },
                { r: createRC1('i5'), s: 'Ã®$1' }, { r: createRC1('I5'), s: 'Ã$1' },
                { r: createRC1('i6'), s: 'Ã­$1' }, { r: createRC1('I6'), s: 'Ã$1' },
                { r: createRC1('i7'), s: 'Ä«$1' }, { r: createRC1('I7'), s: 'Äª$1' },
                { r: createRC8('i8'), s: 'iÌ$1' }, { r: createRC8('I8'), s: 'IÌ$1' },
                { r: createRC1('i9'), s: 'Ä­$1' }, { r: createRC1('I9'), s: 'Ä¬$1' },

                // oÍ˜ handling
                { r: createRC1('oÍ˜1'), s: 'oÍ˜$1' }, { r: createRC1('OÍ˜1'), s: 'OÍ˜$1' },
                { r: createRC1('oÍ˜2'), s: 'Ã³Í˜$1' }, { r: createRC1('OÍ˜2'), s: 'Ã“Í˜$1' },
                { r: createRC1('oÍ˜3'), s: 'Ã²Í˜$1' }, { r: createRC1('OÍ˜3'), s: 'Ã’Í˜$1' },
                { r: createRC4('oÍ˜4'), s: 'oÍ˜$1' }, { r: createRC4('OÍ˜4'), s: 'OÍ˜$1' },
                { r: createRC1('oÍ˜5'), s: 'Ã´Í˜$1' }, { r: createRC1('OÍ˜5'), s: 'Ã”Í˜$1' },
                { r: createRC1('oÍ˜6'), s: 'Ã³Í˜$1' }, { r: createRC1('OÍ˜6'), s: 'Ã“Í˜$1' },
                { r: createRC1('oÍ˜7'), s: 'ÅÍ˜$1' }, { r: createRC1('OÍ˜7'), s: 'ÅŒÍ˜$1' },
                { r: createRC8('oÍ˜8'), s: 'oÌÍ˜$1' }, { r: createRC8('OÍ˜8'), s: 'OÌÍ˜$1' },
                { r: createRC1('oÍ˜9'), s: 'ÅÍ˜$1' }, { r: createRC1('OÍ˜9'), s: 'ÅÍ˜$1' },

                { r: createRC1('o1'), s: 'o$1' }, { r: createRC1('O1'), s: 'O$1' },
                { r: createRC1('o2'), s: 'Ã³$1' }, { r: createRC1('O2'), s: 'Ã“$1' },
                { r: createRC1('o3'), s: 'Ã²$1' }, { r: createRC1('O3'), s: 'Ã’$1' },
                { r: createRC4('o4'), s: 'o$1' }, { r: createRC4('O4'), s: 'O$1' },
                { r: createRC1('o5'), s: 'Ã´$1' }, { r: createRC1('O5'), s: 'Ã”$1' },
                { r: createRC1('o6'), s: 'Ã³$1' }, { r: createRC1('O6'), s: 'Ã“$1' },
                { r: createRC1('o7'), s: 'Å$1' }, { r: createRC1('O7'), s: 'ÅŒ$1' },
                { r: createRC8('o8'), s: 'oÌ$1' }, { r: createRC8('O8'), s: 'OÌ$1' },
                { r: createRC1('o9'), s: 'Å$1' }, { r: createRC1('O9'), s: 'Å$1' },

                { r: createRC1('u1'), s: 'u$1' }, { r: createRC1('U1'), s: 'U$1' },
                { r: createRC1('u2'), s: 'Ãº$1' }, { r: createRC1('U2'), s: 'Ãš$1' },
                { r: createRC1('u3'), s: 'Ã¹$1' }, { r: createRC1('U3'), s: 'Ã™$1' },
                { r: createRC4('u4'), s: 'u$1' }, { r: createRC4('U4'), s: 'U$1' },
                { r: createRC1('u5'), s: 'Ã»$1' }, { r: createRC1('U5'), s: 'Ã›$1' },
                { r: createRC1('u6'), s: 'Ãº$1' }, { r: createRC1('U6'), s: 'Ãš$1' },
                { r: createRC1('u7'), s: 'Å«$1' }, { r: createRC1('U7'), s: 'Åª$1' },
                { r: createRC1('u8'), s: 'uÌ$1' }, { r: createRC1('U8'), s: 'UÌ$1' },
                { r: createRC1('u9'), s: 'Å­$1' }, { r: createRC1('U9'), s: 'Å¬$1' },

                // use RC3 mappings
                { r: createRC3_Regex('m1'), s: 'm' }, { r: createRC3_Regex('M1'), s: 'M' },
                { r: createRC3_Regex('m2'), s: 'á¸¿' }, { r: createRC3_Regex('M2'), s: 'á¸¾' },
                { r: createRC3_Regex('m3'), s: 'mÌ€' }, { r: createRC3_Regex('M3'), s: 'MÌ€' },
                { r: createRC3_Regex('mh4'), s: 'mh' }, { r: createRC3_Regex('Mh4'), s: 'Mh' },
                { r: createRC3_Regex('m5'), s: 'mÌ‚' }, { r: createRC3_Regex('M5'), s: 'MÌ‚' },
                { r: createRC3_Regex('m6'), s: 'á¸¿' }, { r: createRC3_Regex('M6'), s: 'á¸¾' },
                { r: createRC3_Regex('m7'), s: 'mÌ„' }, { r: createRC3_Regex('M7'), s: 'MÌ„' },
                { r: createRC3_Regex('mh8'), s: 'mÌh' }, { r: createRC3_Regex('Mh8'), s: 'MÌh' },
                { r: createRC3_Regex('m9'), s: 'mÌ†' }, { r: createRC3_Regex('M9'), s: 'MÌ†' },

                { r: createRC3_Regex('ng1'), s: 'ng' }, { r: createRC3_Regex('Ng1'), s: 'Ng' },
                { r: createRC3_Regex('ng2'), s: 'Å„g' }, { r: createRC3_Regex('Ng2'), s: 'Åƒg' },
                { r: createRC3_Regex('ng3'), s: 'Ç¹g' }, { r: createRC3_Regex('Ng3'), s: 'Ç¸g' },
                { r: createRC3_Regex('ngh4'), s: 'ngh' }, { r: createRC3_Regex('Ngh4'), s: 'Ngh' },
                { r: createRC3_Regex('ng5'), s: 'nÌ‚g' }, { r: createRC3_Regex('Ng5'), s: 'NÌ‚g' },
                { r: createRC3_Regex('ng6'), s: 'Å„g' }, { r: createRC3_Regex('Ng6'), s: 'Åƒg' },
                { r: createRC3_Regex('ng7'), s: 'nÌ„g' }, { r: createRC3_Regex('Ng7'), s: 'NÌ„g' },
                { r: createRC3_Regex('ngh8'), s: 'nÌgh' }, { r: createRC3_Regex('Ngh8'), s: 'NÌgh' },
                { r: createRC3_Regex('ng9'), s: 'nÌ†g' }, { r: createRC3_Regex('Ng9'), s: 'NÌ†g' }
            ];

            for (const map of POJ_S2T) {
                poj_tiau = poj_tiau.replace(map.r, map.s);
            }

            return poj_tiau;
        }

        function TLtiau_2_POJtiau(tl_tiau) {
            // 0. Handle escape sequences: \[text] is preserved as-is
            const escapeRegex = /\\\[([^\]]*)\]/g;
            const escapes = [];
            let processedInput = tl_tiau.replace(escapeRegex, (match, content) => {
                escapes.push(content);
                return `âŸªESC${escapes.length - 1}âŸ«`;
            });

            // 1. Convert TL-style tone marks to corresponding numbers
            const tl_soo = TLtiau_2_TLsoo(processedInput);
            // 2. Convert TL number-style to POJ number-style
            const poj_soo = TLsoo_2_POJsoo(tl_soo);
            // 3. Convert POJ number-style to POJ tone marks
            let poj_tiau = POJsoo_2_POJtiau(poj_soo);

            // 4. Restore escaped content
            poj_tiau = poj_tiau.replace(/âŸªESC(\d+)âŸ«/g, (match, index) => {
                return escapes[parseInt(index)];
            });

            return poj_tiau;
        }

        // --- UI Logic ---

        function clearInput(id) {
            const el = document.getElementById(id);
            el.value = '';
            el.dispatchEvent(new Event('input'));
        }

        async function downloadCleanVersion() {
            if (!confirm(UI_STRINGS.messages.downloadConfirm)) {
                return;
            }

            try {
                const btn = document.getElementById('ui-btn-download-offline');
                const originalText = btn.innerText;
                btn.innerText = 'Downloading...';
                btn.disabled = true;

                const res = await fetch('https://raw.githubusercontent.com/CyberOoHim/CyberOoHim.github.io/main/pages/tl_poj_converter.html');
                let text = await res.text();

                // Strip Jekyll front matter (---...---) and the HTML comment after it
                text = text.replace(/^---[\s\S]*?---\n/, '');
                text = text.replace(/^< !--[\s\S ]*?- ->\n/, '');
                text = text.trim();

                const blob = new Blob([text], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'tl_poj_converter.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                btn.innerText = originalText;
                btn.disabled = false;
            } catch (err) {
                console.error('Download failed:', err);
                alert('Download failed. Please try again.');
            }
        }

        function injectTestText() {
            const rtInput = document.getElementById('rt-input');
            rtInput.value = UI_STRINGS.testSample;
            rtInput.dispatchEvent(new Event('input'));
        }

        function switchMode(mode) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));

            document.getElementById(`ui-tab-${mode}`).classList.add('active');
            document.getElementById(`panel-${mode}`).classList.add('active');
        }

        // Real-time conversion
        const rtInput = document.getElementById('rt-input');
        const rtOutput = document.getElementById('rt-output');

        rtInput.addEventListener('input', (e) => {
            const text = e.target.value;
            const converted = TLtiau_2_POJtiau(text);
            rtOutput.value = converted;
        });

        // File conversion - State variables
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const outputPreview = document.getElementById('outputPreview');
        const fileOutputSection = document.getElementById('fileOutputSection');
        const btnChooseFile = document.getElementById('btn-choose-file');

        let currentFileOutput = '';
        let currentFileName = 'poj_output.txt';

        // CSV State
        let currentCsvData = null;
        let currentCsvSeparator = ',';
        const csvColumnsList = document.getElementById('csv-columns-list');

        // JSON State
        let currentJsonData = null;
        let currentJsonRawContent = '';
        let currentJsonPaths = [];
        let currentJsonIsArray = false;

        // Subtitle State
        let currentSubtitleData = null;
        let currentSubtitleRawContent = '';
        let currentSubtitleExt = 'srt';

        // Event Listeners
        btnChooseFile.addEventListener('click', (e) => {
            e.stopPropagation();
            fileInput.click();
        });
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) processFile(e.target.files[0]);
        });

        // Reset View
        function resetFileView() {
            const expander = document.getElementById('file-upload-expander');
            if (expander) expander.open = true;
            document.getElementById('csv-options-expander').style.display = 'none';
            document.getElementById('json-options-expander').style.display = 'none';
            document.getElementById('subtitle-options-expander').style.display = 'none';
            fileOutputSection.style.display = 'none';
            document.getElementById('csv-preview-table-container').style.display = 'none';
            outputPreview.style.display = 'block';
            currentCsvData = null;
            currentJsonData = null;
            currentJsonPaths = [];
            currentSubtitleData = null;
            fileInput.value = '';
            currentFileOutput = '';
        }

        // Helper: Dynamically load a script
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Reset button handlers
        document.getElementById('btn-reset-csv').addEventListener('click', resetFileView);
        document.getElementById('btn-reset-json').addEventListener('click', resetFileView);
        document.getElementById('btn-reset-subtitle').addEventListener('click', resetFileView);
        document.getElementById('btn-reset-file').addEventListener('click', resetFileView);

        // Copy/Download for file output
        document.getElementById('btn-copy-file').addEventListener('click', async () => {
            if (currentFileOutput) {
                await navigator.clipboard.writeText(currentFileOutput);
                const btn = document.getElementById('ui-btn-copy-file');
                const original = btn.innerText;
                btn.innerText = UI_STRINGS.buttons.copied;
                setTimeout(() => btn.innerText = original, 2000);
            }
        });

        document.getElementById('btn-download-file').addEventListener('click', () => {
            if (currentFileOutput) {
                downloadTextContent(currentFileOutput, currentFileName);
            }
        });

        // Helper: Download text content
        function downloadTextContent(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Helper: Update preview label with file type
        function updatePreviewLabel(type) {
            const label = document.getElementById('ui-label-result');
            if (label && UI_STRINGS.file.fileTypes[type]) {
                label.innerText = UI_STRINGS.file.previewLabel + UI_STRINGS.file.fileTypes[type];
            } else if (label) {
                label.innerText = UI_STRINGS.file.previewLabel + UI_STRINGS.file.fileTypes.text;
            }

            // Toggle specific messages
            const msgSpecific = document.getElementById('msg-specific-warning');
            if (msgSpecific) {
                if (type === 'pdf') {
                    msgSpecific.innerText = ' ' + UI_STRINGS.file.messages.pdf;
                    msgSpecific.style.display = 'inline';
                } else {
                    msgSpecific.style.display = 'none';
                }
            }
        }

        // Parse CSV/TSV
        function parseCSV(text, separator) {
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length === 0) return null;

            const headers = lines[0].split(separator).map(h => h.trim());
            const rows = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(separator);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((h, index) => {
                        row[h] = values[index];
                    });
                    rows.push(row);
                }
            }
            return { headers, rows, rawLines: lines };
        }

        // Generate CSV
        function generateCSV(headers, rows, separator) {
            const headerLine = headers.join(separator);
            const dataLines = rows.map(row => {
                return headers.map(h => row[h] || '').join(separator);
            }).join('\n');
            return headerLine + '\n' + dataLines;
        }

        // Render Table
        function renderTable(headers, rows) {
            const table = document.createElement('table');
            table.id = 'csv-preview-table';

            const thead = document.createElement('thead');
            const trHead = document.createElement('tr');
            headers.forEach(h => {
                const th = document.createElement('th');
                th.textContent = h;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            rows.slice(0, 100).forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(h => {
                    const td = document.createElement('td');
                    td.textContent = row[h];
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            return table;
        }

        // Extract JSON Keys
        function extractJsonKeys(obj) {
            const keys = [];

            if (Array.isArray(obj) && obj.length > 0 && typeof obj[0] === 'object' && obj[0] !== null) {
                currentJsonIsArray = true;
                const schemaKeys = Object.keys(obj[0]);
                schemaKeys.forEach(key => {
                    if (typeof obj[0][key] === 'string') {
                        const count = obj.filter(item => typeof item[key] === 'string').length;
                        keys.push({
                            key: key,
                            isArrayKey: true,
                            sampleValue: obj[0][key],
                            count: count
                        });
                    }
                });
            } else if (typeof obj === 'object' && obj !== null) {
                currentJsonIsArray = false;
                function traverse(current, path) {
                    if (typeof current === 'string') {
                        keys.push({
                            key: path,
                            isArrayKey: false,
                            sampleValue: current,
                            count: 1
                        });
                    } else if (Array.isArray(current)) {
                        current.forEach((item, i) => {
                            traverse(item, `${path}[${i}]`);
                        });
                    } else if (current !== null && typeof current === 'object') {
                        Object.keys(current).forEach(k => {
                            const newPath = path ? `${path}.${k}` : k;
                            traverse(current[k], newPath);
                        });
                    }
                }
                traverse(obj, '');
            }

            return keys;
        }

        // Set nested value in object
        function setNestedValue(obj, path, value) {
            const parts = path.replace(/\[(\d+)\]/g, '.$1').split('.');
            let current = obj;
            for (let i = 0; i < parts.length - 1; i++) {
                const key = parts[i];
                const nextKey = parts[i + 1];
                if (!(key in current)) {
                    current[key] = /^\d+$/.test(nextKey) ? [] : {};
                }
                current = current[key];
            }
            current[parts[parts.length - 1]] = value;
        }

        // Helper to detect timecode lines (both standard and bracket formats)
        function isTimecode(line) {
            if (!line) return false;
            // Standard SRT/VTT: 00:00:00,000 --> 00:00:00,000
            if (line.includes('-->')) return true;
            // Bracket style: [00:00] or [00:00:00]
            if (/^\s*\[\d{1,2}:\d{2}(?::\d{2})?\]/.test(line)) return true;
            return false;
        }

        // Smart detection for subtitle format in .txt files
        function detectSubtitleFormat(content) {
            const lines = content.split(/\r?\n/).slice(0, 50);

            // VTT header check
            if (lines[0]?.trim().toUpperCase() === 'WEBVTT') return 'vtt';

            // SRT/VTT timecode pattern
            const srtTimecodePattern = /\d{1,2}:\d{2}(?::\d{2})?[,.:]\d{3}\s*-->/;
            const bracketTimecodePattern = /^\s*\[\d{1,2}:\d{2}(?::\d{2})?\]/;

            let bracketCount = 0;
            for (const line of lines) {
                if (srtTimecodePattern.test(line)) return 'srt';
                if (bracketTimecodePattern.test(line)) bracketCount++;
            }

            if (bracketCount >= 3) return 'srt';
            return null;
        }

        // Parse Subtitle (SRT/VTT) with bracket timecode and header support
        function parseSubtitle(content, ext) {
            const lines = content.split(/\r?\n/);
            const blocks = [];
            let i = 0;
            const headerLines = { urlLines: [], titleBlock: null };

            // Parse header section (before first timecode) for URL and TITLE
            while (i < lines.length && !isTimecode(lines[i])) {
                const line = lines[i].trim();
                if (/^url:/i.test(line)) {
                    headerLines.urlLines.push(lines[i]);
                } else if (/^title:/i.test(line)) {
                    const match = lines[i].match(/^(title:\s*)/i);
                    const prefix = match ? match[1] : 'TITLE: ';
                    const firstLineContent = lines[i].substring(prefix.length);
                    const titleTextLines = [];
                    if (firstLineContent.trim() !== '') {
                        titleTextLines.push(firstLineContent);
                    }
                    i++;
                    while (i < lines.length && lines[i].trim() !== '' && !isTimecode(lines[i])) {
                        titleTextLines.push(lines[i]);
                        i++;
                    }
                    headerLines.titleBlock = { prefix, textLines: titleTextLines };
                    continue;
                }
                i++;
            }

            // Parse subtitle blocks
            while (i < lines.length) {
                while (i < lines.length && lines[i].trim() === '') i++;
                if (i >= lines.length) break;

                const block = { cueId: '', timestamp: '', textLines: [], rawLines: [] };

                if (isTimecode(lines[i])) {
                    block.timestamp = lines[i];
                    block.rawLines.push(lines[i]);
                    i++;
                } else {
                    block.cueId = lines[i];
                    block.rawLines.push(lines[i]);
                    i++;

                    if (i < lines.length && isTimecode(lines[i])) {
                        block.timestamp = lines[i];
                        block.rawLines.push(lines[i]);
                        i++;
                    }
                }

                // Text lines until empty line or next timecode
                while (i < lines.length && lines[i].trim() !== '' && !isTimecode(lines[i])) {
                    const line = lines[i];
                    block.rawLines.push(line);
                    block.textLines.push({ text: line, isUrl: false });
                    i++;
                }

                if (block.timestamp || block.textLines.length > 0) {
                    blocks.push(block);
                }
            }

            return { blocks, headerLines };
        }

        // Convert Subtitle based on mode
        function convertSubtitle(parsed, mode) {
            const resultLines = [];

            // Add header lines first
            // URL lines - preserved as-is
            if (parsed.headerLines) {
                parsed.headerLines.urlLines.forEach(line => {
                    resultLines.push(line);
                });

                // TITLE block - apply same line selection rules as subtitle blocks
                if (parsed.headerLines.titleBlock) {
                    const titleBlock = parsed.headerLines.titleBlock;
                    titleBlock.textLines.forEach((lineText, lineIndex) => {
                        const lineNum = lineIndex + 1;
                        let shouldConvert = false;

                        if (mode === 'all') shouldConvert = true;
                        else if (mode === 'line1' && lineNum === 1) shouldConvert = true;
                        else if (mode === 'line2' && lineNum === 2) shouldConvert = true;
                        else if (mode === 'line3plus' && lineNum >= 3) shouldConvert = true;

                        const prefix = lineIndex === 0 ? titleBlock.prefix : '';
                        if (shouldConvert) {
                            resultLines.push(prefix + TLtiau_2_POJtiau(lineText));
                        } else {
                            resultLines.push(prefix + lineText);
                        }
                    });
                }

                // Add blank line after header if there were header lines
                if (parsed.headerLines.urlLines.length > 0 || parsed.headerLines.titleBlock) {
                    resultLines.push('');
                }
            }

            parsed.blocks.forEach(block => {
                if (block.cueId) resultLines.push(block.cueId);
                resultLines.push(block.timestamp);

                block.textLines.forEach((lineObj, lineIndex) => {
                    const lineNum = lineIndex + 1;
                    let shouldConvert = false;

                    if (mode === 'all') shouldConvert = true;
                    else if (mode === 'line1' && lineNum === 1) shouldConvert = true;
                    else if (mode === 'line2' && lineNum === 2) shouldConvert = true;
                    else if (mode === 'line3plus' && lineNum >= 3) shouldConvert = true;

                    if (shouldConvert) {
                        resultLines.push(TLtiau_2_POJtiau(lineObj.text));
                    } else {
                        resultLines.push(lineObj.text);
                    }
                });

                resultLines.push('');
            });

            return resultLines.join('\n');
        }

        // Main File Processor
        function processFile(file) {
            const allowedExtensions = ['.txt', '.md', '.srt', '.vtt', '.csv', '.tsv', '.json', '.pdf'];
            const fileName = file.name.toLowerCase();

            const namePart = file.name.substring(0, file.name.lastIndexOf('.'));
            const extPart = file.name.substring(file.name.lastIndexOf('.'));
            currentFileName = `${namePart}_POJ${extPart}`;

            const isValid = allowedExtensions.some(ext => fileName.endsWith(ext));
            if (!isValid) {
                alert('File type not supported. Please upload one of: ' + allowedExtensions.join(', '));
                return;
            }

            const isCsv = fileName.endsWith('.csv') || fileName.endsWith('.tsv');
            const isPdf = fileName.endsWith('.pdf');
            const separator = fileName.endsWith('.tsv') ? '\t' : ',';

            // Handle PDF separately with ArrayBuffer reader
            if (isPdf) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        // Dynamically load PDF.js if not already loaded
                        if (typeof pdfjsLib === 'undefined') {
                            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js');
                            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                        }

                        const pdf = await pdfjsLib.getDocument({ data: e.target.result }).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            // Preserve newlines by checking hasEOL property on each text item
                            let pageText = '';
                            textContent.items.forEach(item => {
                                pageText += item.str;
                                if (item.hasEOL) {
                                    pageText += '\n';
                                }
                            });
                            fullText += pageText + '\n';
                        }

                        // Collapse upload expander
                        document.getElementById('file-upload-expander').open = false;
                        document.getElementById('csv-options-expander').style.display = 'none';
                        document.getElementById('json-options-expander').style.display = 'none';
                        document.getElementById('subtitle-options-expander').style.display = 'none';

                        const converted = TLtiau_2_POJtiau(fullText);
                        currentFileOutput = converted;
                        updatePreviewLabel('pdf');
                        document.getElementById('csv-preview-table-container').style.display = 'none';
                        outputPreview.style.display = 'block';
                        outputPreview.value = converted.slice(0, 2000) + (converted.length > 2000 ? UI_STRINGS.messages.truncated : '');
                        fileOutputSection.style.display = 'block';
                    } catch (error) {
                        console.error('PDF parsing error:', error);
                        alert('Failed to parse PDF: ' + error.message);
                    }
                };
                reader.readAsArrayBuffer(file);
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;

                // Collapse upload expander
                document.getElementById('file-upload-expander').open = false;

                if (isCsv) {
                    // CSV/TSV Mode
                    currentCsvSeparator = separator;
                    const parsed = parseCSV(content, separator);
                    if (parsed && parsed.headers.length > 0) {
                        currentCsvData = parsed;

                        updatePreviewLabel(fileName.endsWith('.tsv') ? 'tsv' : 'csv');

                        document.getElementById('csv-options-expander').style.display = 'block';
                        document.getElementById('csv-options-expander').open = true;
                        document.getElementById('json-options-expander').style.display = 'none';
                        document.getElementById('subtitle-options-expander').style.display = 'none';
                        fileOutputSection.style.display = 'none';

                        // Populate columns
                        csvColumnsList.innerHTML = '';
                        parsed.headers.forEach(header => {
                            const div = document.createElement('div');
                            div.style.display = 'flex';
                            div.style.alignItems = 'center';
                            div.style.gap = '0.5rem';

                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.value = header;
                            checkbox.id = `col-${header}`;

                            const label = document.createElement('label');
                            label.htmlFor = `col-${header}`;
                            label.textContent = header;
                            label.style.cursor = 'pointer';

                            div.appendChild(checkbox);
                            div.appendChild(label);
                            csvColumnsList.appendChild(div);
                        });
                    }
                } else if (fileName.endsWith('.json')) {
                    // JSON Mode
                    try {
                        const jsonData = JSON.parse(content);
                        currentJsonData = jsonData;
                        currentJsonRawContent = content;

                        updatePreviewLabel('json');

                        document.getElementById('csv-options-expander').style.display = 'none';
                        document.getElementById('json-options-expander').style.display = 'block';
                        document.getElementById('json-options-expander').open = true;
                        document.getElementById('subtitle-options-expander').style.display = 'none';
                        fileOutputSection.style.display = 'none';

                        const keys = extractJsonKeys(jsonData);
                        currentJsonPaths = keys;

                        const jsonKeysList = document.getElementById('json-keys-list');
                        jsonKeysList.innerHTML = '';
                        keys.forEach((keyInfo, index) => {
                            const div = document.createElement('div');
                            div.style.display = 'flex';
                            div.style.alignItems = 'flex-start';
                            div.style.gap = '0.5rem';

                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.value = index;
                            checkbox.id = `json-key-${index}`;

                            const label = document.createElement('label');
                            label.htmlFor = `json-key-${index}`;
                            label.style.cursor = 'pointer';
                            label.style.wordBreak = 'break-all';

                            const preview = keyInfo.sampleValue.length > 25 ? keyInfo.sampleValue.slice(0, 25) + '...' : keyInfo.sampleValue;
                            if (keyInfo.isArrayKey) {
                                label.textContent = `${keyInfo.key} (Ã—${keyInfo.count}): "${preview}"`;
                            } else {
                                label.textContent = `${keyInfo.key}: "${preview}"`;
                            }

                            div.appendChild(checkbox);
                            div.appendChild(label);
                            jsonKeysList.appendChild(div);
                        });
                    } catch (err) {
                        alert('Failed to parse JSON: ' + err.message);
                    }
                } else if (fileName.endsWith('.srt') || fileName.endsWith('.vtt')) {
                    // Subtitle Mode
                    const ext = fileName.endsWith('.vtt') ? 'vtt' : 'srt';
                    updatePreviewLabel(ext);

                    const parsedSubtitle = parseSubtitle(content, ext);
                    currentSubtitleData = parsedSubtitle;
                    currentSubtitleRawContent = content;
                    currentSubtitleExt = ext;

                    const hasMultiLine = parsedSubtitle.blocks.some(b => b.textLines.length > 1);

                    document.getElementById('csv-options-expander').style.display = 'none';
                    document.getElementById('json-options-expander').style.display = 'none';

                    if (hasMultiLine) {
                        document.getElementById('subtitle-options-expander').style.display = 'block';
                        document.getElementById('subtitle-options-expander').open = true;
                        fileOutputSection.style.display = 'none';
                    } else {
                        document.getElementById('subtitle-options-expander').style.display = 'none';
                        const converted = convertSubtitle(parsedSubtitle, 'all');
                        currentFileOutput = converted;
                        document.getElementById('csv-preview-table-container').style.display = 'none';
                        outputPreview.style.display = 'block';
                        outputPreview.value = converted.slice(0, 2000) + (converted.length > 2000 ? UI_STRINGS.messages.truncated : '');
                        fileOutputSection.style.display = 'block';
                    }
                } else {
                    // Standard Mode (txt, md) - with smart subtitle detection for .txt
                    const ext = fileName.substring(fileName.lastIndexOf('.') + 1);

                    // Smart detect subtitle format in .txt files
                    if (ext === 'txt') {
                        const detectedFormat = detectSubtitleFormat(content);
                        if (detectedFormat) {
                            // Show confirmation dialog
                            const useSubtitleMode = confirm(UI_STRINGS.subtitle?.detectPrompt || "é€™ä»½ .txt çœ‹èµ·ä¾†æœ‰å­—å¹•æ™‚æ¨™ï¼ŒkÃ m beh ç”¨å­—å¹•æ¨¡å¼è½‰ï¼Ÿ");
                            if (useSubtitleMode) {
                                // User chose subtitle mode
                                currentFileName = currentFileName.replace(/\.txt$/i, '.' + detectedFormat);
                                updatePreviewLabel(detectedFormat);

                                const parsedSubtitle = parseSubtitle(content, detectedFormat);
                                currentSubtitleData = parsedSubtitle;
                                currentSubtitleRawContent = content;
                                currentSubtitleExt = detectedFormat;

                                const hasMultiLine = parsedSubtitle.blocks.some(b => b.textLines.length > 1);

                                document.getElementById('csv-options-expander').style.display = 'none';
                                document.getElementById('json-options-expander').style.display = 'none';

                                if (hasMultiLine) {
                                    document.getElementById('subtitle-options-expander').style.display = 'block';
                                    document.getElementById('subtitle-options-expander').open = true;
                                    fileOutputSection.style.display = 'none';
                                } else {
                                    document.getElementById('subtitle-options-expander').style.display = 'none';
                                    const converted = convertSubtitle(parsedSubtitle, 'all');
                                    currentFileOutput = converted;
                                    document.getElementById('csv-preview-table-container').style.display = 'none';
                                    outputPreview.style.display = 'block';
                                    outputPreview.value = converted.slice(0, 2000) + (converted.length > 2000 ? UI_STRINGS.messages.truncated : '');
                                    fileOutputSection.style.display = 'block';
                                }
                                return; // Exit, async subtitle handling done
                            }
                            // User chose plain text mode - fall through
                        }
                    }

                    // Process as plain text (md or txt without subtitle format)
                    updatePreviewLabel(ext === 'md' ? 'md' : 'text');

                    document.getElementById('csv-options-expander').style.display = 'none';
                    document.getElementById('json-options-expander').style.display = 'none';
                    document.getElementById('subtitle-options-expander').style.display = 'none';
                    document.getElementById('csv-preview-table-container').style.display = 'none';
                    outputPreview.style.display = 'block';

                    const converted = TLtiau_2_POJtiau(content);
                    currentFileOutput = converted;
                    outputPreview.value = converted.slice(0, 2000) + (converted.length > 2000 ? UI_STRINGS.messages.truncated : '');
                    fileOutputSection.style.display = 'block';
                }
            };
            reader.readAsText(file);
        }

        // CSV Convert Button
        document.getElementById('btn-convert-csv').addEventListener('click', () => {
            if (!currentCsvData) return;

            const checkboxes = csvColumnsList.querySelectorAll('input[type="checkbox"]:checked');
            const selectedCols = Array.from(checkboxes).map(cb => cb.value);

            if (selectedCols.length === 0) {
                alert("Please select at least one column to convert.");
                return;
            }

            const mode = document.querySelector('input[name="csv-mode"]:checked').value;

            // Convert selected columns
            const convertedData = {};
            selectedCols.forEach(col => {
                const colValues = currentCsvData.rows.map(r => r[col] || '');
                const combinedText = colValues.join('\n:::SEP:::\n');
                const convertedCombined = TLtiau_2_POJtiau(combinedText);
                convertedData[col] = convertedCombined.split('\n:::SEP:::\n');
            });

            // Build new headers and rows
            const newHeaders = [];
            const finalRows = currentCsvData.rows.map(() => ({}));

            if (mode === 'insert') {
                currentCsvData.headers.forEach(h => {
                    newHeaders.push(h);
                    currentCsvData.rows.forEach((row, i) => {
                        finalRows[i][h] = row[h];
                    });

                    if (selectedCols.includes(h)) {
                        const pojColName = h + '_POJ';
                        newHeaders.push(pojColName);
                        currentCsvData.rows.forEach((row, i) => {
                            finalRows[i][pojColName] = convertedData[h][i] || '';
                        });
                    }
                });
            } else if (mode === 'original-plus') {
                selectedCols.forEach(col => {
                    newHeaders.push(col);
                    currentCsvData.rows.forEach((row, i) => {
                        finalRows[i][col] = row[col];
                    });

                    const pojColName = col + '_POJ';
                    newHeaders.push(pojColName);
                    currentCsvData.rows.forEach((row, i) => {
                        finalRows[i][pojColName] = convertedData[col][i] || '';
                    });
                });
            } else {
                // 'only' mode
                selectedCols.forEach(col => {
                    const pojColName = col + '_POJ';
                    newHeaders.push(pojColName);
                    currentCsvData.rows.forEach((row, i) => {
                        finalRows[i][pojColName] = convertedData[col][i] || '';
                    });
                });
            }

            const resultCSV = generateCSV(newHeaders, finalRows, currentCsvSeparator);
            currentFileOutput = resultCSV;

            const tableContainer = document.getElementById('csv-preview-table-container');
            tableContainer.innerHTML = '';
            tableContainer.appendChild(renderTable(newHeaders, finalRows));
            tableContainer.style.display = 'block';
            outputPreview.style.display = 'none';

            document.getElementById('csv-options-expander').open = false;
            fileOutputSection.style.display = 'block';
        });

        // JSON Convert Button
        document.getElementById('btn-convert-json').addEventListener('click', () => {
            if (!currentJsonData) return;

            const jsonKeysList = document.getElementById('json-keys-list');
            const checkboxes = jsonKeysList.querySelectorAll('input[type="checkbox"]:checked');
            const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (selectedIndices.length === 0) {
                alert("Please select at least one key to convert.");
                return;
            }

            const mode = document.querySelector('input[name="json-mode"]:checked').value;
            const selectedKeys = selectedIndices.map(i => currentJsonPaths[i]);

            let result;

            if (currentJsonIsArray) {
                const convertedData = {};

                selectedKeys.forEach(keyInfo => {
                    const values = currentJsonData.map(item => item[keyInfo.key] || '');
                    const combined = values.join('\n:::JSON_SEP:::\n');
                    const converted = TLtiau_2_POJtiau(combined);
                    convertedData[keyInfo.key] = converted.split('\n:::JSON_SEP:::\n');
                });

                if (mode === 'only') {
                    result = currentJsonData.map((item, i) => {
                        const newItem = {};
                        selectedKeys.forEach(keyInfo => {
                            newItem[keyInfo.key + '_POJ'] = convertedData[keyInfo.key][i] || '';
                        });
                        return newItem;
                    });
                } else if (mode === 'original-plus') {
                    result = currentJsonData.map((item, i) => {
                        const newItem = {};
                        selectedKeys.forEach(keyInfo => {
                            newItem[keyInfo.key] = item[keyInfo.key];
                            newItem[keyInfo.key + '_POJ'] = convertedData[keyInfo.key][i] || '';
                        });
                        return newItem;
                    });
                } else {
                    const selectedKeyNames = new Set(selectedKeys.map(k => k.key));
                    result = currentJsonData.map((item, i) => {
                        const newItem = {};
                        Object.keys(item).forEach(key => {
                            newItem[key] = item[key];
                            if (selectedKeyNames.has(key)) {
                                newItem[key + '_POJ'] = convertedData[key][i] || '';
                            }
                        });
                        return newItem;
                    });
                }
            } else {
                const combinedText = selectedKeys.map(k => k.sampleValue).join('\n:::JSON_SEP:::\n');
                const convertedCombined = TLtiau_2_POJtiau(combinedText);
                const convertedValues = convertedCombined.split('\n:::JSON_SEP:::\n');

                if (mode === 'only') {
                    result = {};
                    selectedKeys.forEach((keyInfo, i) => {
                        setNestedValue(result, keyInfo.key + '_POJ', convertedValues[i] || '');
                    });
                } else if (mode === 'original-plus') {
                    result = {};
                    selectedKeys.forEach((keyInfo, i) => {
                        setNestedValue(result, keyInfo.key, keyInfo.sampleValue);
                        setNestedValue(result, keyInfo.key + '_POJ', convertedValues[i] || '');
                    });
                } else {
                    result = JSON.parse(JSON.stringify(currentJsonData));
                    selectedKeys.forEach((keyInfo, i) => {
                        setNestedValue(result, keyInfo.key + '_POJ', convertedValues[i] || '');
                    });
                }
            }

            const prettyJson = JSON.stringify(result, null, 2);
            currentFileOutput = prettyJson;

            document.getElementById('csv-preview-table-container').style.display = 'none';
            outputPreview.style.display = 'block';
            outputPreview.value = prettyJson.slice(0, 5000) + (prettyJson.length > 5000 ? '\n...(truncated)' : '');

            document.getElementById('json-options-expander').open = false;
            fileOutputSection.style.display = 'block';
        });

        // Subtitle Convert Button
        document.getElementById('btn-convert-subtitle').addEventListener('click', () => {
            if (!currentSubtitleData) return;

            const mode = document.querySelector('input[name="subtitle-mode"]:checked').value;
            const converted = convertSubtitle(currentSubtitleData, mode);
            currentFileOutput = converted;

            document.getElementById('csv-preview-table-container').style.display = 'none';
            outputPreview.style.display = 'block';
            outputPreview.value = converted.slice(0, 2000) + (converted.length > 2000 ? '\n...' : '');

            document.getElementById('subtitle-options-expander').open = false;
            fileOutputSection.style.display = 'block';
        });

        // Clipboard and Download Helpers
        async function copyToClipboard(elementId, feedbackElementId) {
            const el = document.getElementById(elementId);
            if (!el) return;

            // For textarea, we can select and copy, or use Clipboard API
            // Clipboard API is cleaner
            try {
                // If it's the preview showing truncated text, we should copy the FULL text if possible
                // But we store full text in variables for file mode.
                // For RT, the textarea has the full text.
                let textToCopy = el.value;
                if (elementId === 'outputPreview' && currentFileOutput) {
                    textToCopy = currentFileOutput; // Copy full file content
                }

                await navigator.clipboard.writeText(textToCopy);

                // Visual feedback (optional)
                if (feedbackElementId) {
                    const btnSpan = document.getElementById(feedbackElementId);
                    if (btnSpan) {
                        const originalText = btnSpan.innerText;
                        btnSpan.innerText = UI_STRINGS.buttons.copied;
                        setTimeout(() => btnSpan.innerText = originalText, 2000);
                    }
                }

            } catch (err) {
                console.error('Failed to copy: ', err);
                // Fallback: select and execCommand
                el.select();
                document.execCommand('copy');
            }
        }

        async function pasteFromClipboard(elementId) {
            try {
                const text = await navigator.clipboard.readText();
                const el = document.getElementById(elementId);
                if (el) {
                    el.value = text;
                    // Trigger input event for real-time conversion
                    el.dispatchEvent(new Event('input'));
                }
            } catch (err) {
                console.error('Failed to read clipboard: ', err);
                alert(UI_STRINGS.messages.clipboardError);
            }
        }

        function downloadText(elementId, filename) {
            let content = '';
            if (elementId === 'outputPreview' && currentFileOutput) {
                content = currentFileOutput;
            } else {
                content = document.getElementById(elementId).value;
            }

            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- Tests (set DEBUG_TESTS = true to enable) ---
        const DEBUG_TESTS = false;

        if (DEBUG_TESTS) {
            console.log("Running self-test...");
            const tests = [
                { in: "phah", out: "phah" },
                { in: "TÃ¢i-uÃ¢n", out: "TÃ¢i-oÃ¢n" },
                { in: "tsuÃ­", out: "chÃºi" },
                { in: "tshuÃ­", out: "chhÃºi" },
                { in: "ing", out: "eng" },
                { in: "Ã³o", out: "Ã³Í˜" }, // Tricky oo case: TL Ã³o -> POJ Ã³Í˜
                { in: "Ã“o", out: "Ã“Í˜" },
                { in: "oo", out: "oÍ˜" }, // Plain oo -> oÍ˜
                { in: "Oo", out: "OÍ˜" }, // Capital Oo -> OÍ˜
                { in: "oÍ˜", out: "oÍ˜" }, // Already oÍ˜ stays oÍ˜
                { in: "tsa", out: "cha" },
                { in: "ua", out: "oa" }, // TL ua -> POJ oa
                { in: "ue", out: "oe" }, // TL ue -> POJ oe
                { in: "ik", out: "ek" }, // Robustness check
                { in: "iÌk", out: "eÌk" },  // Robustness check
                // Numeric Tone Tests
                { in: "Tai5-uan5", out: "TÃ¢i-oÃ¢n" },
                { in: "sui2", out: "sÃºi" },
                { in: "phah4", out: "phah" }, // Tone 4 (none)
                { in: "tik8", out: "teÌk" }, // Tone 8 (vertical line)
                { in: "oo7", out: "ÅÍ˜" }, // Numeric oo
                { in: "m2", out: "á¸¿" }, // Syllabic nasal m
                { in: "ng5", out: "nÌ‚g" }, // Syllabic nasal ng

                // Comprehensive Tone Number Tests (1-9)
                { in: "a1", out: "a" },
                { in: "a2", out: "Ã¡" },
                { in: "a3", out: "Ã " },
                { in: "ah4", out: "ah" },
                { in: "a5", out: "Ã¢" },
                { in: "a6", out: "Ã¡" }, // Same as tone 2
                { in: "a7", out: "Ä" },
                { in: "ah8", out: "aÌh" },
                { in: "a9", out: "Äƒ" },
                // Tonemark position tests (ua->oa, ue->oe)
                { in: "tuÃ ", out: "tÃ²a" }, // TL tuÃ  (live) -> POJ tÃ²a
                { in: "kuÃ©", out: "kÃ³e" }, // TL kuÃ© (rice pudding) -> POJ kÃ³e  
                { in: "suÃ­", out: "sÃºi" }, // TL suÃ­ (pretty) -> POJ sÃºi (no change, tone on u)
                { in: "uÃ¡", out: "Ã³a" }, // TL uÃ¡ (lean) -> POJ Ã³a

                // Tone 4 vs 8 Rules
                { in: "a4", out: "a4" },   // TL a4 (no stop)
                { in: "a8", out: "a8" },   // TL a8 (no stop)
                { in: "ah4", out: "ah" },  // TL ah4 (stop)
                { in: "ah8", out: "aÌh" },   // TL ah8 (stop)

                // Escape syntax tests
                { in: "ts\\[ts]ts", out: "chtsch" },  // Edge case: \[ts] preserved, bare ts converted

                // English False Positives (Escaped)
                { in: "\\[cats]", out: "cats" },
                { in: "Read a \\[book]", out: "Read a book" },
                { in: "\\[Google]", out: "Google" },
                { in: "\\[Blue] sky", out: "Blue sky" },
                { in: "\\[Singing]", out: "Singing" },
                { in: "\\[Wiki]", out: "Wiki" }
            ];

            tests.forEach(t => {
                const res = TLtiau_2_POJtiau(t.in);
                if (res !== t.out) {
                    console.error(`Test failed: ${t.in} -> expected ${t.out}, got ${res}`);
                } else {
                    console.log(`Test passed: ${t.in} -> ${res}`);
                }
            });
        }

    </script>
</body>

</html>